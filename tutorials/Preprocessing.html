
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Preprocessing the CCD images &#8212; TAO Tutorials  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3c32ad28" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/Preprocessing';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Concept of spectroscopy" href="SAO-Spectroscopic-Data-Reduction.html" />
    <link rel="prev" title="Spectroscopic Data Reduction" href="Spectroscopic_data_reduction.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TAO Tutorials</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">SNU TAO Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Preparation.html">Preparation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="PSF_photometry.html">PSF photometry of NGC 2210</a></li>
<li class="toctree-l1"><a class="reference internal" href="data/proj3/run_SExtractor.html">SExtractor Photometry of MACS 0717</a></li>
<li class="toctree-l1"><a class="reference internal" href="GALFIT-Surface_Photometry.html">Surface Photometry Using GALFIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spectroscopic_data_reduction.html">Spectroscopic Data Reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Preprocessing the CCD images</a></li>
<li class="toctree-l1"><a class="reference internal" href="SAO-Spectroscopic-Data-Reduction.html">Concept of spectroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Optical%20Spectroscopy.html">Specutils: An Astropy package for spectroscopy</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/hbahk/TAOTutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/Preprocessing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Preprocessing the CCD images</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="preprocessing-the-ccd-images">
<h1>Preprocessing the CCD images<a class="headerlink" href="#preprocessing-the-ccd-images" title="Link to this heading">#</a></h1>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Software</p></th>
<th class="head"><p>Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Python</p></td>
<td><p>3.12.2 64bit [Clang 14.0.6]</p></td>
</tr>
<tr class="row-odd"><td><p>IPython</p></td>
<td><p>8.20.0</p></td>
</tr>
<tr class="row-even"><td><p>OS</p></td>
<td><p>macOS 13.4.1 arm64 arm 64bit</p></td>
</tr>
<tr class="row-odd"><td><p>numpy</p></td>
<td><p>1.26.4</p></td>
</tr>
<tr class="row-even"><td><p>scipy</p></td>
<td><p>1.11.4</p></td>
</tr>
<tr class="row-odd"><td><p>matplotlib</p></td>
<td><p>3.8.0</p></td>
</tr>
<tr class="row-even"><td><p>astropy</p></td>
<td><p>5.3.4</p></td>
</tr>
<tr class="row-odd"><td><p>ccdproc</p></td>
<td><p>2.4.1</p></td>
</tr>
<tr class="row-even"><td><p>photutils</p></td>
<td><p>1.11.0</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ZScaleInterval</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">CCDData</span>
<span class="kn">import</span> <span class="nn">astroalign</span> <span class="k">as</span> <span class="nn">aa</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="kn">import</span> <span class="n">combine</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting locations</span>
<span class="n">DATADIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/reduc/2024-03-20&#39;</span><span class="p">)</span>
<span class="n">RAWDIR</span> <span class="o">=</span> <span class="n">DATADIR</span> <span class="o">/</span> <span class="s1">&#39;raw&#39;</span>
<span class="n">OUTDIR</span> <span class="o">=</span> <span class="n">DATADIR</span><span class="o">/</span> <span class="s1">&#39;reduced&#39;</span>

<span class="c1"># making output directory if it doesn&#39;t exist</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTDIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">OUTDIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_summary_table</span><span class="p">(</span><span class="n">rawdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="c1"># making a summary table</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rawdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.fit&#39;</span><span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># getting the filter information</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;FILTER&#39;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1"># - checking for the filter in the filename with regex, if not in header</span>
            <span class="n">mtch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[UBVRIgriz].fit$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">mtch_Ha</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Ha.fit$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mtch</span><span class="p">:</span>
                <span class="n">filt</span> <span class="o">=</span> <span class="n">mtch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">mtch_Ha</span><span class="p">:</span>
                <span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;Ha&#39;</span>
            
        <span class="c1"># getting the airmass X (Pickering 2002)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OBJCTALT&#39;</span><span class="p">])</span>
            <span class="n">X</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span> <span class="n">alt</span> <span class="o">+</span> <span class="mi">244</span><span class="o">/</span><span class="p">(</span><span class="mi">165</span> <span class="o">+</span> <span class="mi">47</span><span class="o">*</span><span class="n">alt</span><span class="o">**</span><span class="mf">1.1</span> <span class="p">))))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error in </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">],</span>
                        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OBJCTRA&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OBJCTDEC&#39;</span><span class="p">],</span>
                        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IMAGETYP&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">],</span>
                        <span class="n">X</span><span class="p">,</span> <span class="n">filt</span><span class="p">])</span>
        
    <span class="n">stab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;date-obs&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;imagetyp&#39;</span><span class="p">,</span> <span class="s1">&#39;exptime&#39;</span><span class="p">,</span> <span class="s1">&#39;airmass&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;U50&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;U50&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">stab</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># making the summary table</span>
<span class="n">summary_table</span> <span class="o">=</span> <span class="n">make_summary_table</span><span class="p">(</span><span class="n">RAWDIR</span><span class="p">)</span>
<span class="c1"># sorting the table by date</span>
<span class="n">summary_table</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;date-obs&#39;</span><span class="p">)</span>
<span class="c1"># showing the table</span>
<span class="n">summary_table</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">(</span><span class="n">display_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><i>Table length=60</i>
<table id="table5336842016-730444" class="table-striped table-bordered table-condensed">
<thead><tr><th>idx</th><th>filename</th><th>date-obs</th><th>object</th><th>ra</th><th>dec</th><th>imagetyp</th><th>exptime</th><th>airmass</th><th>filter</th></tr></thead>
<tr><td>0</td><td>skyflat-0001Ha.fit</td><td>2024-03-20T09:22:27</td><td>skyflat</td><td>07 43 57</td><td>+60 34 21</td><td>Flat Field</td><td>3.0</td><td>1.152217579019225</td><td>Ha</td></tr>
<tr><td>1</td><td>skyflat-0002Ha.fit</td><td>2024-03-20T09:22:42</td><td>skyflat</td><td>07 44 13</td><td>+60 34 21</td><td>Flat Field</td><td>3.0</td><td>1.1522164291076638</td><td>Ha</td></tr>
<tr><td>2</td><td>skyflat-0003Ha.fit</td><td>2024-03-20T09:22:57</td><td>skyflat</td><td>07 44 28</td><td>+60 34 22</td><td>Flat Field</td><td>3.0</td><td>1.152217579019225</td><td>Ha</td></tr>
<tr><td>3</td><td>skyflat-0004Ha.fit</td><td>2024-03-20T09:23:12</td><td>skyflat</td><td>07 44 43</td><td>+60 34 22</td><td>Flat Field</td><td>3.0</td><td>1.1522187289365808</td><td>Ha</td></tr>
<tr><td>4</td><td>skyflat-0005Ha.fit</td><td>2024-03-20T09:23:27</td><td>skyflat</td><td>07 44 58</td><td>+60 34 22</td><td>Flat Field</td><td>3.0</td><td>1.1522187289365808</td><td>Ha</td></tr>
<tr><td>5</td><td>skyflat-0006Ha.fit</td><td>2024-03-20T09:23:42</td><td>skyflat</td><td>07 45 13</td><td>+60 34 23</td><td>Flat Field</td><td>3.0</td><td>1.1522187289365808</td><td>Ha</td></tr>
<tr><td>6</td><td>skyflat-0007Ha.fit</td><td>2024-03-20T09:23:57</td><td>skyflat</td><td>07 45 28</td><td>+60 34 23</td><td>Flat Field</td><td>3.0</td><td>1.152217579019225</td><td>Ha</td></tr>
<tr><td>7</td><td>skyflat-0001i.fit</td><td>2024-03-20T09:48:06</td><td>skyflat</td><td>08 09 43</td><td>+60 35 08</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>i</td></tr>
<tr><td>8</td><td>skyflat-0002i.fit</td><td>2024-03-20T09:48:20</td><td>skyflat</td><td>08 09 56</td><td>+60 35 08</td><td>Flat Field</td><td>2.0</td><td>1.152219878859731</td><td>i</td></tr>
<tr><td>9</td><td>skyflat-0003i.fit</td><td>2024-03-20T09:48:34</td><td>skyflat</td><td>08 10 11</td><td>+60 35 09</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>i</td></tr>
<tr><td>10</td><td>skyflat-0004i.fit</td><td>2024-03-20T09:48:48</td><td>skyflat</td><td>08 10 25</td><td>+60 35 09</td><td>Flat Field</td><td>2.0</td><td>1.1522152792018971</td><td>i</td></tr>
<tr><td>11</td><td>skyflat-0005i.fit</td><td>2024-03-20T09:49:02</td><td>skyflat</td><td>08 10 39</td><td>+60 35 10</td><td>Flat Field</td><td>2.0</td><td>1.1522164291076638</td><td>i</td></tr>
<tr><td>12</td><td>skyflat-0006i.fit</td><td>2024-03-20T09:49:16</td><td>skyflat</td><td>08 10 53</td><td>+60 35 10</td><td>Flat Field</td><td>2.0</td><td>1.1522164291076638</td><td>i</td></tr>
<tr><td>13</td><td>skyflat-0007i.fit</td><td>2024-03-20T09:49:30</td><td>skyflat</td><td>08 11 07</td><td>+60 35 10</td><td>Flat Field</td><td>2.0</td><td>1.1522152792018971</td><td>i</td></tr>
<tr><td>14</td><td>skyflat-0001r.fit</td><td>2024-03-20T09:50:02</td><td>skyflat</td><td>08 11 39</td><td>+60 35 11</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>r</td></tr>
<tr><td>15</td><td>skyflat-0002r.fit</td><td>2024-03-20T09:50:16</td><td>skyflat</td><td>08 11 53</td><td>+60 35 12</td><td>Flat Field</td><td>2.0</td><td>1.1522152792018971</td><td>r</td></tr>
<tr><td>16</td><td>skyflat-0003r.fit</td><td>2024-03-20T09:50:30</td><td>skyflat</td><td>08 12 07</td><td>+60 35 12</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>r</td></tr>
<tr><td>17</td><td>skyflat-0004r.fit</td><td>2024-03-20T09:50:44</td><td>skyflat</td><td>08 12 21</td><td>+60 35 13</td><td>Flat Field</td><td>2.0</td><td>1.152217579019225</td><td>r</td></tr>
<tr><td>18</td><td>skyflat-0005r.fit</td><td>2024-03-20T09:50:58</td><td>skyflat</td><td>08 12 35</td><td>+60 35 13</td><td>Flat Field</td><td>2.0</td><td>1.152217579019225</td><td>r</td></tr>
<tr><td>19</td><td>skyflat-0006r.fit</td><td>2024-03-20T09:51:12</td><td>skyflat</td><td>08 12 49</td><td>+60 35 13</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>r</td></tr>
<tr><td>20</td><td>skyflat-0007r.fit</td><td>2024-03-20T09:51:26</td><td>skyflat</td><td>08 13 04</td><td>+60 35 14</td><td>Flat Field</td><td>2.0</td><td>1.1522221787234155</td><td>r</td></tr>
<tr><td>21</td><td>skyflat-0001g.fit</td><td>2024-03-20T09:55:37</td><td>skyflat</td><td>08 17 16</td><td>+60 35 21</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>g</td></tr>
<tr><td>22</td><td>skyflat-0002g.fit</td><td>2024-03-20T09:55:51</td><td>skyflat</td><td>08 17 30</td><td>+60 35 22</td><td>Flat Field</td><td>2.0</td><td>1.1522152792018971</td><td>g</td></tr>
<tr><td>23</td><td>skyflat-0003g.fit</td><td>2024-03-20T09:56:05</td><td>skyflat</td><td>08 17 44</td><td>+60 35 22</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>g</td></tr>
<tr><td>24</td><td>skyflat-0004g.fit</td><td>2024-03-20T09:56:19</td><td>skyflat</td><td>08 17 58</td><td>+60 35 22</td><td>Flat Field</td><td>2.0</td><td>1.152217579019225</td><td>g</td></tr>
<tr><td>25</td><td>skyflat-0005g.fit</td><td>2024-03-20T09:56:33</td><td>skyflat</td><td>08 18 13</td><td>+60 35 23</td><td>Flat Field</td><td>2.0</td><td>1.1522187289365808</td><td>g</td></tr>
<tr><td>26</td><td>skyflat-0006g.fit</td><td>2024-03-20T09:56:47</td><td>skyflat</td><td>08 18 26</td><td>+60 35 23</td><td>Flat Field</td><td>2.0</td><td>1.152219878859731</td><td>g</td></tr>
<tr><td>27</td><td>skyflat-0007g.fit</td><td>2024-03-20T09:57:01</td><td>skyflat</td><td>08 18 40</td><td>+60 35 24</td><td>Flat Field</td><td>2.0</td><td>1.1522164291076638</td><td>g</td></tr>
<tr><td>28</td><td>M101-0001g.fit</td><td>2024-03-20T13:46:31</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.3471224286680594</td><td>g</td></tr>
<tr><td>29</td><td>M101-0002g.fit</td><td>2024-03-20T13:49:43</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.3372890993380804</td><td>g</td></tr>
<tr><td>30</td><td>M101-0003g.fit</td><td>2024-03-20T13:52:55</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.3277368037391455</td><td>g</td></tr>
<tr><td>31</td><td>M101-0001r.fit</td><td>2024-03-20T13:56:06</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.3183926677509952</td><td>r</td></tr>
<tr><td>32</td><td>M101-0002r.fit</td><td>2024-03-20T13:59:18</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.3092440875166884</td><td>r</td></tr>
<tr><td>33</td><td>M101-0003r.fit</td><td>2024-03-20T14:02:29</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.300365998812042</td><td>r</td></tr>
<tr><td>34</td><td>M101-0001i.fit</td><td>2024-03-20T14:05:41</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.291625580691236</td><td>i</td></tr>
<tr><td>35</td><td>M101-0002i.fit</td><td>2024-03-20T14:08:52</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.2831247255886573</td><td>i</td></tr>
<tr><td>36</td><td>M101-0003i.fit</td><td>2024-03-20T14:12:04</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.2748610177362498</td><td>i</td></tr>
<tr><td>37</td><td>M101-0001Ha.fit</td><td>2024-03-20T14:15:18</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.2666825141876346</td><td>Ha</td></tr>
<tr><td>38</td><td>M101-0002Ha.fit</td><td>2024-03-20T14:18:29</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.2587544068516756</td><td>Ha</td></tr>
<tr><td>39</td><td>M101-0003Ha.fit</td><td>2024-03-20T14:21:41</td><td>M101</td><td>14 03 15</td><td>+54 20 40</td><td>Light Frame</td><td>180.0</td><td>1.2510514616626078</td><td>Ha</td></tr>
<tr><td>40</td><td>Calibration-0001bias.fit</td><td>2024-03-20T15:50:31</td><td>Calibration</td><td>14 14 26</td><td>+60 37 30</td><td>Bias Frame</td><td>0.0</td><td>1.1522302284288428</td><td>unknown</td></tr>
<tr><td>41</td><td>Calibration-0002bias.fit</td><td>2024-03-20T15:50:39</td><td>Calibration</td><td>14 14 27</td><td>+60 37 30</td><td>Bias Frame</td><td>0.0</td><td>1.1520991685626514</td><td>unknown</td></tr>
<tr><td>42</td><td>Calibration-0003bias.fit</td><td>2024-03-20T15:50:46</td><td>Calibration</td><td>14 14 35</td><td>+60 37 30</td><td>Bias Frame</td><td>0.0</td><td>1.1521129607926952</td><td>unknown</td></tr>
<tr><td>43</td><td>Calibration-0004bias.fit</td><td>2024-03-20T15:50:53</td><td>Calibration</td><td>14 14 42</td><td>+60 37 29</td><td>Bias Frame</td><td>0.0</td><td>1.1521083632900055</td><td>unknown</td></tr>
<tr><td>44</td><td>Calibration-0005bias.fit</td><td>2024-03-20T15:51:01</td><td>Calibration</td><td>14 14 49</td><td>+60 37 29</td><td>Bias Frame</td><td>0.0</td><td>1.1521072139288138</td><td>unknown</td></tr>
<tr><td>45</td><td>Calibration-0001dk2.fit</td><td>2024-03-20T15:51:08</td><td>Calibration</td><td>12 12 25</td><td>+07 34 55</td><td>Dark Frame</td><td>2.0</td><td>1.15419822429397</td><td>unknown</td></tr>
<tr><td>46</td><td>Calibration-0002dk2.fit</td><td>2024-03-20T15:51:17</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>2.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>47</td><td>Calibration-0003dk2.fit</td><td>2024-03-20T15:51:26</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>2.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>48</td><td>Calibration-0004dk2.fit</td><td>2024-03-20T15:51:35</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>2.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>49</td><td>Calibration-0005dk2.fit</td><td>2024-03-20T15:51:43</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>2.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>50</td><td>Calibration-0001dk3.fit</td><td>2024-03-20T15:51:52</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>3.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>51</td><td>Calibration-0002dk3.fit</td><td>2024-03-20T15:52:01</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>3.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>52</td><td>Calibration-0003dk3.fit</td><td>2024-03-20T15:52:10</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>3.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>53</td><td>Calibration-0004dk3.fit</td><td>2024-03-20T15:52:19</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>3.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>54</td><td>Calibration-0005dk3.fit</td><td>2024-03-20T15:52:28</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>3.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>55</td><td>Calibration-0001dk180.fit</td><td>2024-03-20T16:13:09</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>180.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>56</td><td>Calibration-0002dk180.fit</td><td>2024-03-20T16:16:15</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>180.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>57</td><td>Calibration-0003dk180.fit</td><td>2024-03-20T16:19:21</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>180.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>58</td><td>Calibration-0004dk180.fit</td><td>2024-03-20T16:22:27</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>180.0</td><td>-1.0</td><td>unknown</td></tr>
<tr><td>59</td><td>Calibration-0005dk180.fit</td><td>2024-03-20T16:25:33</td><td>Calibration</td><td>23 58 46</td><td>-00 08 05</td><td>Dark Frame</td><td>180.0</td><td>-1.0</td><td>unknown</td></tr>
</table><style>table.dataTable {clear: both; width: auto !important; margin: 0 !important;}
.dataTables_info, .dataTables_length, .dataTables_filter, .dataTables_paginate{
display: inline-block; margin-right: 1em; }
.paginate_button { margin-right: 5px; }
</style>
<script>

var astropy_sort_num = function(a, b) {
    var a_num = parseFloat(a);
    var b_num = parseFloat(b);

    if (isNaN(a_num) && isNaN(b_num))
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    else if (!isNaN(a_num) && !isNaN(b_num))
        return ((a_num < b_num) ? -1 : ((a_num > b_num) ? 1 : 0));
    else
        return isNaN(a_num) ? -1 : 1;
}

require.config({paths: {
    datatables: 'https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min'
}});
require(["datatables"], function(){
    console.log("$('#table5336842016-730444').dataTable()");
    
jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "optionalnum-asc": astropy_sort_num,
    "optionalnum-desc": function (a,b) { return -astropy_sort_num(a, b); }
});

    $('#table5336842016-730444').dataTable({
        order: [],
        pageLength: 5,
        lengthMenu: [[5, 10, 25, 50, 100, 500, 1000, -1], [5, 10, 25, 50, 100, 500, 1000, 'All']],
        pagingType: "full_numbers",
        columnDefs: [{targets: [0, 7, 8], type: "optionalnum"}]
    });
});
</script>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># table for each type of frame</span>
<span class="n">bias_table</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">[</span><span class="n">summary_table</span><span class="p">[</span><span class="s1">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bias Frame&#39;</span><span class="p">]</span>
<span class="n">dark_table</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">[</span><span class="n">summary_table</span><span class="p">[</span><span class="s1">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Dark Frame&#39;</span><span class="p">]</span>
<span class="n">flat_table</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">[</span><span class="n">summary_table</span><span class="p">[</span><span class="s1">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Flat Field&#39;</span><span class="p">]</span>
<span class="n">sci_table</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">[</span><span class="n">summary_table</span><span class="p">[</span><span class="s1">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Light Frame&#39;</span><span class="p">]</span>

<span class="c1"># counting the number of frames</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of bias frames: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bias_table</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of dark frames: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_table</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of flat frames: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_table</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of flat frames with g-band: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_table</span><span class="p">[</span><span class="n">flat_table</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;g&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of science frames: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_table</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of science frames with g-band: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_table</span><span class="p">[</span><span class="n">sci_table</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;g&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of bias frames: 5
Number of dark frames: 15
Number of flat frames: 28
Number of flat frames with g-band: 7
Number of science frames: 12
Number of science frames with g-band: 3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># test reading of science frame</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">sci_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">isci</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sci</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">isci</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>   <span class="c1"># 2D image array of pixel counts</span>
<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">isci</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="c1"># image header information</span>

<span class="c1"># simple visulization of the image</span>
<span class="n">ibias</span><span class="p">,</span> <span class="n">idark</span><span class="p">,</span> <span class="n">iflat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">bias_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">ibias</span><span class="p">])</span>
<span class="n">dark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">dark_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">idark</span><span class="p">])</span>
<span class="n">flat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">flat_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">iflat</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for displaying in zscale</span>
<span class="n">interval</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>

<span class="c1"># plotting the images</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bias&#39;</span><span class="p">,</span> <span class="s1">&#39;Dark&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Flat (</span><span class="si">{</span><span class="n">flat_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="n">iflat</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;Science (</span><span class="si">{</span><span class="n">sci_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="n">isci</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">bias</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">sci</span><span class="p">]):</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/4950c6ecdd11fadb0618a732e7d7fbceb66c730d013ed46d39edfa5c11bb4ba5.png"><img alt="../_images/4950c6ecdd11fadb0618a732e7d7fbceb66c730d013ed46d39edfa5c11bb4ba5.png" src="../_images/4950c6ecdd11fadb0618a732e7d7fbceb66c730d013ed46d39edfa5c11bb4ba5.png" style="width: 774px; height: 583px;" /></a>
</div>
</div>
<div class="math notranslate nohighlight">
\[\sigma_{\rm ADU} = \frac{\rm Readout\ noise}{\rm Gain}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get readout noise from bias frames</span>
<span class="n">bias_imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bias_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]])</span>

<span class="c1"># bring gain</span>
<span class="n">gain</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">bias_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;EGAIN&#39;</span><span class="p">]</span> <span class="c1"># e-/ADU</span>

<span class="c1"># calculate the readout noise</span>
<span class="n">bias_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bias_imgs</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">sig_adu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># ADU</span>
<span class="n">rdnoise</span> <span class="o">=</span> <span class="n">sig_adu</span> <span class="o">*</span> <span class="n">gain</span> <span class="c1"># e-</span>

<span class="c1"># plot the bias histogram</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bias values&#39;</span><span class="p">)</span>
<span class="c1"># Gaussian model for comparison</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">bias_level</span><span class="p">)</span> <span class="o">/</span> <span class="n">sig_adu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;N($b$, $\sigma_{\rm ADU}^2$)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value (ADU)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="mi">530</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of bias frames&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x174bbadb0&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/11e6e21dbe24d5940fe1a149dcb6d5ab2722b20dd854d8e82325149b71eee029.png"><img alt="../_images/11e6e21dbe24d5940fe1a149dcb6d5ab2722b20dd854d8e82325149b71eee029.png" src="../_images/11e6e21dbe24d5940fe1a149dcb6d5ab2722b20dd854d8e82325149b71eee029.png" style="width: 561px; height: 402px;" /></a>
</div>
</div>
<p><a class="reference external" href="https://www.astropy.org/ccd-reduction-and-photometry-guide/v/dev/notebooks/01-06-Image-combination.html">CCD Data Reduction Guide - 1.5. Image combination</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a master bias combining all bias frames</span>
<span class="c1"># median combine the bias frames</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">medi_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken by median combine: </span><span class="si">{</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

<span class="c1"># combining bias frames with sigma clipping</span>
<span class="c1"># - stacking the empty array with bias frames (using CCDData)</span>
<span class="n">bias_stack</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bias_table</span><span class="p">)):</span>
    <span class="n">bias_data</span><span class="p">,</span> <span class="n">bias_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">bias_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">CCDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bias_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">bias_hdr</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>
    <span class="n">bias_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
<span class="c1"># - combining</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">clip_combine</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">bias_stack</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken by sigma clipping combine: </span><span class="si">{</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">medi_combine</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">medi_combine</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">clip_combine</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Single bias frame&#39;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s1">&#39;Clipped average&#39;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span>
             <span class="sa">f</span><span class="s2">&quot;Mean bias level: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="o">+</span>
             <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RMS error: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span>
             <span class="sa">f</span><span class="s2">&quot;Mean bias level: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">medi_combine</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="o">+</span>
             <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RMS error: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span>
             <span class="sa">f</span><span class="s2">&quot;Mean bias level: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clip_combine</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="o">+</span>
             <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RMS error: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
<span class="c1"># bias histogram</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">bias_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Single bias frame&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">medi_combine</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">clip_combine</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clipped average&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="mi">530</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value (ADU)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of bias frames&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># write the master bias to a fits file</span>
<span class="n">mbias_file</span> <span class="o">=</span> <span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;Mbias.fits&#39;</span>
<span class="n">bias_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">bias_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bias_hdr</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdnoise</span> <span class="c1"># record the readout noise</span>
<span class="n">bias_hdr</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Master bias frame&#39;</span>
<span class="n">bias_hdr</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Created on </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">mbias_file</span><span class="p">,</span> <span class="n">clip_combine</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bias_hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">del</span> <span class="n">bias_imgs</span><span class="p">,</span> <span class="n">bias_stack</span><span class="p">,</span> <span class="n">medi_combine</span><span class="p">,</span> <span class="n">clip_combine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time taken by median combine: 1.17 s
Time taken by sigma clipping combine: 8.33 s
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/29ed8ea738fa2e16484f32ee1b4d2a4ef8f3eee883f73d2375a20fe0997c3453.png"><img alt="../_images/29ed8ea738fa2e16484f32ee1b4d2a4ef8f3eee883f73d2375a20fe0997c3453.png" src="../_images/29ed8ea738fa2e16484f32ee1b4d2a4ef8f3eee883f73d2375a20fe0997c3453.png" style="width: 1284px; height: 326px;" /></a>
<a class="reference internal image-reference" href="../_images/39f1fd87334bd13693fe44b1ce6b31b72f9ef75e46dc867f24c231ceb021f00b.png"><img alt="../_images/39f1fd87334bd13693fe44b1ce6b31b72f9ef75e46dc867f24c231ceb021f00b.png" src="../_images/39f1fd87334bd13693fe44b1ce6b31b72f9ef75e46dc867f24c231ceb021f00b.png" style="width: 561px; height: 402px;" /></a>
</div>
</div>
<p>The level of the noises is slightly reduced by combining the images.
In this case, we only combined five bias frames. However, for more serious data
reduction, combining typically more than 10 bias frames is recommended to
reduce the noise of the bias level further.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># - Note that the dark frames might have different exposure times.</span>
<span class="k">def</span> <span class="nf">make_mdark</span><span class="p">(</span><span class="n">dark_list</span><span class="p">,</span> <span class="n">mbias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># - checking the basic info</span>
    <span class="c1"># - Please check the consistancy in observation dates and exposure times.</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_list</span><span class="p">)):</span>
                <span class="n">dark_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">dark_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dark frame </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPTIME&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">keys</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dark_hdr</span><span class="p">[</span><span class="n">keys</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">mbias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mbias_data</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mbias_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mbias</span><span class="p">)</span>
        
    <span class="c1"># - stacking dark frames</span>
    <span class="n">dark_stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_list</span><span class="p">)):</span>
        <span class="n">dark_data</span><span class="p">,</span> <span class="n">dark_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dark_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dark_bn</span> <span class="o">=</span> <span class="p">(</span><span class="n">dark_data</span> <span class="o">-</span> <span class="n">mbias_data</span><span class="p">)</span><span class="c1"># / dark_hdr[&#39;EXPTIME&#39;]</span>
        <span class="n">dark</span> <span class="o">=</span> <span class="n">CCDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dark_bn</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">dark_hdr</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>    
        <span class="n">dark_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dark</span><span class="p">)</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> dark frames took </span><span class="si">{</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
        
    <span class="c1"># - combine with sigma clipping</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">mdark</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">dark_stack</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dark_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> dark frames took </span><span class="si">{</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
    
    <span class="c1"># - correcting the negative values</span>
    <span class="n">mdark</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mdark</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c1"># - save the master dark as fits file</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dark_hdr</span><span class="p">[</span><span class="s1">&#39;NFRAMES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dark_list</span><span class="p">)</span>  <span class="c1"># recording # of dark frames combined</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MDark</span><span class="si">{</span><span class="n">dark_hdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">.fits&quot;</span><span class="p">,</span>
                 <span class="n">mdark</span><span class="p">,</span> <span class="n">dark_hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing the master dark took </span><span class="si">{</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># - visualization of the master dark</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">mdark</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mdark</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="s2">&quot;Master Dark</span><span class="se">\n</span><span class="s2">(sc combined, bias-subtracted)&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Exposure time: </span><span class="si">{</span><span class="n">dark_hdr</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean dark level: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mdark</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (count)&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">mdark</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create master darks for each exposure time</span>
<span class="n">mbias_file</span> <span class="o">=</span> <span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;Mbias.fits&#39;</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">dark_table</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;exptime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span> <span class="c1"># group by exposure time</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span> 
    <span class="n">_</span> <span class="o">=</span> <span class="n">make_mdark</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">mbias_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading 5 dark frames took 1.61 sec
Combining 5 dark frames took 10.46 sec
Writing the master dark took 0.15 sec

Reading 5 dark frames took 0.98 sec
Combining 5 dark frames took 8.49 sec
Writing the master dark took 0.15 sec

Reading 5 dark frames took 1.01 sec
Combining 5 dark frames took 9.59 sec
Writing the master dark took 0.13 sec
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/3cd47eaf299ca8aaeffa5211e6b4d4775993f5b493491f4e4290d6a6f7c2ed5a.png"><img alt="../_images/3cd47eaf299ca8aaeffa5211e6b4d4775993f5b493491f4e4290d6a6f7c2ed5a.png" src="../_images/3cd47eaf299ca8aaeffa5211e6b4d4775993f5b493491f4e4290d6a6f7c2ed5a.png" style="width: 371px; height: 284px;" /></a>
<a class="reference internal image-reference" href="../_images/76efec1c99abef42462f44d68868e9c93c483e5291e3aefe51df1a2be5d202a0.png"><img alt="../_images/76efec1c99abef42462f44d68868e9c93c483e5291e3aefe51df1a2be5d202a0.png" src="../_images/76efec1c99abef42462f44d68868e9c93c483e5291e3aefe51df1a2be5d202a0.png" style="width: 371px; height: 284px;" /></a>
<a class="reference internal image-reference" href="../_images/090fd4f00c2da21593389dfa696ac87ca7c3b84d85d0d28f48848a4c47053bff.png"><img alt="../_images/090fd4f00c2da21593389dfa696ac87ca7c3b84d85d0d28f48848a4c47053bff.png" src="../_images/090fd4f00c2da21593389dfa696ac87ca7c3b84d85d0d28f48848a4c47053bff.png" style="width: 371px; height: 284px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># - combining flat frames for each filter</span>
<span class="k">def</span> <span class="nf">make_mflat</span><span class="p">(</span><span class="n">flat_list</span><span class="p">,</span> <span class="n">mbias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mdark</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># - checking the basic info : check dates, exposure times, and filters.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)):</span>
            <span class="n">flat_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">flat_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flat frame </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">keys</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flat_hdr</span><span class="p">[</span><span class="n">keys</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">mbias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mbias_data</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mbias_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mbias</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">mdark</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mdark_data</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdark_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mdark</span><span class="p">)</span>
    
    <span class="c1"># - stacking flat frames</span>
    <span class="n">nflat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span>
    <span class="n">flat_stack</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">nflat</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">ncols</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nrows</span><span class="p">))</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)):</span>
        <span class="n">flat_data</span><span class="p">,</span> <span class="n">flat_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">flat_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
        <span class="n">filter_now</span> <span class="o">=</span> <span class="n">flat_hdr</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>     <span class="c1"># specifying current filter</span>
        <span class="c1"># - bias and dark subtraction</span>
        <span class="n">flat_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">flat_data</span> <span class="o">-</span> <span class="n">mbias_data</span> <span class="o">-</span> <span class="n">mdark_data</span><span class="p">)</span>
        <span class="c1"># - flat scaling (with relative sensitivity=1 at the maximum)</span>
        <span class="n">flat_bdn</span> <span class="o">=</span> <span class="n">flat_bd</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flat_bd</span><span class="p">)</span>
        <span class="n">flat_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flat_bdn</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="n">ncols</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="k">ncols</span>]
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">flat_bdn</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flat_bdn</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                      <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                           <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s2">-band (</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Flat range: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">flat_bdn</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">flat_bdn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nflat</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            
    <span class="c1"># - sigma clipping</span>
    <span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">mad_std</span>
    <span class="n">mflat</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">flat_stack</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">sigma_clip_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">sigma_clip_dev_func</span><span class="o">=</span><span class="n">mad_std</span><span class="p">)</span>
    
    <span class="c1"># - save the master flat as fits file</span>
    <span class="c1"># - Caveat: this assumes that the flat frames are taken with the same</span>
    <span class="c1">#           filter, and they have the same exposure time. If not, you may</span>
    <span class="c1">#           need to modify the filename.</span>
    <span class="n">flat_hdr</span><span class="p">[</span><span class="s1">&#39;NFRAMES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MFlat</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s2">.fits&quot;</span><span class="p">,</span> <span class="n">mflat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                 <span class="n">header</span><span class="o">=</span><span class="n">flat_hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># - visualization of the master flat</span>
        <span class="c1"># fig, ax = plt.subplots(1, 1, figsize=(5,3))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">ncols</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">mflat</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mflat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Master Flat (</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="s2">&quot;(sc combined, bias/dark-subtracted)&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mf">11.0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Flat sensitivity range: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">mflat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">mflat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">mflat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create master flats for each filter</span>
<span class="c1"># flat frames for the same filter have the same exposure time</span>
<span class="n">mbias_file</span> <span class="o">=</span> <span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;Mbias.fits&#39;</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">flat_table</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span> <span class="c1"># group by filter</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span>
    <span class="n">mdark_file</span> <span class="o">=</span> <span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MDark</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">.fits&quot;</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">make_mflat</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">mbias_file</span><span class="p">,</span> <span class="n">mdark_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/f441d97cb60c29cc26da95358bcd9f6b090340b8a9b60ff3e7dbffff67aeb35e.png"><img alt="../_images/f441d97cb60c29cc26da95358bcd9f6b090340b8a9b60ff3e7dbffff67aeb35e.png" src="../_images/f441d97cb60c29cc26da95358bcd9f6b090340b8a9b60ff3e7dbffff67aeb35e.png" style="width: 1574px; height: 590px;" /></a>
<a class="reference internal image-reference" href="../_images/f9dc7327b689e6c260bb1dae073f453eda21f8e73e1dfc0a64712441f5d5bc89.png"><img alt="../_images/f9dc7327b689e6c260bb1dae073f453eda21f8e73e1dfc0a64712441f5d5bc89.png" src="../_images/f9dc7327b689e6c260bb1dae073f453eda21f8e73e1dfc0a64712441f5d5bc89.png" style="width: 1574px; height: 590px;" /></a>
<a class="reference internal image-reference" href="../_images/f193c66679a8063b742eb1a97a796b735120e6e9579d1f9debba95a817b853ac.png"><img alt="../_images/f193c66679a8063b742eb1a97a796b735120e6e9579d1f9debba95a817b853ac.png" src="../_images/f193c66679a8063b742eb1a97a796b735120e6e9579d1f9debba95a817b853ac.png" style="width: 1574px; height: 590px;" /></a>
<a class="reference internal image-reference" href="../_images/184e0b42876c445dc49f2c89b0f1a57966cc99d52370f088540983f510f0579e.png"><img alt="../_images/184e0b42876c445dc49f2c89b0f1a57966cc99d52370f088540983f510f0579e.png" src="../_images/184e0b42876c445dc49f2c89b0f1a57966cc99d52370f088540983f510f0579e.png" style="width: 1574px; height: 590px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preproc</span><span class="p">(</span><span class="n">sci_list</span><span class="p">,</span> <span class="n">mbias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mdark</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mflat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rdnoise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_list</span><span class="p">)):</span>
        <span class="c1"># bias subtraction, dark subtraction, and flat fielding</span>
        <span class="n">sci_path</span> <span class="o">=</span> <span class="n">sci_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sci_data</span><span class="p">,</span> <span class="n">sci_hdr</span>  <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">sci_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># &#39;int&#39; type may cause error when calculating</span>
        <span class="n">sci_data0</span> <span class="o">=</span> <span class="n">sci_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        
        <span class="n">mbias_data</span> <span class="o">=</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">mbias</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mbias</span><span class="p">)</span>
        <span class="n">mdark_data</span> <span class="o">=</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">mdark</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mdark</span><span class="p">)</span>
        <span class="n">mflat_data</span> <span class="o">=</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">mflat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">mflat</span><span class="p">)</span>
        
        <span class="n">sci_data</span> <span class="o">=</span> <span class="n">sci_data0</span> <span class="o">-</span> <span class="n">mbias_data</span>    <span class="c1"># Bias subtraction</span>
        <span class="n">sci_data</span> <span class="o">-=</span> <span class="n">mdark_data</span>   <span class="c1"># Dark subtraction</span>
        <span class="n">sci_data</span> <span class="o">/=</span> <span class="n">mflat_data</span>    <span class="c1"># Flat fielding</span>
        
        <span class="c1"># visual inspection</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Raw Data&quot;</span><span class="p">,</span> <span class="s2">&quot;Preprocessed Data&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">sci_data0</span><span class="p">,</span> <span class="n">sci_data</span><span class="p">]):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                          <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">sci_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> 
                            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># recording preprocessing history</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S (GMT%z)&quot;</span><span class="p">)</span>
        <span class="n">sci_hdr</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdnoise</span>
        <span class="n">sci_hdr</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Preprocessed at &#39;</span> <span class="o">+</span> <span class="n">now</span>
            
        <span class="c1"># saving preprocessed image to a fits file</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="n">sci_path</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;s&#39;</span><span class="p">),</span> <span class="n">sci_data</span><span class="p">,</span> <span class="n">sci_hdr</span><span class="p">,</span>
                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done: </span><span class="si">{</span><span class="n">sci_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sci_table</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span>
    <span class="n">filter_now</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mdark_file</span> <span class="o">=</span> <span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MDark</span><span class="si">{</span><span class="n">exptime</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">.fits&quot;</span>
    <span class="n">mflat_file</span> <span class="o">=</span> <span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MFlat</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s2">.fits&quot;</span>
    <span class="n">rdnoise</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">mbias_file</span><span class="p">)[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]</span>
    <span class="n">preproc</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">mbias_file</span><span class="p">,</span> <span class="n">mdark_file</span><span class="p">,</span> <span class="n">mflat_file</span><span class="p">,</span> <span class="n">rdnoise</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done: M101-0001Ha.fit
Done: M101-0002Ha.fit
Done: M101-0003Ha.fit
Done: M101-0001g.fit
Done: M101-0002g.fit
Done: M101-0003g.fit
Done: M101-0001i.fit
Done: M101-0002i.fit
Done: M101-0003i.fit
Done: M101-0001r.fit
Done: M101-0002r.fit
Done: M101-0003r.fit
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/dc933c8d4372f43fab791a890e21c3fce6a34859401b309e60e8bd33f9677d63.png"><img alt="../_images/dc933c8d4372f43fab791a890e21c3fce6a34859401b309e60e8bd33f9677d63.png" src="../_images/dc933c8d4372f43fab791a890e21c3fce6a34859401b309e60e8bd33f9677d63.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/d7177202d9c9028a0c29594de3ce21ebb4e2d25ee57934ab54be95f180f615ce.png"><img alt="../_images/d7177202d9c9028a0c29594de3ce21ebb4e2d25ee57934ab54be95f180f615ce.png" src="../_images/d7177202d9c9028a0c29594de3ce21ebb4e2d25ee57934ab54be95f180f615ce.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/a89ff9f192d317e0ecc3825bd82a6017450f2e50693a532f5683acef5c21755a.png"><img alt="../_images/a89ff9f192d317e0ecc3825bd82a6017450f2e50693a532f5683acef5c21755a.png" src="../_images/a89ff9f192d317e0ecc3825bd82a6017450f2e50693a532f5683acef5c21755a.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/4d2433eda400055f18812640299530d0f886e5b1382d832ab60de38d908323dd.png"><img alt="../_images/4d2433eda400055f18812640299530d0f886e5b1382d832ab60de38d908323dd.png" src="../_images/4d2433eda400055f18812640299530d0f886e5b1382d832ab60de38d908323dd.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/26cf843f34460299dcae579ed60ca2cf33ea2bfba33d22cf1e73d2bd4658885b.png"><img alt="../_images/26cf843f34460299dcae579ed60ca2cf33ea2bfba33d22cf1e73d2bd4658885b.png" src="../_images/26cf843f34460299dcae579ed60ca2cf33ea2bfba33d22cf1e73d2bd4658885b.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/9877f173b57636321eecfc332e75a638604aebfcec6fa7ba464d4d03802b99e0.png"><img alt="../_images/9877f173b57636321eecfc332e75a638604aebfcec6fa7ba464d4d03802b99e0.png" src="../_images/9877f173b57636321eecfc332e75a638604aebfcec6fa7ba464d4d03802b99e0.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/7e6ee1c3fe7a827687da0470d8b214a7901500b9a03d9ac9bb6e8ea0f7069e41.png"><img alt="../_images/7e6ee1c3fe7a827687da0470d8b214a7901500b9a03d9ac9bb6e8ea0f7069e41.png" src="../_images/7e6ee1c3fe7a827687da0470d8b214a7901500b9a03d9ac9bb6e8ea0f7069e41.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/c637f7b5856a8873c1e38f4ba674a4bd8629f9f62609e343096dcd0b8e706a9b.png"><img alt="../_images/c637f7b5856a8873c1e38f4ba674a4bd8629f9f62609e343096dcd0b8e706a9b.png" src="../_images/c637f7b5856a8873c1e38f4ba674a4bd8629f9f62609e343096dcd0b8e706a9b.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/57b855ffbc16e16fa237bfa29a5d1abe38685748187e00e8750c4d3e29df8829.png"><img alt="../_images/57b855ffbc16e16fa237bfa29a5d1abe38685748187e00e8750c4d3e29df8829.png" src="../_images/57b855ffbc16e16fa237bfa29a5d1abe38685748187e00e8750c4d3e29df8829.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/7a8aff27d659e2712ddeb2b41a85bfdfaa3e0f1ac06422136146c48f3ce6e81c.png"><img alt="../_images/7a8aff27d659e2712ddeb2b41a85bfdfaa3e0f1ac06422136146c48f3ce6e81c.png" src="../_images/7a8aff27d659e2712ddeb2b41a85bfdfaa3e0f1ac06422136146c48f3ce6e81c.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/0fbb3b31b0a5c6c663af5e86e5d1ad9af479ded6ec7ea982b5fe4e6362006124.png"><img alt="../_images/0fbb3b31b0a5c6c663af5e86e5d1ad9af479ded6ec7ea982b5fe4e6362006124.png" src="../_images/0fbb3b31b0a5c6c663af5e86e5d1ad9af479ded6ec7ea982b5fe4e6362006124.png" style="width: 984px; height: 374px;" /></a>
<a class="reference internal image-reference" href="../_images/26c3ce847f854bcb8860b9f9e089f1788b76dcfaaf060154acb457ebe0903a2a.png"><img alt="../_images/26c3ce847f854bcb8860b9f9e089f1788b76dcfaaf060154acb457ebe0903a2a.png" src="../_images/26c3ce847f854bcb8860b9f9e089f1788b76dcfaaf060154acb457ebe0903a2a.png" style="width: 984px; height: 374px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">align_single_frame</span><span class="p">(</span><span class="n">img_fname</span><span class="p">,</span> <span class="n">ccd_ref</span><span class="p">):</span>
    <span class="c1"># alingning a single frame with respect to the reference frame</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">img_fname</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>
    <span class="n">dat_aligned</span><span class="p">,</span> <span class="n">footprint</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">ccd_ref</span><span class="p">,</span>
                                         <span class="n">max_control_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                         <span class="n">detection_sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                         <span class="n">propagate_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ccd_aligned</span> <span class="o">=</span> <span class="n">CCDData</span><span class="p">(</span><span class="n">dat_aligned</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ccd_aligned</span>

<span class="k">def</span> <span class="nf">align_frames</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mi">1277</span><span class="p">,</span> <span class="mi">1437</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6160</span><span class="p">],</span>
                 <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># reference image: frame 0</span>
    <span class="n">id_ref</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dat_ref</span><span class="p">,</span> <span class="n">hdr_ref</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">img_list</span><span class="p">[</span><span class="n">id_ref</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ccd_ref</span> <span class="o">=</span> <span class="n">CCDData</span><span class="p">(</span><span class="n">dat_ref</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>

    <span class="c1"># Aligning other images with respect to the reference image</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Started aligning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> images ---&quot;</span><span class="p">)</span>
        
    <span class="n">aligned_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">id_ref</span><span class="p">):</span>
            <span class="n">ccd_aligned</span> <span class="o">=</span> <span class="n">ccd_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ccd_aligned</span> <span class="o">=</span> <span class="n">align_single_frame</span><span class="p">(</span><span class="n">img_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccd_ref</span><span class="p">)</span>
        <span class="n">aligned_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccd_aligned</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- </span><span class="si">{</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sec were taken for aligning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> images ---&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plot_alignment_check</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="n">suptitle</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">aligned_list</span>

<span class="k">def</span> <span class="nf">plot_alignment_check</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mi">1277</span><span class="p">,</span> <span class="mi">1437</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6160</span><span class="p">],</span> <span class="n">suptitle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aligned_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CCDData</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">aligned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">aligned_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">trim</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">window</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">window</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">window</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">trim</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">trim</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">trim</span><span class="p">),</span> <span class="n">trim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">yc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">suptitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># testing the alignment of the g-band science frames</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">sci_table</span><span class="p">[</span><span class="n">sci_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;g&#39;</span><span class="p">]</span>
<span class="n">sci_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">s&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span>
<span class="n">sci_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sci_list</span><span class="p">]</span>

<span class="c1"># checking the alignment of the science frames</span>
<span class="n">plot_alignment_check</span><span class="p">(</span><span class="n">sci_data</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;Before alignment&#39;</span><span class="p">)</span>

<span class="c1"># aligning the science frames</span>
<span class="n">sci_aligned</span> <span class="o">=</span> <span class="n">align_frames</span><span class="p">(</span><span class="n">sci_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">window</span><span class="o">=</span><span class="p">[</span><span class="mi">1277</span><span class="p">,</span> <span class="mi">1437</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6160</span><span class="p">],</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;After alignment&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Started aligning 3 images ---
--- 6.5767 sec were taken for aligning 3 images ---
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/2f4fda570cbbf11c17713376404488138f168ebff64d66711f78a0504b7b51ad.png"><img alt="../_images/2f4fda570cbbf11c17713376404488138f168ebff64d66711f78a0504b7b51ad.png" src="../_images/2f4fda570cbbf11c17713376404488138f168ebff64d66711f78a0504b7b51ad.png" style="width: 762px; height: 294px;" /></a>
<a class="reference internal image-reference" href="../_images/2462f5826cda4e0002ff3cf1ee76f839861a74517d21adeae398d94e1bda177a.png"><img alt="../_images/2462f5826cda4e0002ff3cf1ee76f839861a74517d21adeae398d94e1bda177a.png" src="../_images/2462f5826cda4e0002ff3cf1ee76f839861a74517d21adeae398d94e1bda177a.png" style="width: 762px; height: 294px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># align and combine the science frames</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sci_table</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
    <span class="n">filter_now</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sci_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">s&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span> <span class="c1"># preprocessed sci frames</span>
    <span class="c1"># aligning the science frames</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aligning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sci_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> science frames (</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s2">-band)&quot;</span><span class="p">)</span>
    <span class="n">sci_aligned</span> <span class="o">=</span> <span class="n">align_frames</span><span class="p">(</span><span class="n">sci_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># combining the aligned frames</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">sci_aligned</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="c1"># saving the combined science frame</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">sci_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">sci_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sci_hdr</span><span class="p">[</span><span class="s1">&#39;NFRAMES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sci_list</span><span class="p">)</span>
    <span class="n">sci_hdr</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Aligned and combined&#39;</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;M</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filter_now</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span> <span class="n">combined</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                 <span class="n">sci_hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Aligning 3 science frames (Ha-band)
--- Started aligning 3 images ---
--- 7.5915 sec were taken for aligning 3 images ---
Aligning 3 science frames (g-band)
--- Started aligning 3 images ---
--- 6.8045 sec were taken for aligning 3 images ---
Aligning 3 science frames (i-band)
--- Started aligning 3 images ---
--- 7.1318 sec were taken for aligning 3 images ---
Aligning 3 science frames (r-band)
--- Started aligning 3 images ---
--- 7.0729 sec were taken for aligning 3 images ---
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sdss_rgb</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">rgbscales</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span> <span class="c1">#1.0,</span>
                 <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">),</span>
                 <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span>
                 <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span>
                 <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.4</span><span class="p">),</span> <span class="c1">#0.3</span>
                 <span class="p">}</span>
    <span class="k">if</span> <span class="n">scales</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rgbscales</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>

    <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
        <span class="n">plane</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">rgbscales</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">I</span> <span class="o">+</span> <span class="n">img</span>
    <span class="n">I</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        
    <span class="n">fI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">I</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">+=</span> <span class="p">(</span><span class="n">I</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
    <span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
        <span class="n">plane</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">rgbscales</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[:,:,</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">fI</span> <span class="o">/</span> <span class="n">I</span>
        
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">background_substraction</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">SigmaClip</span>
    <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span>
    <span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">circular_footprint</span>
    <span class="kn">import</span> <span class="nn">sep</span>
    <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">)</span>
    <span class="n">segment_img</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">footprint</span> <span class="o">=</span> <span class="n">circular_footprint</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">segment_img</span><span class="o">.</span><span class="n">make_source_mask</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="n">footprint</span><span class="p">)</span>
    <span class="c1"># mask = SegmentationImage.make_source_mask(img, nsigma=2, npixels=1, dilate_size=3)</span>
    <span class="n">bkg_sep</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(),</span> 
                             <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">bh</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">fw</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">bkgsub_sep</span> <span class="o">=</span> <span class="n">img</span> <span class="o">-</span> <span class="n">bkg_sep</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="n">data2plot</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original data&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">bkg_sep</span><span class="o">.</span><span class="n">back</span><span class="p">(),</span>   <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bkg (filt=</span><span class="si">{</span><span class="n">filt</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, box=</span><span class="si">{</span><span class="n">box</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">bkgsub_sep</span><span class="p">,</span>       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;bkg subtracted&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">),</span>
            <span class="c1"># dict(ax=axs[1, 1], arr=bkg_sep.background_mesh,   title=&quot;bkg mesh&quot;),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">bkg_sep</span><span class="o">.</span><span class="n">rms</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;10 * bkg RMS&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">data2plot</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;arr&#39;</span><span class="p">])</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
            <span class="c1"># cb.ax.set_xticklabels([f&#39;{x:.3f}&#39; for x in cb.get_ticks()])#, rotation=45)</span>
            <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">bkgsub_sep</span>


<span class="k">def</span> <span class="nf">plot_background_estimation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">data2plot</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original data&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">bkg</span><span class="p">,</span>      <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bkg (filt=</span><span class="si">{</span><span class="n">filt</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, box=</span><span class="si">{</span><span class="n">box</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">img</span><span class="o">-</span><span class="n">bkg</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;bkg subtracted&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">data2plot</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;arr&#39;</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
        <span class="c1"># cb.ax.set_xticklabels([f&#39;{x:.3f}&#39; for x in cb.get_ticks()])#, rotation=45)</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">zscale_imshow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gimg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;MM101_g.fits&#39;</span><span class="p">)</span>
<span class="n">rimg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;MM101_r.fits&#39;</span><span class="p">)</span>
<span class="n">iimg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;MM101_i.fits&#39;</span><span class="p">)</span>

<span class="c1">#downscale</span>
<span class="n">nsample</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">downscale_local_mean</span>
<span class="n">gimg</span> <span class="o">=</span> <span class="n">downscale_local_mean</span><span class="p">(</span><span class="n">gimg</span><span class="p">,</span> <span class="p">(</span><span class="n">nsample</span><span class="p">,</span> <span class="n">nsample</span><span class="p">))</span>
<span class="n">rimg</span> <span class="o">=</span> <span class="n">downscale_local_mean</span><span class="p">(</span><span class="n">rimg</span><span class="p">,</span> <span class="p">(</span><span class="n">nsample</span><span class="p">,</span> <span class="n">nsample</span><span class="p">))</span>
<span class="n">iimg</span> <span class="o">=</span> <span class="n">downscale_local_mean</span><span class="p">(</span><span class="n">iimg</span><span class="p">,</span> <span class="p">(</span><span class="n">nsample</span><span class="p">,</span> <span class="n">nsample</span><span class="p">))</span>


<span class="n">grbox</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">/</span> <span class="n">nsample</span>
<span class="n">ibox</span> <span class="o">=</span> <span class="mi">600</span> <span class="o">/</span> <span class="n">nsample</span>
<span class="n">filtsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="n">imgcenter</span> <span class="o">=</span> <span class="p">[</span><span class="n">gimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">gimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
<span class="n">mask_radius</span> <span class="o">=</span> <span class="mi">120</span> <span class="o">/</span> <span class="n">nsample</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gimg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">gimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">gimg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">mask</span><span class="p">[(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">imgcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">imgcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">mask_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">MedianBackground</span>
<span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">MedianBackground</span><span class="p">()</span>
<span class="n">gbkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">gimg</span><span class="p">,</span> <span class="p">(</span><span class="n">grbox</span><span class="p">,</span> <span class="n">grbox</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filtsize</span><span class="p">,</span>
                    <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">)</span>
<span class="n">rbkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">rimg</span><span class="p">,</span> <span class="p">(</span><span class="n">grbox</span><span class="p">,</span> <span class="n">grbox</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filtsize</span><span class="p">,</span>
                    <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">)</span>
<span class="n">ibkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">iimg</span><span class="p">,</span> <span class="p">(</span><span class="n">ibox</span><span class="p">,</span> <span class="n">ibox</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filtsize</span><span class="p">,</span>
                    <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">)</span>

<span class="n">gimg_bkgsub</span> <span class="o">=</span> <span class="n">gimg</span> <span class="o">-</span> <span class="n">gbkg</span><span class="o">.</span><span class="n">background</span>  <span class="c1"># subtract the background</span>
<span class="n">rimg_bkgsub</span> <span class="o">=</span> <span class="n">rimg</span> <span class="o">-</span> <span class="n">rbkg</span><span class="o">.</span><span class="n">background</span>
<span class="n">iimg_bkgsub</span> <span class="o">=</span> <span class="n">iimg</span> <span class="o">-</span> <span class="n">ibkg</span><span class="o">.</span><span class="n">background</span>


<span class="n">plot_background_estimation</span><span class="p">(</span><span class="n">gimg</span><span class="p">,</span> <span class="n">gbkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">filtsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grbox</span><span class="p">)</span>
<span class="n">plot_background_estimation</span><span class="p">(</span><span class="n">rimg</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">filtsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grbox</span><span class="p">)</span>
<span class="n">plot_background_estimation</span><span class="p">(</span><span class="n">iimg</span><span class="p">,</span> <span class="n">ibkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">filtsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ibox</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/6049f47e839bf7e72501b4b103b26be0b0646234e00c48f82b2c874ce6b65ad3.png"><img alt="../_images/6049f47e839bf7e72501b4b103b26be0b0646234e00c48f82b2c874ce6b65ad3.png" src="../_images/6049f47e839bf7e72501b4b103b26be0b0646234e00c48f82b2c874ce6b65ad3.png" style="width: 1183px; height: 378px;" /></a>
<a class="reference internal image-reference" href="../_images/bb38f2bd4bca80157d487fe3375ce397eed45b956a100c490dc08708a4eff68d.png"><img alt="../_images/bb38f2bd4bca80157d487fe3375ce397eed45b956a100c490dc08708a4eff68d.png" src="../_images/bb38f2bd4bca80157d487fe3375ce397eed45b956a100c490dc08708a4eff68d.png" style="width: 1183px; height: 381px;" /></a>
<a class="reference internal image-reference" href="../_images/af81ceb02b92cbb8a9f39d066af5edaca10e5e9afbac9cd0a3d617683077407b.png"><img alt="../_images/af81ceb02b92cbb8a9f39d066af5edaca10e5e9afbac9cd0a3d617683077407b.png" src="../_images/af81ceb02b92cbb8a9f39d066af5edaca10e5e9afbac9cd0a3d617683077407b.png" style="width: 1182px; height: 381px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rgb</span> <span class="o">=</span> <span class="n">sdss_rgb</span><span class="p">([</span><span class="n">gimg_bkgsub</span><span class="p">,</span> <span class="n">rimg_bkgsub</span><span class="p">,</span> <span class="n">iimg_bkgsub</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">],</span>
               <span class="n">scales</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)},</span> <span class="n">m</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mf">0.003</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x13f895fd0&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/60102c03f86ad887afefa89a60f802b86d9cc91e36c808d42ec09d9276a03b2a.png"><img alt="../_images/60102c03f86ad887afefa89a60f802b86d9cc91e36c808d42ec09d9276a03b2a.png" src="../_images/60102c03f86ad887afefa89a60f802b86d9cc91e36c808d42ec09d9276a03b2a.png" style="width: 902px; height: 662px;" /></a>
</div>
</div>
<p><img alt="" src="../_images/ds9_color_img_M101_lower_resol.jpeg" /></p>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flat_table_g</span> <span class="o">=</span> <span class="n">flat_table</span><span class="p">[</span><span class="n">flat_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;g&#39;</span><span class="p">]</span>
<span class="n">flat1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">flat_table_g</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># first flat frame</span>
<span class="n">flat2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">RAWDIR</span> <span class="o">/</span> <span class="n">flat_table_g</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># last flat frame</span>
<span class="n">mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;Mbias.fits&#39;</span><span class="p">)</span>
<span class="n">mdark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;MDark2.fits&#39;</span><span class="p">)</span>
<span class="n">flat1</span> <span class="o">=</span> <span class="n">flat1</span> <span class="o">-</span> <span class="n">mbias</span> <span class="o">-</span> <span class="n">mdark</span>
<span class="n">flat2</span> <span class="o">=</span> <span class="n">flat2</span> <span class="o">-</span> <span class="n">mbias</span> <span class="o">-</span> <span class="n">mdark</span>
<span class="n">mflat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">OUTDIR</span> <span class="o">/</span> <span class="s1">&#39;MFlatg.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flat1/flat2&quot;</span><span class="p">,</span> <span class="s2">&quot;flat1/Mflat&quot;</span><span class="p">,</span> <span class="s2">&quot;flat2/Mflat&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">flat1</span><span class="o">/</span><span class="n">flat2</span><span class="p">,</span> <span class="n">flat1</span><span class="o">/</span><span class="n">mflat</span><span class="p">,</span> <span class="n">flat2</span><span class="o">/</span><span class="n">mflat</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/703d277c5cbeb4861499a550fa2575a89905a30435ae8f8f8d7e8e42b3d61b62.png"><img alt="../_images/703d277c5cbeb4861499a550fa2575a89905a30435ae8f8f8d7e8e42b3d61b62.png" src="../_images/703d277c5cbeb4861499a550fa2575a89905a30435ae8f8f8d7e8e42b3d61b62.png" style="width: 1182px; height: 276px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">group</span> <span class="o">=</span> <span class="n">flat_table_g</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">RAWDIR</span><span class="o">/</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]]</span>
<span class="n">mdark_file</span> <span class="o">=</span> <span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;MDark</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">.fits&quot;</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">make_mflat</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">mbias_file</span><span class="p">,</span> <span class="n">mdark_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: splitting each image into 2 chunks to limit memory usage to 16000000000.0 bytes. [ccdproc.combiner]
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/9a7d51046349ef24ed5543e99b5a7778d1633d69a8f79741c35aea922b5a85bb.png"><img alt="../_images/9a7d51046349ef24ed5543e99b5a7778d1633d69a8f79741c35aea922b5a85bb.png" src="../_images/9a7d51046349ef24ed5543e99b5a7778d1633d69a8f79741c35aea922b5a85bb.png" style="width: 1574px; height: 590px;" /></a>
</div>
</div>
<p>This notebook is largely based on following references.</p>
<ul class="simple">
<li><p>References</p>
<ul>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2000hccd.book.....H/abstract">Handbook of CCD Astronomy, Steve B. Howell, Cambridge University Press, 2006</a></p></li>
<li><p><a class="github reference external" href="https://github.com/hbahk/SNU_AO22-1/blob/master/tutorial/notebooks/AO22-03-Preprocessing.ipynb">hbahk/SNU_AO22-1</a></p></li>
<li><p><a class="github reference external" href="https://github.com/joungh93/TAO_2022A/blob/main/Preprocess.ipynb">joungh93/TAO_2022A</a></p></li>
<li><p><a class="github reference external" href="https://github.com/ysbach/SNU_AOclass/blob/master/Notebooks/07-Cosmic_Ray_Rejection.ipynb">ysbach/SNU_AOclass</a></p></li>
</ul>
</li>
<li><p>Useful manuals for preprocessing and more (based on IRAF)</p>
<ul>
<li><p><a class="reference external" href="http://astro.snu.ac.kr/~hhwang/Manuals.html">http://astro.snu.ac.kr/~hhwang/Manuals.html</a></p></li>
</ul>
</li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Spectroscopic_data_reduction.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Spectroscopic Data Reduction</p>
      </div>
    </a>
    <a class="right-next"
       href="SAO-Spectroscopic-Data-Reduction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Concept of spectroscopy</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Hyeonguk Bahk
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Hyeonguk Bahk.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>