
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PSF photometry of NGC 2210 &#8212; TAO Tutorials  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3c32ad28" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/PSF_photometry';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SExtractor Photometry of MACS 0717" href="data/proj3/run_SExtractor.html" />
    <link rel="prev" title="Preparation" href="Preparation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TAO Tutorials</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">SNU TAO Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Preparation.html">Preparation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">PSF photometry of NGC 2210</a></li>
<li class="toctree-l1"><a class="reference internal" href="data/proj3/run_SExtractor.html">SExtractor Photometry of MACS 0717</a></li>
<li class="toctree-l1"><a class="reference internal" href="GALFIT-Surface_Photometry.html">Surface Photometry Using GALFIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spectroscopic_data_reduction.html">Spectroscopic Data Reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Preprocessing.html">Preprocessing the CCD images</a></li>
<li class="toctree-l1"><a class="reference internal" href="SAO-Spectroscopic-Data-Reduction.html">Concept of spectroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Optical%20Spectroscopy.html">Specutils: An Astropy package for spectroscopy</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/hbahk/TAOTutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/PSF_photometry.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>PSF photometry of NGC 2210</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-lists">Reading lists</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-photometry-an-overview">PSF photometry - an overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#caveat">Caveat</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reading-and-background-subtraction">1. Data Reading and Background Subtraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-of-stars-for-the-psf-estimation">2. Selection of Stars for the PSF Estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-effective-psf">3. Derive Effective PSF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#substar-subtract-adjacent-stars-and-reconstruct-epsf">SUBSTAR - subtract adjacent stars and reconstruct EPSF</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-photometry-with-the-epsf">4. PSF Photometry with the EPSF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterations-over-all-bands">5. Iterations Over All Bands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#match-the-results-of-each-band">6. Match the Results of Each Band</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#color-magnitude-diagram">7. Color-Magnitude Diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-with-the-references">8. Comparison with the References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-readings">Further Readings</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="psf-photometry-of-ngc-2210">
<h1>PSF photometry of NGC 2210<a class="headerlink" href="#psf-photometry-of-ngc-2210" title="Link to this heading">#</a></h1>
<blockquote>
<div><p><br />
<em>“Astronomers never seem to want to do anything easy.”</em></p>
<div style="text-align: right"> - Peter B. Stetson (1987) </div>
</div></blockquote>
<p>In this tutorial we will conduct some basic PSF photometry on a DESI Legacy
Survey image of the globular cluster NGC 2210. We will use the <code class="docutils literal notranslate"><span class="pre">photutils.psf</span></code>
module to perform PSF photometry on the image. Below image shows each frame of
<span class="math notranslate nohighlight">\(grz\)</span> band and their false-color image of the NGC 2210. The aim for this
tutorial is to get <span class="math notranslate nohighlight">\(grz\)</span> magnitudes and colors of stars inside this field, by
PSF photometry, and to get their color-magnitude diagram for the investigation
of the properties of NGC 2210.</p>
<p><img alt="" src="../_images/NGC2210.grz.png" /></p>
<hr class="docutils" />
<section id="reading-lists">
<h2>Reading lists<a class="headerlink" href="#reading-lists" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>PSF photometry</p>
<ul>
<li><p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/index.html">Photutils Documentation</a></p></li>
<li><p><a class="reference external" href="https://github.com/hbahk/SNU_AO22-1/blob/master/tutorial/notebooks/AO22-06-PSF-Photometry.ipynb">Astronomical Observations for SNU Undergraduates - PSF Photometry</a></p></li>
<li><p><a class="reference external" href="http://astro.snu.ac.kr/~hhwang/Photometry_using_IRAF.pdf">(Korean) SNU Manual - Photometry Using IRAF</a></p></li>
<li><p><a class="reference external" href="https://spacetelescope.github.io/jdat_notebooks/notebooks/psf_photometry/NIRCam_PSF_Photometry_Example.html">NIRCam PSF Photometry</a></p></li>
</ul>
</li>
</ul>
<p>For the general understanding of the processes regarding to the astronomical
photometric measurement, one can consult following references.</p>
<ul class="simple">
<li><p>General Photometry</p>
<ul>
<li><p><a class="reference external" href="https://www.ucolick.org/~bolte/AY257/s_n.pdf">Bolte, 2015, Signal-to-Noise in Optical Astronomy</a></p></li>
<li><p><a class="reference external" href="https://wise2.ipac.caltech.edu/staff/fmasci/ApPhotUncert.pdf">Masci, 2008, Flux-Uncertainty from Aperture Photometry</a></p></li>
<li><p><a class="reference external" href="https://www.cambridge.org/highereducation/books/to-measure-the-sky/92996E5636A4EFD6562DF94AE947C908#overview">Chromey, 2016, To Measure the Sky</a></p></li>
</ul>
</li>
</ul>
<p>If you are not familiar with handling the astronomical data, the following
tutorials may be helpful. Especially, the SNU_AOclass repository deveoloped by
<a class="reference external" href="https://github.com/ysBach">Yoonsoo P. Bach</a>, which is the TA lecture note for
astronomical observation class for SNU undergraduate students, will provide
the most of the things you need, if you concern your lack of backgrounds.</p>
<ul class="simple">
<li><p>Self-consistent general data analysis for astronomical observation</p>
<ul>
<li><p><a class="reference external" href="https://ysbach.github.io/SNU_AOpython/index.html">SNU AO Class Python Notes</a> (by Yoonsoo Bach)</p></li>
</ul>
</li>
<li><p>Useful tutorials</p>
<ul>
<li><p><a class="reference external" href="https://github.com/hbahk/SNU_AO22-1/blob/master/tutorial/notebooks/AO22-01-Basics.ipynb">(Korean) Basics for the data analysis with Python</a></p></li>
<li><p><a class="reference external" href="https://github.com/hbahk/SNU_AO22-1/blob/master/tutorial/notebooks/AO22-02-Query.ipynb">Query from astronomical databases</a></p></li>
</ul>
</li>
<li><p>CCD Data Handling</p>
<ul>
<li><p><a class="reference external" href="https://github.com/hbahk/SNU_AO22-1/blob/master/tutorial/notebooks/AO22-03-Preprocessing.ipynb">Preprocessing</a></p></li>
<li><p><a class="reference external" href="https://www.astropy.org/ccd-reduction-and-photometry-guide/v/dev/index.html">CCD Data Reduction Guide</a> (by Matthew Craig)</p></li>
</ul>
</li>
</ul>
</section>
<hr class="docutils" />
<section id="psf-photometry-an-overview">
<h2>PSF photometry - an overview<a class="headerlink" href="#psf-photometry-an-overview" title="Link to this heading">#</a></h2>
<p>PSF photometry is the process of measuring the brightness of the stars by
numerically fitting their light profile across the CCD image frame. For the
stars isolated in the frame, the aperture photometry suffices to measure their
flux and uncertainty, without any heavy computations of optimization process,
and without the possibility of failure in the model to represent the stellar
profile inside the frame. As Stetson (1987) mentioned, the aperture photmetry
is “the most easiest and potentially most accurate method for obtaining
instrumental photometry for bright, uncrowded stars, because it involves simple
counting of detected photons.” (Stetson, 1987)
However, for stars inside the crowded field, such as open clusters, globular
clusters, and Magellanic Clouds, it is impossible to measure the brightness of
blended stars by just summing their photon counts inside some apertures. Thus
we have to adopt numerical fitting technique to model the brightness profile of
the blended stars simultaneously, under the assumption of the linearity of the
detector, and extract the total flux of a star from the model.</p>
<p>PSF photometry is processed in the following steps:</p>
<ol class="arabic simple">
<li><p>Subtract background light from the image</p></li>
<li><p>Find stars inside the frame</p></li>
<li><p>Define a model for stellar light profile (point spread function; PSF)</p></li>
<li><p>Group the blended stars which have to be simultaneously fitted</p></li>
<li><p>Fit the light profiles of the star groups</p></li>
<li><p>Examine the residual (data - model) image to decide whether or not to …</p>
<ul class="simple">
<li><p>change the parameters for finding stars</p></li>
<li><p>reconstruct the PSF model</p></li>
<li><p>resize fitting window</p></li>
<li><p>iterate additional extraction in the residual</p></li>
<li><p>etc.</p></li>
</ul>
</li>
</ol>
<p><img alt="" src="../_images/psf_phot_overview.png" /></p>
<p>This is the outline of this tutorial regarding to the above steps.</p>
<ol class="arabic simple">
<li><p>We will subtract the background of each frame using <code class="docutils literal notranslate"><span class="pre">sep</span></code> package, which is
developed to replicate Source Extractor (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1996A%26AS..117..393B/abstract">Bertin, 1996</a>). Here we use <code class="docutils literal notranslate"><span class="pre">sep.Background</span></code> to
subtract the background.</p></li>
<li><p>We will first find stars with simple method <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code> from
<code class="docutils literal notranslate"><span class="pre">photutils.detection</span></code>. This simple
selection of stars will provide the stars for modeling PSF. For better
modeling of PSF, one should carefully pick the bright isolated stars,
but here we just adopt some simple selection criteria to pick the stars,
expecting that the adjacent stars will be eventually averaged out.</p></li>
<li><p>With the stars we picked, we derive the effective PSF (EPSF), using
<code class="docutils literal notranslate"><span class="pre">EPSFBuilder</span></code> from <code class="docutils literal notranslate"><span class="pre">photutils.psf</span></code>. We use <code class="docutils literal notranslate"><span class="pre">photutils.psf.extract_stars</span></code> to
make <code class="docutils literal notranslate"><span class="pre">EPSFStars</span></code> object out of the table of stars we obtained by <code class="docutils literal notranslate"><span class="pre">find_peaks</span></code>,
then feed this object to <code class="docutils literal notranslate"><span class="pre">EPSFBuilder</span></code> to get the EPSF model. For better
model, we can subtract the adjacent stars in the window of <code class="docutils literal notranslate"><span class="pre">EPSFStars</span></code> by
fit them using the EPSF model, and rederive the EPSF from the ‘cleaned’
<code class="docutils literal notranslate"><span class="pre">EPSFStars</span></code>.</p></li>
<li><p>+5. <code class="docutils literal notranslate"><span class="pre">BasicPSFPhotometry</span></code> from <code class="docutils literal notranslate"><span class="pre">photutils.psf</span></code> will subtract background,
find stars, group them, and fit the stellar groups to conduct PSF photometry.
What we have to do is to select the background estimator (<code class="docutils literal notranslate"><span class="pre">MMMBackground</span></code>,
which is the same with the one in DAOPHOT), star finder (<code class="docutils literal notranslate"><span class="pre">DAOStarFinder</span></code>;
in here we input the FWHM measured from aperture photometry of stars found
by <code class="docutils literal notranslate"><span class="pre">find_peak</span></code>, to better performance for finding stars), fitter (<code class="docutils literal notranslate"><span class="pre">LevMarLSQFitter</span></code>), etc.</p></li>
<li><p>From <code class="docutils literal notranslate"><span class="pre">BasicPSFPhotometry</span></code> we can also obtain the residual image. In this
image we can examine the goodness of fit, and identify some failures of the
model (Stetson 1987):</p>
<ul class="simple">
<li><p>images of stars which were in the frame but were not recognized by the
star finder, perhaps due to having been blended with brighter companions</p></li>
<li><p>stars whose images contained defective pixels</p></li>
<li><p>images of galaxies which are almost but not quite, stellar</p></li>
<li><p>other similar departures from a perfect fit may be recognized and flagged</p></li>
</ul>
</li>
<li><p>We will iterate 1-6. over all bands (<span class="math notranslate nohighlight">\(grz\)</span>) to get PSF photometry in
different bands.</p></li>
<li><p>We match the stars with PSF photometry in each band. The match will be done
by their positions. Here we just used the pixel coordinates, since the image
we are dealing with is the cutout image from Legacy Survey so the images are
aligned already. However, in more general case this is often not the case,
so the match by celestial coordinates using WCS information should be better,
otherwise you need to align the images first.</p></li>
<li><p>We will obtain colors of the matched stars and draw color-magnitude diagram
of them, which are in the field of the NGC 2210.</p></li>
<li><p>In order to compare our PSF photometry with other results, we will use the
photometry from the Legacy Survey catalog and the homoegeous photometric
catalog provided by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2019MNRAS.485.3042S/abstract">Stetson et al. (2019)</a>. To compare with the result of the latter,
we will convert the DECam (the telescope used for DESI Legacy Survey) <span class="math notranslate nohighlight">\(gr\)</span>
filter system to Johnson-Cousins <span class="math notranslate nohighlight">\(BV\)</span> system.</p></li>
</ol>
</section>
<section id="caveat">
<h2>Caveat<a class="headerlink" href="#caveat" title="Link to this heading">#</a></h2>
<p>The DESI Legacy Survey image we adopt here is already standard-calibrated with
each pixel in the unit of nanomaggy. In reality, you need to convert the
instrumental flux into standard flux, with the instrumental flux of standard
stars.</p>
<p>This tutorial is constructed with the limit of time, so this may not  be
complete and self-consistent, so if you have a question for this notebook ask
me in person or send me an email to <a class="reference external" href="mailto:bahkhyeonguk&#37;&#52;&#48;gmail&#46;com">bahkhyeonguk<span>&#64;</span>gmail<span>&#46;</span>com</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<table class="table">
<thead>
<tr class="row-odd"><th class="head text-center"><p>No.</p></th>
<th class="head text-center"><p>Software</p></th>
<th class="head text-center"><p>Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0</p></td>
<td class="text-center"><p>Python</p></td>
<td class="text-center"><p>3.12.2 64bit [Clang 14.0.6 ]</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>IPython</p></td>
<td class="text-center"><p>8.20.0</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>2</p></td>
<td class="text-center"><p>OS</p></td>
<td class="text-center"><p>macOS 13.4.1 arm64 arm 64bit</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>3</p></td>
<td class="text-center"><p>numpy</p></td>
<td class="text-center"><p>1.26.4</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>4</p></td>
<td class="text-center"><p>matplotlib</p></td>
<td class="text-center"><p>3.8.0</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>5</p></td>
<td class="text-center"><p>astropy</p></td>
<td class="text-center"><p>5.3.4</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>6</p></td>
<td class="text-center"><p>photutils</p></td>
<td class="text-center"><p>1.11.0</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">patches</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">ctime</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">hstack</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">gaussian_fwhm_to_sigma</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">NDData</span><span class="p">,</span> <span class="n">CCDData</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyWarning</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span><span class="p">,</span> <span class="n">ZScaleInterval</span>
<span class="kn">from</span> <span class="nn">photutils.aperture</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">ApertureStats</span>
<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span><span class="p">,</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="n">extract_stars</span><span class="p">,</span> <span class="n">EPSFBuilder</span>
<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="n">DAOPhotPSFPhotometry</span><span class="p">,</span> <span class="n">BasicPSFPhotometry</span>
<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="n">DAOGroup</span>
<span class="kn">from</span> <span class="nn">photutils.psf.epsf_stars</span> <span class="kn">import</span> <span class="n">EPSFStars</span>
<span class="kn">from</span> <span class="nn">photutils.psf.utils</span> <span class="kn">import</span> <span class="n">_extract_psf_fitting_names</span>
<span class="kn">from</span> <span class="nn">photutils.psf.utils</span> <span class="kn">import</span> <span class="n">get_grouped_psf_model</span>
<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">IRAFStarFinder</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span>
<span class="c1"># from photutils.segmentation import make_source_mask</span>
<span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">SegmentationImage</span>
<span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span>
<span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">circular_footprint</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span> <span class="nn">sep</span>

<span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">7</span><span class="p">)</span>
<span class="c1"># plt.rcParams[&quot;font.family&quot;] = &#39;Times New Roman&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;text.usetex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># plt.rcParams[&quot;mathtext.fontset&quot;] = &#39;cm&#39;</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AstropyWarning</span><span class="p">)</span>

<span class="n">WD</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">DATADIR</span> <span class="o">=</span> <span class="n">WD</span><span class="o">/</span><span class="s1">&#39;data&#39;</span><span class="o">/</span><span class="s1">&#39;proj2&#39;</span>
<span class="n">OUTDIR</span> <span class="o">=</span> <span class="n">DATADIR</span><span class="o">/</span><span class="s1">&#39;out&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTDIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">OUTDIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-reading-and-background-subtraction">
<h2>1. Data Reading and Background Subtraction<a class="headerlink" href="#data-reading-and-background-subtraction" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">zscale_imshow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vmin</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">vmax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
        <span class="n">_vmin</span><span class="p">,</span> <span class="n">_vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">_vmin</span>
        <span class="k">if</span> <span class="n">vmax</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">_vmax</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">im</span>

<span class="k">def</span> <span class="nf">read_sci_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newbyteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bkgsubtract</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ccd_raw</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;nmgy&#39;</span><span class="p">)</span> <span class="c1"># be careful about the unit!</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;nmgy&#39;</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span>
    
    <span class="n">data_mean</span><span class="p">,</span> <span class="n">data_med</span><span class="p">,</span> <span class="n">data_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">data_mean</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">data_std</span> 
    <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_med</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">data_med</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newbyteorder</span><span class="p">:</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
        
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bkgsubtract</span><span class="p">:</span>
        <span class="n">bkgsubs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">bkgsub</span> <span class="o">=</span> <span class="n">background_substraction</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">bkgsubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkgsub</span><span class="p">)</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkgsubs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
            <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            
            <span class="n">band</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BAND</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">$-band&#39;</span><span class="p">,</span>
                         <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                         <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">ccd_raw</span>

<span class="k">def</span> <span class="nf">background_substraction</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">)</span>
    <span class="n">segment_img</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">footprint</span> <span class="o">=</span> <span class="n">circular_footprint</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">segment_img</span><span class="o">.</span><span class="n">make_source_mask</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="n">footprint</span><span class="p">)</span>
    <span class="c1"># mask = SegmentationImage.make_source_mask(img, nsigma=2, npixels=1, dilate_size=3)</span>
    <span class="n">bkg_sep</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(),</span> 
                             <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">bh</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">fw</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">bkgsub_sep</span> <span class="o">=</span> <span class="n">img</span> <span class="o">-</span> <span class="n">bkg_sep</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="n">data2plot</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original data&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">bkg_sep</span><span class="o">.</span><span class="n">back</span><span class="p">(),</span>   <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bkg (filt=</span><span class="si">{</span><span class="n">filt</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, box=</span><span class="si">{</span><span class="n">box</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">bkgsub_sep</span><span class="p">,</span>       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;bkg subtracted&quot;</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Mask&quot;</span><span class="p">),</span>
            <span class="c1"># dict(ax=axs[1, 1], arr=bkg_sep.background_mesh,   title=&quot;bkg mesh&quot;),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">bkg_sep</span><span class="o">.</span><span class="n">rms</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;10 * bkg RMS&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">data2plot</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;arr&#39;</span><span class="p">])</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
            <span class="c1"># cb.ax.set_xticklabels([f&#39;{x:.3f}&#39; for x in cb.get_ticks()])#, rotation=45)</span>
            <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">bkgsub_sep</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ccd</span><span class="p">,</span> <span class="n">ccd_raw</span> <span class="o">=</span> <span class="n">read_sci_data</span><span class="p">(</span><span class="n">DATADIR</span><span class="o">/</span><span class="s1">&#39;NGC2210.grz.fits&#39;</span><span class="p">,</span> <span class="n">bkgsubtract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/bb13bac535fe445e3abffb6fecd3685a3c4cdb45a84e2b749584b0a0e9e23046.png"><img alt="../_images/bb13bac535fe445e3abffb6fecd3685a3c4cdb45a84e2b749584b0a0e9e23046.png" class="align-center" src="../_images/bb13bac535fe445e3abffb6fecd3685a3c4cdb45a84e2b749584b0a0e9e23046.png" style="width: 984px; height: 775px;" />
</a>
<a class="reference internal image-reference" href="../_images/2205cbf0939069b78e89edb76c32305e47fe74d3355f0e4fc709eb3af8aa8e28.png"><img alt="../_images/2205cbf0939069b78e89edb76c32305e47fe74d3355f0e4fc709eb3af8aa8e28.png" class="align-center" src="../_images/2205cbf0939069b78e89edb76c32305e47fe74d3355f0e4fc709eb3af8aa8e28.png" style="width: 980px; height: 775px;" />
</a>
<a class="reference internal image-reference" href="../_images/399d97b2438993c88159a60acbe770e5c1f0c6dab50e1fe45d71db57f88692bb.png"><img alt="../_images/399d97b2438993c88159a60acbe770e5c1f0c6dab50e1fe45d71db57f88692bb.png" class="align-center" src="../_images/399d97b2438993c88159a60acbe770e5c1f0c6dab50e1fe45d71db57f88692bb.png" style="width: 983px; height: 775px;" />
</a>
<a class="reference internal image-reference" href="../_images/f3f3e2c15b95c4b172150ce7280e413eab132554af53cfa5b985804a64eecd50.png"><img alt="../_images/f3f3e2c15b95c4b172150ce7280e413eab132554af53cfa5b985804a64eecd50.png" class="align-center" src="../_images/f3f3e2c15b95c4b172150ce7280e413eab132554af53cfa5b985804a64eecd50.png" style="width: 1475px; height: 398px;" />
</a>
</div>
</div>
</section>
<section id="selection-of-stars-for-the-psf-estimation">
<h2>2. Selection of Stars for the PSF Estimation<a class="headerlink" href="#selection-of-stars-for-the-psf-estimation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">band</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">thres</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">std</span>

<span class="n">find_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="c1"># find_mask[250:650, 250:650] = True</span>
<span class="c1"># ll, hh = 0, 200</span>
<span class="n">ll</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">650</span>
<span class="n">find_mask</span><span class="p">[</span><span class="n">ll</span><span class="p">:</span><span class="n">hh</span><span class="p">,</span> <span class="n">ll</span><span class="p">:</span><span class="n">hh</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">peaks_tbl</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">find_mask</span><span class="p">)</span>
<span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.8g</span><span class="s1">&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of peaks:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks_tbl</span><span class="p">))</span>
<span class="n">peaks_tbl</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">()</span>

<span class="c1"># select stars within the cutout of specified size, which must be odd</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">21</span> <span class="c1"># typically ~4*FWHM. user should consider the PSF size for selecting this value</span>
<span class="n">hsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;x_peak&#39;</span><span class="p">]</span>  
<span class="n">y</span> <span class="o">=</span> <span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;y_peak&#39;</span><span class="p">]</span>  
<span class="n">bound</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">))</span> <span class="o">&amp;</span>
         <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">)))</span>
<span class="n">bright</span> <span class="o">=</span> <span class="p">(</span><span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">)</span>

<span class="n">bbmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bound</span> <span class="o">&amp;</span> <span class="n">bright</span><span class="p">)</span>
<span class="n">bx</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">bbmask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">bbmask</span><span class="p">]</span>

<span class="n">isolated</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bx</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">by</span><span class="o">-</span><span class="n">yi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">)]</span>

<span class="n">mask_stars</span> <span class="o">=</span> <span class="n">isolated</span>
<span class="c1"># mask_stars = np.ones_like(bx, dtype=bool)</span>

<span class="n">stars_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
<span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="n">mask_stars</span><span class="p">]</span>  
<span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">by</span><span class="p">[</span><span class="n">mask_stars</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of stars picked:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars_tbl</span><span class="p">))</span>
<span class="n">stars_tbl</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">()</span>

<span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># plot the locations of our selected stars</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;.r&#39;</span><span class="p">)</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ll</span><span class="p">,</span><span class="n">ll</span><span class="p">),</span> <span class="n">hh</span><span class="o">-</span><span class="n">ll</span><span class="p">,</span> <span class="n">hh</span><span class="o">-</span><span class="n">ll</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                         <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>number of peaks: 3781
number of stars picked: 107
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.patches.Rectangle at 0x176215400&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/0e05203c8ac74f7a562f03171418dafa9bfc8a1ac63aa213ace96c82a811b23f.png"><img alt="../_images/0e05203c8ac74f7a562f03171418dafa9bfc8a1ac63aa213ace96c82a811b23f.png" class="align-center" src="../_images/0e05203c8ac74f7a562f03171418dafa9bfc8a1ac63aa213ace96c82a811b23f.png" style="width: 839px; height: 819px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract cutouts of our selected stars</span>
<span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_tbl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># plot cutouts</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ncols</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                       <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">):</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>

<span class="c1"># derive fwhm from aperture statistics</span>
<span class="n">cap</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">center_flat</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
<span class="n">apstat</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>

<span class="n">fwhm_mean</span><span class="p">,</span> <span class="n">fwhm_med</span><span class="p">,</span> <span class="n">fwhm_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">apstat</span><span class="o">.</span><span class="n">fwhm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                    <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/08f88b2dd1f33332beda2d5ef3ad78b25a4455b2653975d3bc60d62dc0924594.png"><img alt="../_images/08f88b2dd1f33332beda2d5ef3ad78b25a4455b2653975d3bc60d62dc0924594.png" class="align-center" src="../_images/08f88b2dd1f33332beda2d5ef3ad78b25a4455b2653975d3bc60d62dc0924594.png" style="width: 840px; height: 824px;" />
</a>
</div>
</div>
</section>
<section id="derive-effective-psf">
<h2>3. Derive Effective PSF<a class="headerlink" href="#derive-effective-psf" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_epsf</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
             <span class="n">oversampling</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">smoothing_kernel</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">,</span>
             <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)):</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">figsize</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="n">m</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="o">/</span><span class="n">ncols</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                               <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)):</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">-band&#39;</span><span class="p">,</span>
                  <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="c1"># fig.suptitle(f&#39;Picked stars to model PSF ({band})&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
    <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span><span class="n">oversampling</span><span class="o">=</span><span class="n">oversampling</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">maxiters</span><span class="p">,</span>
                               <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">smoothing_kernel</span><span class="o">=</span><span class="n">smoothing_kernel</span><span class="p">)</span>  
    <span class="n">epsf</span><span class="p">,</span> <span class="n">fitted_stars</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">epsf</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective PSF (</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">epsf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epsf0</span> <span class="o">=</span> <span class="n">get_epsf</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/6fa393ec87393a6c6ec7518b700915d4ebd031325952e88842c808f03578f1eb.png"><img alt="../_images/6fa393ec87393a6c6ec7518b700915d4ebd031325952e88842c808f03578f1eb.png" class="align-center" src="../_images/6fa393ec87393a6c6ec7518b700915d4ebd031325952e88842c808f03578f1eb.png" style="width: 1007px; height: 1484px;" />
</a>
<a class="reference internal image-reference" href="../_images/4f01c83e2d69cae74d394ecaaa16ce5bc17c8002962b71017bd34de4afa1ae85.png"><img alt="../_images/4f01c83e2d69cae74d394ecaaa16ce5bc17c8002962b71017bd34de4afa1ae85.png" class="align-center" src="../_images/4f01c83e2d69cae74d394ecaaa16ce5bc17c8002962b71017bd34de4afa1ae85.png" style="width: 538px; height: 446px;" />
</a>
</div>
</div>
<section id="substar-subtract-adjacent-stars-and-reconstruct-epsf">
<h3>SUBSTAR - subtract adjacent stars and reconstruct EPSF<a class="headerlink" href="#substar-subtract-adjacent-stars-and-reconstruct-epsf" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># substar procedure</span>
<span class="c1"># subtract adjacent star profiles using the epsf model we obtained.</span>

<span class="k">def</span> <span class="nf">get_substars</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">,</span> <span class="n">thres</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)):</span>
    <span class="n">substars_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">:</span>
        <span class="n">finder</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span>
                               <span class="n">roundhi</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span>
                               <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="n">peakmax</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">finder</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">found</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">([</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">],</span>
                             <span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">,</span> <span class="s1">&#39;y_0&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_0&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">xname</span><span class="p">,</span> <span class="n">yname</span><span class="p">,</span> <span class="n">fluxname</span> <span class="o">=</span> <span class="n">_extract_psf_fitting_names</span><span class="p">(</span><span class="n">psf_model</span><span class="p">)</span>
            <span class="n">pars_to_set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">xname</span><span class="p">,</span> <span class="s1">&#39;y_0&#39;</span><span class="p">:</span> <span class="n">yname</span><span class="p">,</span> <span class="s1">&#39;flux_0&#39;</span><span class="p">:</span> <span class="n">fluxname</span><span class="p">}</span>
            <span class="n">group_psf</span> <span class="o">=</span> <span class="n">get_grouped_psf_model</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">pars_to_set</span><span class="p">)</span>
            <span class="n">fit_model</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">group_psf</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s1">&#39;cutout_center&#39;</span><span class="p">):</span>
                <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">cutout_center</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s1">&#39;cutout_center_flat&#39;</span><span class="p">):</span>
                <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">cutout_center_flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">((</span><span class="n">found</span><span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="s1">&#39;y_0&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># crude</span>
            <span class="n">cent_model</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
            <span class="n">substar_data</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">fit_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">cent_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">substar_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">hsize</span> <span class="o">=</span> <span class="n">substar_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">hsize</span><span class="o">-</span><span class="n">psize</span><span class="p">:</span><span class="n">hsize</span><span class="o">+</span><span class="n">psize</span><span class="p">,</span> <span class="n">hsize</span><span class="o">-</span><span class="n">psize</span><span class="p">:</span><span class="n">hsize</span><span class="o">+</span><span class="n">psize</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">med</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">substar_data</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="c1"># substar_data[substar_data &lt; med-2*sig] = med</span>
            <span class="n">substar_data</span> <span class="o">=</span> <span class="n">substar_data</span> <span class="o">-</span> <span class="n">med</span>
            
            <span class="n">substar</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
            <span class="n">substar</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">substar_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">substar</span> <span class="o">=</span> <span class="n">star</span>
            
        <span class="n">substars_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">substar</span><span class="p">)</span>
    
    <span class="n">substars</span> <span class="o">=</span> <span class="n">EPSFStars</span><span class="p">(</span><span class="n">substars_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">substars</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">substars</span> <span class="o">=</span> <span class="n">get_substars</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">epsf0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">fwhm_mean</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
<span class="n">epsf1</span> <span class="o">=</span> <span class="n">get_epsf</span><span class="p">(</span><span class="n">substars</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/5fa435b48ea781ec990ba636f42dae4d9fededcf8d855c9fbbbe271ac2e416dc.png"><img alt="../_images/5fa435b48ea781ec990ba636f42dae4d9fededcf8d855c9fbbbe271ac2e416dc.png" class="align-center" src="../_images/5fa435b48ea781ec990ba636f42dae4d9fededcf8d855c9fbbbe271ac2e416dc.png" style="width: 1007px; height: 1484px;" />
</a>
<a class="reference internal image-reference" href="../_images/54efeb838cba789b9e14fe30065fbbbae6fe9cd2120a021ab9eab27119a37757.png"><img alt="../_images/54efeb838cba789b9e14fe30065fbbbae6fe9cd2120a021ab9eab27119a37757.png" class="align-center" src="../_images/54efeb838cba789b9e14fe30065fbbbae6fe9cd2120a021ab9eab27119a37757.png" style="width: 538px; height: 446px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">substars2</span> <span class="o">=</span> <span class="n">get_substars</span><span class="p">(</span><span class="n">substars</span><span class="p">,</span> <span class="n">epsf0</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">fwhm_mean</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
<span class="n">epsf2</span> <span class="o">=</span> <span class="n">get_epsf</span><span class="p">(</span><span class="n">substars2</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/49042ef11c439b7e93a2d161be23fefd184bea495c2fa5d97b99f5e311fce3be.png"><img alt="../_images/49042ef11c439b7e93a2d161be23fefd184bea495c2fa5d97b99f5e311fce3be.png" class="align-center" src="../_images/49042ef11c439b7e93a2d161be23fefd184bea495c2fa5d97b99f5e311fce3be.png" style="width: 1007px; height: 1484px;" />
</a>
<a class="reference internal image-reference" href="../_images/53c21405e9bd7e2994aa5716e8881fd87dbb287868904a2068db546e4b9558c7.png"><img alt="../_images/53c21405e9bd7e2994aa5716e8881fd87dbb287868904a2068db546e4b9558c7.png" class="align-center" src="../_images/53c21405e9bd7e2994aa5716e8881fd87dbb287868904a2068db546e4b9558c7.png" style="width: 538px; height: 446px;" />
</a>
</div>
</div>
</section>
</section>
<section id="psf-photometry-with-the-epsf">
<h2>4. PSF Photometry with the EPSF<a class="headerlink" href="#psf-photometry-with-the-epsf" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_psfphot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">psf_size</span><span class="p">,</span> <span class="n">sigma_thres</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span>
                <span class="n">peakmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># set up the photometry object</span>
    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span> 
    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># background rms</span>
    
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">sigma_thres</span> <span class="o">*</span> <span class="n">std</span> <span class="c1"># threshold for star finding</span>
    <span class="n">crit_separation</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">fwhm</span> <span class="c1"># critical separation for star grouping</span>
    
    <span class="n">daogroup</span> <span class="o">=</span> <span class="n">DAOGroup</span><span class="p">(</span><span class="n">crit_separation</span><span class="p">)</span> <span class="c1"># grouping algorithm</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span> <span class="c1"># bkg estimator</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span> <span class="c1"># psf model fitter</span>
    
    <span class="n">fsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">psf_size</span><span class="p">))</span>
    <span class="n">fitshape</span> <span class="o">=</span> <span class="n">fsize</span> <span class="k">if</span> <span class="n">fsize</span><span class="o">%</span><span class="k">2</span> == 1 else fsize +1 # size of the fitting region
    
    <span class="c1"># find stars for the initial guess</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="c1">#sigma_psf * gaussian_sigma_to_fwhm,</span>
                            <span class="n">roundhi</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="n">peakmax</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    
    <span class="c1"># define the photometry object</span>
    <span class="n">photometry</span> <span class="o">=</span> <span class="n">BasicPSFPhotometry</span><span class="p">(</span><span class="n">finder</span><span class="o">=</span><span class="n">daofind</span><span class="p">,</span>
                                    <span class="n">group_maker</span><span class="o">=</span><span class="n">daogroup</span><span class="p">,</span>
                                    <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span>
                                    <span class="n">psf_model</span><span class="o">=</span><span class="n">psf_model</span><span class="p">,</span>
                                    <span class="n">fitter</span><span class="o">=</span><span class="n">fitter</span><span class="p">,</span>
                                    <span class="n">aperture_radius</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">fwhm</span><span class="p">,</span>
                                    <span class="c1"># niters=1,</span>
                                    <span class="n">fitshape</span><span class="o">=</span><span class="n">fitshape</span><span class="p">)</span>

    <span class="c1"># rename columns to match the names in the table</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">([</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span>
                         <span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">,</span> <span class="s1">&#39;y_0&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_0&#39;</span><span class="p">])</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="c1"># to record the time</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start time -&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
    
    <span class="c1"># run the photometry</span>
    <span class="n">result_tab</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">do_photometry</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                          <span class="n">init_guesses</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span>
                                          <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">residual_image</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">get_residual_image</span><span class="p">()</span>
    
    <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finish time -&#39;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="n">finish</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;elapsed time - </span><span class="si">{</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> min&#39;</span><span class="p">)</span>

    <span class="c1"># discard stars outside the image</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">result_tab</span> <span class="o">=</span> <span class="n">discard_stars_outside</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">result_tab</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result_tab</span><span class="p">,</span> <span class="n">photometry</span>


<span class="k">def</span> <span class="nf">discard_stars_outside</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">result_tab</span><span class="p">):</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">xin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">yin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">isin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_tab</span><span class="p">[</span><span class="n">isin</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set fwhm, psf_model, psf_size, sigma_thres, peakmax</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm_med</span> <span class="c1"># median fwhm of selected stars</span>
<span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">*</span> <span class="n">gaussian_fwhm_to_sigma</span> <span class="c1"># sigma of psf</span>
<span class="n">psf_model</span> <span class="o">=</span> <span class="n">epsf0</span> <span class="c1"># epsf model - just using the epsf without iteration</span>
<span class="n">psf_size</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">*</span> <span class="mi">4</span> <span class="c1"># size of psf model to fit</span>
<span class="n">sigma_thres</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1"># threshold for star detection</span>
<span class="n">peakmax</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c1"># maximum peak value for the detection (prevent saturated stars)</span>

<span class="c1"># get photometry by BasicPSFPhotometry</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">get_psfphot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">psf_size</span><span class="p">,</span>
                  <span class="n">sigma_thres</span><span class="o">=</span><span class="n">sigma_thres</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="n">peakmax</span><span class="p">)</span>

<span class="n">result_tab</span><span class="p">,</span> <span class="n">photometry</span> <span class="o">=</span> <span class="n">res</span> <span class="c1"># extract result table and photometry object</span>
<span class="n">residual_image</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">get_residual_image</span><span class="p">()</span> <span class="c1"># residual_image = data-model</span>

<span class="c1"># save results</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">residual_image</span><span class="p">)</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;res_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sigma_thres</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">result_tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;result_tab_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sigma_thres</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span>
                 <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start time - Tue Apr  2 21:20:56 2024
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2dc2b851ac4d4cf383bd2c924bdb57d2", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finish time - Tue Apr  2 21:21:32 2024
elapsed time - 0.60 min
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_psfphot_result</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">result_tab</span><span class="p">,</span> <span class="n">residual_image</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span> <span class="o">-</span> <span class="n">residual_image</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">residual_image</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">],</span> <span class="n">result_tab</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">-band&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot results - data, model, residual</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">show_psfphot_result</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">result_tab</span><span class="p">,</span> <span class="n">residual_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/49a795695b8dd1e36bdf58ae56cbb8d8142c7d620d78947e9ef39a4cb47de151.png"><img alt="../_images/49a795695b8dd1e36bdf58ae56cbb8d8142c7d620d78947e9ef39a4cb47de151.png" class="align-center" src="../_images/49a795695b8dd1e36bdf58ae56cbb8d8142c7d620d78947e9ef39a4cb47de151.png" style="width: 974px; height: 350px;" />
</a>
</div>
</div>
</section>
<section id="iterations-over-all-bands">
<h2>5. Iterations Over All Bands<a class="headerlink" href="#iterations-over-all-bands" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s do the same for all bands</span>
<span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)):</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Band: </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">thres</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">std</span>

    <span class="n">find_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">ll</span><span class="p">,</span> <span class="n">hh</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">650</span>
    <span class="n">find_mask</span><span class="p">[</span><span class="n">ll</span><span class="p">:</span><span class="n">hh</span><span class="p">,</span> <span class="n">ll</span><span class="p">:</span><span class="n">hh</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">peaks_tbl</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">find_mask</span><span class="p">)</span>
    <span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.8g</span><span class="s1">&#39;</span>

    <span class="c1"># select stars within the cutout of specified size</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">21</span>
    <span class="n">hsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;x_peak&#39;</span><span class="p">]</span>  
    <span class="n">y</span> <span class="o">=</span> <span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;y_peak&#39;</span><span class="p">]</span>  
    <span class="n">bound</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">)))</span>
    <span class="n">bright</span> <span class="o">=</span> <span class="p">(</span><span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">peaks_tbl</span><span class="p">[</span><span class="s1">&#39;peak_value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">)</span>

    <span class="n">bbmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">bound</span> <span class="o">&amp;</span> <span class="n">bright</span><span class="p">)</span>
    <span class="n">bx</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">bbmask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">bbmask</span><span class="p">]</span>

    <span class="n">isolated</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bx</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">by</span><span class="o">-</span><span class="n">yi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">)]</span>

    <span class="n">mask_stars</span> <span class="o">=</span> <span class="n">isolated</span>
    <span class="c1"># mask_stars = np.ones_like(bx, dtype=bool)</span>

    <span class="n">stars_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="n">mask_stars</span><span class="p">]</span>  
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">by</span><span class="p">[</span><span class="n">mask_stars</span><span class="p">]</span>

    <span class="c1"># print(stars_tbl)</span>

    <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># plot the locations of our selected stars</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">zscale_imshow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;.r&#39;</span><span class="p">)</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ll</span><span class="p">,</span><span class="n">ll</span><span class="p">),</span> <span class="n">hh</span><span class="o">-</span><span class="n">ll</span><span class="p">,</span> <span class="n">hh</span><span class="o">-</span><span class="n">ll</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                            <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="c1"># extract cutouts of our selected stars</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_tbl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

    <span class="c1"># derive fwhm from aperture statistics</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">center_flat</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
    <span class="n">apstat</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>

    <span class="n">fwhm_mean</span><span class="p">,</span> <span class="n">fwhm_med</span><span class="p">,</span> <span class="n">fwhm_std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">apstat</span><span class="o">.</span><span class="n">fwhm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="n">epsf0</span> <span class="o">=</span> <span class="n">get_epsf</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>
<span class="c1">#     substars = get_substars(stars, epsf0, 2*std, fwhm_mean, band)</span>
<span class="c1">#     epsf1 = get_epsf(substars, band)</span>
<span class="c1">#     substars2 = get_substars(substars, epsf0, 1*std, fwhm_mean, band)</span>
<span class="c1">#     epsf2 = get_epsf(substars2, band)</span>

    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm_med</span>
    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">*</span> <span class="n">gaussian_fwhm_to_sigma</span>
    <span class="n">psf_model</span> <span class="o">=</span> <span class="n">epsf0</span>
    <span class="n">psf_size</span> <span class="o">=</span> <span class="n">fwhm</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="n">sigma_thres</span> <span class="o">=</span> <span class="mf">5.</span>
    <span class="n">peakmax</span><span class="o">=</span><span class="mf">10.0</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">get_psfphot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">psf_model</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">psf_size</span><span class="p">,</span>
                    <span class="n">sigma_thres</span><span class="o">=</span><span class="n">sigma_thres</span><span class="p">,</span> <span class="n">peakmax</span><span class="o">=</span><span class="n">peakmax</span><span class="p">)</span>

    <span class="n">result_tab</span><span class="p">,</span> <span class="n">photometry</span> <span class="o">=</span> <span class="n">res</span>
    <span class="n">residual_image</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">get_residual_image</span><span class="p">()</span>

    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">residual_image</span><span class="p">)</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;res_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sigma_thres</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result_tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;result_tab_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sigma_thres</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">show_psfphot_result</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">result_tab</span><span class="p">,</span> <span class="n">residual_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>### Band: r
start time - Tue Apr  2 21:21:39 2024
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f7329675a71748e08dea58a6e2a4dcec", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finish time - Tue Apr  2 21:22:18 2024
elapsed time - 0.67 min
### Band: z
start time - Tue Apr  2 21:22:24 2024
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "899d3a214d7544f9a61ca2512ebfe58a", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finish time - Tue Apr  2 21:22:43 2024
elapsed time - 0.32 min
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/92ee2be1216d5b756f06a9aceea5880750387c32e2d634e46a9e2ce98e56d93f.png"><img alt="../_images/92ee2be1216d5b756f06a9aceea5880750387c32e2d634e46a9e2ce98e56d93f.png" class="align-center" src="../_images/92ee2be1216d5b756f06a9aceea5880750387c32e2d634e46a9e2ce98e56d93f.png" style="width: 839px; height: 819px;" />
</a>
<a class="reference internal image-reference" href="../_images/78904649e4b37ceb371af7e1f49a7c698bb955d6a63be7cba4cff6ac6c2bc875.png"><img alt="../_images/78904649e4b37ceb371af7e1f49a7c698bb955d6a63be7cba4cff6ac6c2bc875.png" class="align-center" src="../_images/78904649e4b37ceb371af7e1f49a7c698bb955d6a63be7cba4cff6ac6c2bc875.png" style="width: 1007px; height: 1491px;" />
</a>
<a class="reference internal image-reference" href="../_images/65006ab37709c8143fd5396fb250cadffb2ce5851703320cf9c020a3f7825756.png"><img alt="../_images/65006ab37709c8143fd5396fb250cadffb2ce5851703320cf9c020a3f7825756.png" class="align-center" src="../_images/65006ab37709c8143fd5396fb250cadffb2ce5851703320cf9c020a3f7825756.png" style="width: 525px; height: 446px;" />
</a>
<a class="reference internal image-reference" href="../_images/3e78d29cab339c0c17e1761899d2a417108120040c88a37ff497eb5d0253648d.png"><img alt="../_images/3e78d29cab339c0c17e1761899d2a417108120040c88a37ff497eb5d0253648d.png" class="align-center" src="../_images/3e78d29cab339c0c17e1761899d2a417108120040c88a37ff497eb5d0253648d.png" style="width: 974px; height: 350px;" />
</a>
<a class="reference internal image-reference" href="../_images/2b924241a26db031180525f7a29202a0319e1b559980916bdf8eaa24aadf2379.png"><img alt="../_images/2b924241a26db031180525f7a29202a0319e1b559980916bdf8eaa24aadf2379.png" class="align-center" src="../_images/2b924241a26db031180525f7a29202a0319e1b559980916bdf8eaa24aadf2379.png" style="width: 839px; height: 819px;" />
</a>
<a class="reference internal image-reference" href="../_images/16425af74a972ce695fc55076275cf61b7806fc7a330e902668134924d82a5f8.png"><img alt="../_images/16425af74a972ce695fc55076275cf61b7806fc7a330e902668134924d82a5f8.png" class="align-center" src="../_images/16425af74a972ce695fc55076275cf61b7806fc7a330e902668134924d82a5f8.png" style="width: 1007px; height: 1497px;" />
</a>
<a class="reference internal image-reference" href="../_images/6a98f451b0d1f2df44f124b8dfe5e1154740a5b214865b31d12037263e487e60.png"><img alt="../_images/6a98f451b0d1f2df44f124b8dfe5e1154740a5b214865b31d12037263e487e60.png" class="align-center" src="../_images/6a98f451b0d1f2df44f124b8dfe5e1154740a5b214865b31d12037263e487e60.png" style="width: 538px; height: 446px;" />
</a>
<a class="reference internal image-reference" href="../_images/2a6281deb6da89e9107bbda1d8ef80f7329b65640df70377186d0d5715499706.png"><img alt="../_images/2a6281deb6da89e9107bbda1d8ef80f7329b65640df70377186d0d5715499706.png" class="align-center" src="../_images/2a6281deb6da89e9107bbda1d8ef80f7329b65640df70377186d0d5715499706.png" style="width: 974px; height: 350px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now let&#39;s bring the results together to match the stars from each band</span>

<span class="n">sigma_thres</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1"># threshold for detection</span>
<span class="n">tbls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
    <span class="n">tbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">OUTDIR</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;result_tab_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sigma_thres</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">))</span>

<span class="n">gtbl</span><span class="p">,</span> <span class="n">rtbl</span><span class="p">,</span> <span class="n">ztbl</span> <span class="o">=</span> <span class="n">tbls</span> <span class="c1"># extract the tables for each band</span>

<span class="n">gtbl</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">()</span>
<span class="c1"># gtbl.show_in_notebook(display_length=10)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><i>Table length=5</i>
<table id="table10739460256-857971" class="table-striped table-bordered table-condensed">
<thead><tr><th>idx</th><th>id</th><th>x_0</th><th>y_0</th><th>sharpness</th><th>roundness1</th><th>roundness2</th><th>npix</th><th>sky</th><th>peak</th><th>flux_0</th><th>mag</th><th>group_id</th><th>x_fit</th><th>y_fit</th><th>flux_fit</th><th>flux_unc</th><th>x_0_unc</th><th>y_0_unc</th></tr></thead>
<tr><td>0</td><td>5</td><td>851.4578319217419</td><td>1.2431922857817184</td><td>0.3622949160971678</td><td>-0.43358245491981506</td><td>-0.6376099061779756</td><td>25</td><td>0.0</td><td>0.05964961275458336</td><td>2.6161646842956543</td><td>-1.0441626970183013</td><td>5</td><td>851.5495253021415</td><td>1.0894525281907939</td><td>1.5760442178186076</td><td>0.020664036449911355</td><td>0.03753065640162032</td><td>0.04052453853709505</td></tr>
<tr><td>1</td><td>6</td><td>867.3702033145247</td><td>1.7259493816810596</td><td>0.37489165251501855</td><td>-0.463954895734787</td><td>-0.4848240826943701</td><td>25</td><td>0.0</td><td>0.1318853199481964</td><td>4.749582290649414</td><td>-1.6916385415132682</td><td>6</td><td>867.0346200706329</td><td>1.765935198200546</td><td>4.096644161194953</td><td>0.06557941068367802</td><td>0.04435285678722531</td><td>0.05080049441169921</td></tr>
<tr><td>2</td><td>7</td><td>345.7117479805963</td><td>2.325191233801909</td><td>0.4317357941222555</td><td>-0.06992880254983902</td><td>0.07785421898175726</td><td>25</td><td>0.0</td><td>0.1554633378982544</td><td>4.834078311920166</td><td>-1.710784204214717</td><td>7</td><td>345.70965859660726</td><td>2.319107980033621</td><td>3.90563860822838</td><td>0.01676319830676679</td><td>0.012374757001817189</td><td>0.01151253322746038</td></tr>
<tr><td>3</td><td>8</td><td>207.11303020538915</td><td>3.058789311654089</td><td>0.4055527432918673</td><td>-0.11554194986820221</td><td>-0.04160403307501191</td><td>25</td><td>0.0</td><td>0.7060463428497314</td><td>22.39531707763672</td><td>-3.3753930391434532</td><td>8</td><td>207.16454774264363</td><td>3.057239800253853</td><td>17.781873934090658</td><td>0.08421597972918238</td><td>0.014042046358329464</td><td>0.013455827169577786</td></tr>
<tr><td>4</td><td>9</td><td>256.444645783138</td><td>3.265480036227865</td><td>0.4095938597021247</td><td>0.0777764841914177</td><td>0.062090565073566986</td><td>25</td><td>0.0</td><td>0.044628411531448364</td><td>1.279773235321045</td><td>-0.2678325581560389</td><td>9</td><td>256.7469714718961</td><td>3.477300275770375</td><td>1.392929443878588</td><td>0.05901571067722911</td><td>0.12179857566686644</td><td>0.10961134586058725</td></tr>
</table><style>table.dataTable {clear: both; width: auto !important; margin: 0 !important;}
.dataTables_info, .dataTables_length, .dataTables_filter, .dataTables_paginate{
display: inline-block; margin-right: 1em; }
.paginate_button { margin-right: 5px; }
</style>
<script>

var astropy_sort_num = function(a, b) {
    var a_num = parseFloat(a);
    var b_num = parseFloat(b);

    if (isNaN(a_num) && isNaN(b_num))
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    else if (!isNaN(a_num) && !isNaN(b_num))
        return ((a_num < b_num) ? -1 : ((a_num > b_num) ? 1 : 0));
    else
        return isNaN(a_num) ? -1 : 1;
}

require.config({paths: {
    datatables: 'https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min'
}});
require(["datatables"], function(){
    console.log("$('#table10739460256-857971').dataTable()");
    
jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "optionalnum-asc": astropy_sort_num,
    "optionalnum-desc": function (a,b) { return -astropy_sort_num(a, b); }
});

    $('#table10739460256-857971').dataTable({
        order: [],
        pageLength: 50,
        lengthMenu: [[10, 25, 50, 100, 500, 1000, -1], [10, 25, 50, 100, 500, 1000, 'All']],
        pagingType: "full_numbers",
        columnDefs: [{targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18], type: "optionalnum"}]
    });
});
</script>
</div></div>
</div>
</section>
<section id="match-the-results-of-each-band">
<h2>6. Match the Results of Each Band<a class="headerlink" href="#match-the-results-of-each-band" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># crude and slow match of the stars from each band</span>
<span class="c1"># for more sophisticated matching, see the exgalcosutils.catalog.match_catalogs function</span>
<span class="c1"># (https://github.com/hbahk/exgalcosutils/blob/d8dc13f05237bc6c21e187d3465f4b7a12cb3469/exgalcosutils/catalog.py#L16)</span>

<span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the distance between two points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">match_stars</span><span class="p">(</span><span class="n">reftab</span><span class="p">,</span> <span class="n">objtab</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">objcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">],</span>
                <span class="n">refcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">rlim</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a table matched by positions of stars in each band.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tab_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">reftab</span><span class="p">:</span> <span class="c1"># for loop is slow, but it&#39;s ok for now</span>
        <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span> <span class="o">=</span> <span class="n">objtab</span><span class="p">[</span><span class="n">objcard</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">objtab</span><span class="p">[</span><span class="n">objcard</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">star</span><span class="p">[</span><span class="n">refcard</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">star</span><span class="p">[</span><span class="n">refcard</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="n">rlim</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">objtab</span><span class="p">[</span><span class="n">match</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="s1">&#39;: nothing matched with the given standard star&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="s1">&#39;: duplication occured in the pixel match process&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">objcard</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">objcard</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                <span class="n">tab</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">objcard</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tab_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hstack</span><span class="p">([</span><span class="n">star</span><span class="p">,</span> <span class="n">tab</span><span class="p">],</span> <span class="n">table_names</span><span class="o">=</span><span class="n">table_names</span><span class="p">))</span>
    
    <span class="n">matched_tab</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">tab_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matched_tab</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;g-band: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtbl</span><span class="p">)</span><span class="si">}</span><span class="s1"> stars, r-band: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rtbl</span><span class="p">)</span><span class="si">}</span><span class="s1"> stars, z-band: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ztbl</span><span class="p">)</span><span class="si">}</span><span class="s1"> stars&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>g-band: 2727 stars, r-band: 3309 stars, z-band: 1645 stars
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s set the reference band to r-band, since it has the most stars.</span>
<span class="c1"># we will match the stars in the other bands to the r-band stars.</span>
<span class="n">rlim</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="c1"># matching radius in pixel</span>
<span class="n">grtbl</span> <span class="o">=</span> <span class="n">match_stars</span><span class="p">(</span><span class="n">rtbl</span><span class="p">,</span> <span class="n">gtbl</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">],</span> <span class="n">refcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">],</span> <span class="n">rlim</span><span class="o">=</span><span class="n">rlim</span><span class="p">)</span>

<span class="n">grtbl</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">()</span>
<span class="c1"># grtbl.show_in_notebook(display_length=10)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><i>Table length=5</i>
<table id="table10930751104-843404" class="table-striped table-bordered table-condensed">
<thead><tr><th>idx</th><th>id_r</th><th>x_0_r</th><th>y_0_r</th><th>sharpness_r</th><th>roundness1_r</th><th>roundness2_r</th><th>npix_r</th><th>sky_r</th><th>peak_r</th><th>flux_0_r</th><th>mag_r</th><th>group_id_r</th><th>x_fit_r</th><th>y_fit_r</th><th>flux_fit_r</th><th>flux_unc_r</th><th>x_0_unc_r</th><th>y_0_unc_r</th><th>id_g</th><th>x_0_g</th><th>y_0_g</th><th>sharpness_g</th><th>roundness1_g</th><th>roundness2_g</th><th>npix_g</th><th>sky_g</th><th>peak_g</th><th>flux_0_g</th><th>mag_g</th><th>group_id_g</th><th>x_fit_g</th><th>y_fit_g</th><th>flux_fit_g</th><th>flux_unc_g</th><th>x_0_unc_g</th><th>y_0_unc_g</th></tr></thead>
<tr><td>0</td><td>4</td><td>216.2505236082457</td><td>1.2946835394272416</td><td>0.31965956104172266</td><td>-0.34563782811164856</td><td>-1.3672357013964573</td><td>25</td><td>0.0</td><td>0.05218406021595001</td><td>1.208444356918335</td><td>-0.20556664505183506</td><td>4</td><td>207.39444473323013</td><td>2.9368815520484306</td><td>26.602133173179638</td><td>0.4045609236722423</td><td>0.045692161634503674</td><td>0.02843551742311372</td><td>8</td><td>207.11303020538915</td><td>3.058789311654089</td><td>0.4055527432918673</td><td>-0.11554194986820221</td><td>-0.04160403307501191</td><td>25</td><td>0.0</td><td>0.7060463428497314</td><td>22.39531707763672</td><td>-3.3753930391434532</td><td>8</td><td>207.16454774264363</td><td>3.057239800253853</td><td>17.781873934090658</td><td>0.08421597972918238</td><td>0.014042046358329464</td><td>0.013455827169577786</td></tr>
<tr><td>1</td><td>6</td><td>851.4603555355027</td><td>1.210779183319241</td><td>0.38046402004755103</td><td>-0.45898571610450745</td><td>-0.4806057426938176</td><td>25</td><td>0.0</td><td>0.08379759639501572</td><td>2.6913681030273438</td><td>-1.0749327525667034</td><td>6</td><td>851.4457414767904</td><td>1.0232870323296104</td><td>1.910690767450376</td><td>0.024653588286833054</td><td>0.03306353785214263</td><td>0.04046506821104487</td><td>5</td><td>851.4578319217419</td><td>1.2431922857817184</td><td>0.3622949160971678</td><td>-0.43358245491981506</td><td>-0.6376099061779756</td><td>25</td><td>0.0</td><td>0.05964961275458336</td><td>2.6161646842956543</td><td>-1.0441626970183013</td><td>5</td><td>851.5495253021415</td><td>1.0894525281907939</td><td>1.5760442178186076</td><td>0.020664036449911355</td><td>0.03753065640162032</td><td>0.04052453853709505</td></tr>
<tr><td>2</td><td>7</td><td>867.3055212219573</td><td>1.69375403297401</td><td>0.4262485769040658</td><td>-0.42902904748916626</td><td>-0.4098428273941409</td><td>25</td><td>0.0</td><td>0.17512261867523193</td><td>4.529127597808838</td><td>-1.6400363902720199</td><td>7</td><td>866.9401574610634</td><td>1.7132385430884567</td><td>4.6438904969146675</td><td>0.09006266334533272</td><td>0.05144376834277171</td><td>0.05104995780831012</td><td>6</td><td>867.3702033145247</td><td>1.7259493816810596</td><td>0.37489165251501855</td><td>-0.463954895734787</td><td>-0.4848240826943701</td><td>25</td><td>0.0</td><td>0.1318853199481964</td><td>4.749582290649414</td><td>-1.6916385415132682</td><td>6</td><td>867.0346200706329</td><td>1.765935198200546</td><td>4.096644161194953</td><td>0.06557941068367802</td><td>0.04435285678722531</td><td>0.05080049441169921</td></tr>
<tr><td>3</td><td>8</td><td>345.6106440032075</td><td>2.3098377764763294</td><td>0.4469803029838169</td><td>-0.14323532581329346</td><td>-0.01388777237022494</td><td>25</td><td>0.0</td><td>0.23933547735214233</td><td>5.749619483947754</td><td>-1.8990977589023124</td><td>8</td><td>345.5849331807853</td><td>2.2975532090055277</td><td>5.229977391605547</td><td>0.024295829054559518</td><td>0.011212517576637658</td><td>0.012534304858968434</td><td>7</td><td>345.7117479805963</td><td>2.325191233801909</td><td>0.4317357941222555</td><td>-0.06992880254983902</td><td>0.07785421898175726</td><td>25</td><td>0.0</td><td>0.1554633378982544</td><td>4.834078311920166</td><td>-1.710784204214717</td><td>7</td><td>345.70965859660726</td><td>2.319107980033621</td><td>3.90563860822838</td><td>0.01676319830676679</td><td>0.012374757001817189</td><td>0.01151253322746038</td></tr>
<tr><td>4</td><td>9</td><td>206.97902920589135</td><td>3.1589936964332406</td><td>0.44485950183475437</td><td>-0.19737784564495087</td><td>-0.06359504616173453</td><td>25</td><td>0.0</td><td>1.3406950235366821</td><td>28.900096893310547</td><td>-3.652248247043581</td><td>9</td><td>205.17344258845606</td><td>4.063231176381494</td><td>6.3097345219195695</td><td>0.19966125324871484</td><td>0.094020069975218</td><td>0.08353356649350534</td><td>8</td><td>207.11303020538915</td><td>3.058789311654089</td><td>0.4055527432918673</td><td>-0.11554194986820221</td><td>-0.04160403307501191</td><td>25</td><td>0.0</td><td>0.7060463428497314</td><td>22.39531707763672</td><td>-3.3753930391434532</td><td>8</td><td>207.16454774264363</td><td>3.057239800253853</td><td>17.781873934090658</td><td>0.08421597972918238</td><td>0.014042046358329464</td><td>0.013455827169577786</td></tr>
</table><style>table.dataTable {clear: both; width: auto !important; margin: 0 !important;}
.dataTables_info, .dataTables_length, .dataTables_filter, .dataTables_paginate{
display: inline-block; margin-right: 1em; }
.paginate_button { margin-right: 5px; }
</style>
<script>

var astropy_sort_num = function(a, b) {
    var a_num = parseFloat(a);
    var b_num = parseFloat(b);

    if (isNaN(a_num) && isNaN(b_num))
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    else if (!isNaN(a_num) && !isNaN(b_num))
        return ((a_num < b_num) ? -1 : ((a_num > b_num) ? 1 : 0));
    else
        return isNaN(a_num) ? -1 : 1;
}

require.config({paths: {
    datatables: 'https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min'
}});
require(["datatables"], function(){
    console.log("$('#table10930751104-843404').dataTable()");
    
jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "optionalnum-asc": astropy_sort_num,
    "optionalnum-desc": function (a,b) { return -astropy_sort_num(a, b); }
});

    $('#table10930751104-843404').dataTable({
        order: [],
        pageLength: 50,
        lengthMenu: [[10, 25, 50, 100, 500, 1000, -1], [10, 25, 50, 100, 500, 1000, 'All']],
        pagingType: "full_numbers",
        columnDefs: [{targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36], type: "optionalnum"}]
    });
});
</script>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s check how well the matching went by plotting the difference of positions of the stars</span>
<span class="c1"># if the rlim=3.0 is too large, then try smaller value and repeat the matching process</span>
<span class="c1"># rlim ~&lt; FWHM is recommended</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;x_fit_r&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;x_fit_g&#39;</span><span class="p">],</span> <span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;y_fit_r&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;y_fit_g&#39;</span><span class="p">],</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\Delta x$ (pixel)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\Delta y$ (pixel)&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">rgbimg</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">DATADIR</span><span class="o">/</span><span class="s1">&#39;NGC2210.grz.rgb.fits&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgbimg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;x_fit_r&#39;</span><span class="p">],</span> <span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;y_fit_r&#39;</span><span class="p">],</span> <span class="s1">&#39;xr&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;x_fit_g&#39;</span><span class="p">],</span> <span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;y_fit_g&#39;</span><span class="p">],</span> <span class="s1">&#39;xb&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:7: SyntaxWarning: invalid escape sequence &#39;\D&#39;
&lt;&gt;:8: SyntaxWarning: invalid escape sequence &#39;\D&#39;
&lt;&gt;:7: SyntaxWarning: invalid escape sequence &#39;\D&#39;
&lt;&gt;:8: SyntaxWarning: invalid escape sequence &#39;\D&#39;
/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/2619397371.py:7: SyntaxWarning: invalid escape sequence &#39;\D&#39;
  ax.set_xlabel(&#39;$\Delta x$ (pixel)&#39;)
/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/2619397371.py:8: SyntaxWarning: invalid escape sequence &#39;\D&#39;
  ax.set_ylabel(&#39;$\Delta y$ (pixel)&#39;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x28abb49e0&gt;]
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/be7085e37e045fc28e42d946e6df35ab58bf1bfc16da26d56432b1261ef59740.png"><img alt="../_images/be7085e37e045fc28e42d946e6df35ab58bf1bfc16da26d56432b1261ef59740.png" class="align-center" src="../_images/be7085e37e045fc28e42d946e6df35ab58bf1bfc16da26d56432b1261ef59740.png" style="width: 475px; height: 462px;" />
</a>
<a class="reference internal image-reference" href="../_images/a74287151980108c06a3beec25c1fca35f7a6cd5f47c3ce8b203bbf30a4a0b9a.png"><img alt="../_images/a74287151980108c06a3beec25c1fca35f7a6cd5f47c3ce8b203bbf30a4a0b9a.png" class="align-center" src="../_images/a74287151980108c06a3beec25c1fca35f7a6cd5f47c3ce8b203bbf30a4a0b9a.png" style="width: 608px; height: 588px;" />
</a>
</div>
</div>
</section>
<section id="color-magnitude-diagram">
<h2>7. Color-Magnitude Diagram<a class="headerlink" href="#color-magnitude-diagram" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># then let&#39;s draw the color-magnitude diagram</span>

<span class="k">def</span> <span class="nf">flux2mag</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="mf">22.5</span><span class="p">):</span> <span class="c1"># the default zeropoint is set to 22.5 for the nanomaggy unit</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">+</span> <span class="n">zp</span>

<span class="n">gmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;flux_fit_g&#39;</span><span class="p">])</span>
<span class="n">rmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;flux_fit_r&#39;</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gmag</span><span class="o">-</span><span class="n">rmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$g-r$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$r$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="c1"># let&#39;s plot the color-magnitude diagram focusing on the non-outliers</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gmag</span><span class="o">-</span><span class="n">rmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$g-r$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$r$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/3953004836.py:4: RuntimeWarning: invalid value encountered in log10
  return -2.5*np.log10(flux) + zp
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(23.0, 15.0)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/36ab45e9e90cdc7f609ba2f9cdd2ce77aeb2170a0d239eb6e7603cf6daa11066.png"><img alt="../_images/36ab45e9e90cdc7f609ba2f9cdd2ce77aeb2170a0d239eb6e7603cf6daa11066.png" class="align-center" src="../_images/36ab45e9e90cdc7f609ba2f9cdd2ce77aeb2170a0d239eb6e7603cf6daa11066.png" style="width: 873px; height: 468px;" />
</a>
</div>
</div>
</section>
<section id="comparison-with-the-references">
<h2>8. Comparison with the References<a class="headerlink" href="#comparison-with-the-references" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s compare the color-magnitude diagram with the legacy survey catalog</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">celestial</span><span class="o">.</span><span class="n">calc_footprint</span><span class="p">()</span>
<span class="n">ralo</span><span class="p">,</span> <span class="n">rahi</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">declo</span><span class="p">,</span> <span class="n">dechi</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">lgs_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.legacysurvey.org/viewer/ls-dr10/cat.fits?&#39;</span>
<span class="n">cat_bbox</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ralo=</span><span class="si">{</span><span class="n">ralo</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&amp;rahi=</span><span class="si">{</span><span class="n">rahi</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&amp;declo=</span><span class="si">{</span><span class="n">declo</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&amp;dechi=</span><span class="si">{</span><span class="n">dechi</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">query_url</span> <span class="o">=</span> <span class="n">lgs_url</span> <span class="o">+</span> <span class="n">cat_bbox</span>
<span class="n">cathdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>

<span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">cathdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">cat</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">()</span>
<span class="c1"># cat.show_in_notebook(display_length=10)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><i>Table length=5</i>
<table id="table10890412688-736767" class="table-striped table-bordered table-condensed">
<thead><tr><th>idx</th><th>release</th><th>brickid</th><th>brickname</th><th>objid</th><th>brick_primary</th><th>maskbits</th><th>fitbits</th><th>type</th><th>ra</th><th>dec</th><th>ra_ivar</th><th>dec_ivar</th><th>bx</th><th>by</th><th>dchisq</th><th>ebv</th><th>mjd_min</th><th>mjd_max</th><th>ref_cat</th><th>ref_id</th><th>pmra</th><th>pmdec</th><th>parallax</th><th>pmra_ivar</th><th>pmdec_ivar</th><th>parallax_ivar</th><th>ref_epoch</th><th>gaia_phot_g_mean_mag</th><th>gaia_phot_g_mean_flux_over_error</th><th>gaia_phot_g_n_obs</th><th>gaia_phot_bp_mean_mag</th><th>gaia_phot_bp_mean_flux_over_error</th><th>gaia_phot_bp_n_obs</th><th>gaia_phot_rp_mean_mag</th><th>gaia_phot_rp_mean_flux_over_error</th><th>gaia_phot_rp_n_obs</th><th>gaia_phot_variable_flag</th><th>gaia_astrometric_excess_noise</th><th>gaia_astrometric_excess_noise_sig</th><th>gaia_astrometric_n_obs_al</th><th>gaia_astrometric_n_good_obs_al</th><th>gaia_astrometric_weight_al</th><th>gaia_duplicated_source</th><th>gaia_a_g_val</th><th>gaia_e_bp_min_rp_val</th><th>gaia_phot_bp_rp_excess_factor</th><th>gaia_astrometric_sigma5d_max</th><th>gaia_astrometric_params_solved</th><th>flux_g</th><th>flux_r</th><th>flux_i</th><th>flux_z</th><th>flux_w1</th><th>flux_w2</th><th>flux_w3</th><th>flux_w4</th><th>flux_ivar_g</th><th>flux_ivar_r</th><th>flux_ivar_i</th><th>flux_ivar_z</th><th>flux_ivar_w1</th><th>flux_ivar_w2</th><th>flux_ivar_w3</th><th>flux_ivar_w4</th><th>fiberflux_g</th><th>fiberflux_r</th><th>fiberflux_i</th><th>fiberflux_z</th><th>fibertotflux_g</th><th>fibertotflux_r</th><th>fibertotflux_i</th><th>fibertotflux_z</th><th>apflux_g</th><th>apflux_r</th><th>apflux_i</th><th>apflux_z</th><th>apflux_resid_g</th><th>apflux_resid_r</th><th>apflux_resid_i</th><th>apflux_resid_z</th><th>apflux_blobresid_g</th><th>apflux_blobresid_r</th><th>apflux_blobresid_i</th><th>apflux_blobresid_z</th><th>apflux_ivar_g</th><th>apflux_ivar_r</th><th>apflux_ivar_i</th><th>apflux_ivar_z</th><th>apflux_masked_g</th><th>apflux_masked_r</th><th>apflux_masked_i</th><th>apflux_masked_z</th><th>apflux_w1</th><th>apflux_w2</th><th>apflux_w3</th><th>apflux_w4</th><th>apflux_resid_w1</th><th>apflux_resid_w2</th><th>apflux_resid_w3</th><th>apflux_resid_w4</th><th>apflux_ivar_w1</th><th>apflux_ivar_w2</th><th>apflux_ivar_w3</th><th>apflux_ivar_w4</th><th>mw_transmission_g</th><th>mw_transmission_r</th><th>mw_transmission_i</th><th>mw_transmission_z</th><th>mw_transmission_w1</th><th>mw_transmission_w2</th><th>mw_transmission_w3</th><th>mw_transmission_w4</th><th>nobs_g</th><th>nobs_r</th><th>nobs_i</th><th>nobs_z</th><th>nobs_w1</th><th>nobs_w2</th><th>nobs_w3</th><th>nobs_w4</th><th>rchisq_g</th><th>rchisq_r</th><th>rchisq_i</th><th>rchisq_z</th><th>rchisq_w1</th><th>rchisq_w2</th><th>rchisq_w3</th><th>rchisq_w4</th><th>fracflux_g</th><th>fracflux_r</th><th>fracflux_i</th><th>fracflux_z</th><th>fracflux_w1</th><th>fracflux_w2</th><th>fracflux_w3</th><th>fracflux_w4</th><th>fracmasked_g</th><th>fracmasked_r</th><th>fracmasked_i</th><th>fracmasked_z</th><th>fracin_g</th><th>fracin_r</th><th>fracin_i</th><th>fracin_z</th><th>ngood_g</th><th>ngood_r</th><th>ngood_i</th><th>ngood_z</th><th>anymask_g</th><th>anymask_r</th><th>anymask_i</th><th>anymask_z</th><th>allmask_g</th><th>allmask_r</th><th>allmask_i</th><th>allmask_z</th><th>wisemask_w1</th><th>wisemask_w2</th><th>psfsize_g</th><th>psfsize_r</th><th>psfsize_i</th><th>psfsize_z</th><th>psfdepth_g</th><th>psfdepth_r</th><th>psfdepth_i</th><th>psfdepth_z</th><th>galdepth_g</th><th>galdepth_r</th><th>galdepth_i</th><th>galdepth_z</th><th>nea_g</th><th>nea_r</th><th>nea_i</th><th>nea_z</th><th>blob_nea_g</th><th>blob_nea_r</th><th>blob_nea_i</th><th>blob_nea_z</th><th>psfdepth_w1</th><th>psfdepth_w2</th><th>psfdepth_w3</th><th>psfdepth_w4</th><th>wise_coadd_id</th><th>wise_x</th><th>wise_y</th><th>lc_flux_w1</th><th>lc_flux_w2</th><th>lc_flux_ivar_w1</th><th>lc_flux_ivar_w2</th><th>lc_nobs_w1</th><th>lc_nobs_w2</th><th>lc_fracflux_w1</th><th>lc_fracflux_w2</th><th>lc_rchisq_w1</th><th>lc_rchisq_w2</th><th>lc_mjd_w1</th><th>lc_mjd_w2</th><th>lc_epoch_index_w1</th><th>lc_epoch_index_w2</th><th>sersic</th><th>sersic_ivar</th><th>shape_r</th><th>shape_r_ivar</th><th>shape_e1</th><th>shape_e1_ivar</th><th>shape_e2</th><th>shape_e2_ivar</th></tr></thead>
<tr><td>0</td><td>10000</td><td>21606</td><td>0928m692</td><td>3632</td><td>True</td><td>8192</td><td>129</td><td>PSF</td><td>92.78757007578037</td><td>-69.12959365210126</td><td>62271860000000.0</td><td>99642075000000.0</td><td>1867.9648</td><td>3453.933</td><td>143652.3 .. 0.0</td><td>0.072651625</td><td>57283.31326590667</td><td>59268.07856435075</td><td>GE</td><td>5279742686399885312</td><td>1.3109009</td><td>1.4812818</td><td>-0.070761435</td><td>2.3821611</td><td>5.770945</td><td>5.594181</td><td>2016.0</td><td>20.15112</td><td>192.3021</td><td>270</td><td>20.435118</td><td>18.27049</td><td>0</td><td>19.89739</td><td>12.570855</td><td>0</td><td>False</td><td>1.1294675</td><td>0.91282725</td><td>0</td><td>0</td><td>0.0</td><td>False</td><td>0.0</td><td>0.0</td><td>1.0900487</td><td>0.91672444</td><td>31</td><td>8.298511</td><td>8.945159</td><td>8.487956</td><td>8.432867</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>877.3331</td><td>718.1057</td><td>268.16235</td><td>90.84242</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>6.4651184</td><td>6.968902</td><td>6.6127095</td><td>6.569791</td><td>6.4646473</td><td>6.9683943</td><td>6.612228</td><td>6.569312</td><td>2.498601 .. 18.798218</td><td>3.2165787 .. 27.84321</td><td>2.270678 .. 25.20499</td><td>2.5010936 .. 27.251497</td><td>-0.094051026 .. 6.24606</td><td>-0.1272347 .. 11.613896</td><td>-0.034183294 .. 8.227281</td><td>-0.013881785 .. 9.485866</td><td>-0.094051026 .. 6.24606</td><td>-0.1272347 .. 11.613896</td><td>-0.034183294 .. 8.227281</td><td>-0.013881785 .. 9.485866</td><td>4302.66 .. 26.097149</td><td>2988.5078 .. 31.565092</td><td>1799.0396 .. 9.936828</td><td>550.3695 .. 2.77558</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.47616625 .. 2.2627623</td><td>0.34674054 .. 4.482998</td><td>-1.2738854 .. -13.678328</td><td>-1.0870681 .. -34.920433</td><td>0.46386555 .. 2.095589</td><td>0.34032154 .. 4.3984013</td><td>-1.2854753 .. -13.803032</td><td>-1.0955067 .. -35.15571</td><td>89.92067 .. 7.042809</td><td>21.144802 .. 1.5757307</td><td>0.3320874 .. 0.024630265</td><td>0.012552651 .. 0.0009306426</td><td>0.8064902</td><td>0.8651346</td><td>0.8989498</td><td>0.9221627</td><td>0.98776317</td><td>0.99246716</td><td>0.99838865</td><td>0.99939126</td><td>4</td><td>3</td><td>4</td><td>6</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.9490697</td><td>2.6909757</td><td>1.0727901</td><td>1.0382285</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0008358622</td><td>0.0004906396</td><td>0.0030949514</td><td>0.0022943572</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0054039187</td><td>0.0</td><td>0.00028888456</td><td>0.17291327</td><td>0.9999999</td><td>1.0000001</td><td>1.0</td><td>1.0</td><td>4</td><td>3</td><td>4</td><td>5</td><td>0</td><td>0</td><td>0</td><td>2048</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.423446</td><td>1.262223</td><td>1.523291</td><td>1.4677155</td><td>2335.5513</td><td>1391.1311</td><td>308.9544</td><td>97.81459</td><td>1479.8228</td><td>810.94653</td><td>198.52147</td><td>59.83889</td><td>4.56928</td><td>3.5420256</td><td>5.308711</td><td>4.830164</td><td>4.56936</td><td>3.5420852</td><td>5.3087926</td><td>4.0728116</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td></td><td>0.0</td><td>0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 0</td><td>0 .. 0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 16</td><td>0 .. 16</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
<tr><td>1</td><td>10000</td><td>21606</td><td>0928m692</td><td>3638</td><td>True</td><td>8192</td><td>129</td><td>PSF</td><td>92.78808919227178</td><td>-69.12818970307045</td><td>31441444000000.0</td><td>57867800000000.0</td><td>1865.428</td><td>3473.2246</td><td>74006.31 .. 0.0</td><td>0.07256889</td><td>57283.31326590667</td><td>59268.07856435075</td><td>GE</td><td>5279742755130206336</td><td>2.680022</td><td>2.4693081</td><td>0.6905479</td><td>1.4555007</td><td>3.0879586</td><td>3.2713585</td><td>2016.0</td><td>20.50525</td><td>166.3184</td><td>279</td><td>21.08072</td><td>9.514463</td><td>0</td><td>20.037846</td><td>11.650101</td><td>0</td><td>False</td><td>0.7970623</td><td>0.24483252</td><td>0</td><td>0</td><td>0.0</td><td>False</td><td>0.0</td><td>0.0</td><td>1.0742582</td><td>1.1786243</td><td>95</td><td>4.264763</td><td>7.3260207</td><td>8.670622</td><td>9.5797825</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>212.29167</td><td>783.91205</td><td>264.03497</td><td>89.63854</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>3.3178408</td><td>5.699395</td><td>6.745449</td><td>7.452745</td><td>3.315516</td><td>5.6954017</td><td>6.740723</td><td>7.447523</td><td>1.3301907 .. 18.185356</td><td>2.6378582 .. 26.679947</td><td>2.2484665 .. 24.360357</td><td>2.7981932 .. 25.01609</td><td>-0.10030402 .. 3.5931304</td><td>-0.11436806 .. 8.013494</td><td>-0.10821519 .. 4.957432</td><td>-0.06148577 .. 4.714269</td><td>-0.10030402 .. 3.5931304</td><td>-0.11436806 .. 8.013494</td><td>-0.10821519 .. 4.957432</td><td>-0.06148577 .. 4.714269</td><td>927.5121 .. 21.609037</td><td>3344.3213 .. 31.58236</td><td>1766.0658 .. 10.62638</td><td>545.5569 .. 2.8899465</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.8132416 .. 4.6910753</td><td>0.7068993 .. 6.130646</td><td>-2.7616856 .. -20.86119</td><td>-0.3840622 .. -17.733297</td><td>0.7977932 .. 4.1131463</td><td>0.6985612 .. 5.8887625</td><td>-2.7767415 .. -21.121397</td><td>-0.40319905 .. -18.037237</td><td>87.94504 .. 6.904517</td><td>20.665148 .. 1.5657216</td><td>0.3306132 .. 0.024638768</td><td>0.0126051605 .. 0.0009347549</td><td>0.8066877</td><td>0.86527735</td><td>0.8990589</td><td>0.9222478</td><td>0.98777705</td><td>0.9924757</td><td>0.9983905</td><td>0.999392</td><td>4</td><td>3</td><td>4</td><td>6</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.0934112</td><td>3.0050054</td><td>1.7860744</td><td>0.8481531</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0028263621</td><td>0.0011597461</td><td>0.0034827534</td><td>0.0021375008</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.22418965</td><td>0.0</td><td>6.584817e-07</td><td>0.18844916</td><td>0.99918</td><td>1.0</td><td>1.0</td><td>1.0</td><td>3</td><td>3</td><td>4</td><td>5</td><td>2048</td><td>0</td><td>0</td><td>2048</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.423446</td><td>1.262223</td><td>1.523291</td><td>1.4677155</td><td>273.65677</td><td>1391.1311</td><td>308.9544</td><td>97.81459</td><td>163.1253</td><td>810.94653</td><td>198.52147</td><td>59.83889</td><td>4.5589733</td><td>3.5416598</td><td>5.308278</td><td>4.829716</td><td>0.53446114</td><td>3.5417206</td><td>5.3083606</td><td>4.0724344</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td></td><td>0.0</td><td>0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 0</td><td>0 .. 0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 16</td><td>0 .. 16</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
<tr><td>2</td><td>10000</td><td>21606</td><td>0928m692</td><td>3641</td><td>True</td><td>8192</td><td>129</td><td>PSF</td><td>92.78849191182563</td><td>-69.13793761028107</td><td>47808930000000.0</td><td>73617224000000.0</td><td>1863.428</td><td>3339.2837</td><td>124841.4 .. 0.0</td><td>0.07312917</td><td>57283.31326590667</td><td>59268.07856435075</td><td>GE</td><td>5279742686416209152</td><td>0.2521983</td><td>1.4458102</td><td>-0.016146168</td><td>2.183477</td><td>2.5972373</td><td>4.1903563</td><td>2016.0</td><td>20.36864</td><td>175.94759</td><td>275</td><td>20.509983</td><td>8.335049</td><td>0</td><td>19.746296</td><td>15.887417</td><td>0</td><td>False</td><td>0.0</td><td>0.0</td><td>0</td><td>0</td><td>0.0</td><td>False</td><td>0.0</td><td>0.0</td><td>1.383404</td><td>1.0020562</td><td>31</td><td>6.367055</td><td>8.38598</td><td>9.369133</td><td>8.916471</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>1034.6625</td><td>752.45465</td><td>265.2095</td><td>84.30954</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>4.950536</td><td>6.5202966</td><td>7.284722</td><td>6.9327664</td><td>4.9503098</td><td>6.5199995</td><td>7.28439</td><td>6.9324503</td><td>1.7929345 .. 83.36924</td><td>2.8661578 .. 136.46315</td><td>2.3365793 .. 152.70065</td><td>2.6167917 .. 169.7976</td><td>-0.1991595 .. 8.943009</td><td>-0.26675004 .. 15.530283</td><td>-0.17375015 .. 10.050449</td><td>-0.16860354 .. 12.066279</td><td>-0.1991595 .. 8.943009</td><td>-0.26675004 .. 15.530283</td><td>-0.17375015 .. 10.050449</td><td>-0.16860354 .. 12.066279</td><td>5254.3286 .. 51.78501</td><td>3218.978 .. 26.604462</td><td>1767.5148 .. 9.691271</td><td>486.22397 .. 2.5952268</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>7.5557785 .. 55.45823</td><td>4.264436 .. 33.605732</td><td>-3.201238 .. -26.795685</td><td>-11.259108 .. -30.212961</td><td>7.5557785 .. 55.45823</td><td>4.264436 .. 33.605732</td><td>-3.201238 .. -26.795685</td><td>-11.259108 .. -30.212961</td><td>40.17313 .. 4.201287</td><td>15.625595 .. 1.3296257</td><td>0.33043286 .. 0.024583036</td><td>0.012395947 .. 0.000922885</td><td>0.8053509</td><td>0.8643112</td><td>0.89832056</td><td>0.9216716</td><td>0.98768324</td><td>0.9924178</td><td>0.9983781</td><td>0.99938726</td><td>4</td><td>3</td><td>4</td><td>6</td><td>0</td><td>0</td><td>0</td><td>0</td><td>6.798843</td><td>9.814107</td><td>3.5114033</td><td>1.0228102</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.014635966</td><td>0.013884812</td><td>0.04122043</td><td>0.038656782</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.00093237247</td><td>0.24141891</td><td>0.99999994</td><td>1.0</td><td>0.9999999</td><td>1.0</td><td>4</td><td>3</td><td>4</td><td>5</td><td>0</td><td>0</td><td>0</td><td>2048</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.423446</td><td>1.262223</td><td>1.523291</td><td>1.4677155</td><td>2335.5513</td><td>1391.1311</td><td>308.9544</td><td>97.81459</td><td>1479.8228</td><td>810.94653</td><td>198.52147</td><td>59.83889</td><td>4.5753913</td><td>3.5604668</td><td>5.2925844</td><td>4.8279014</td><td>4.57547</td><td>3.5605273</td><td>5.2926683</td><td>4.070905</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td></td><td>0.0</td><td>0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 0</td><td>0 .. 0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 16</td><td>0 .. 16</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
<tr><td>3</td><td>10000</td><td>21606</td><td>0928m692</td><td>3644</td><td>True</td><td>8192</td><td>129</td><td>PSF</td><td>92.78882908793277</td><td>-69.14851665017197</td><td>13858959000000.0</td><td>16943370000000.0</td><td>1861.7478</td><td>3193.9226</td><td>43837.08 .. 0.0</td><td>0.07379439</td><td>57283.31326590667</td><td>59268.07856435075</td><td>GE</td><td>5279695751008126976</td><td>1.3003335</td><td>0.5740968</td><td>-0.74506813</td><td>0.7130624</td><td>1.3627695</td><td>0.9639698</td><td>2016.0</td><td>20.817247</td><td>99.491905</td><td>172</td><td>21.026443</td><td>9.564173</td><td>0</td><td>20.640682</td><td>7.5729084</td><td>0</td><td>False</td><td>0.0</td><td>0.0</td><td>0</td><td>0</td><td>0.0</td><td>False</td><td>0.0</td><td>0.0</td><td>1.0933896</td><td>1.7364924</td><td>95</td><td>4.3015213</td><td>4.6295485</td><td>4.4563084</td><td>4.3970356</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>926.8981</td><td>926.74927</td><td>251.75075</td><td>94.46215</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>3.349544</td><td>3.6049752</td><td>3.4700751</td><td>3.4239202</td><td>3.3495069</td><td>3.6049352</td><td>3.4700365</td><td>3.423882</td><td>1.3143821 .. 31.190805</td><td>1.6728723 .. 54.66553</td><td>1.1416255 .. 58.541225</td><td>1.3034669 .. 67.23993</td><td>-0.032942876 .. 3.879783</td><td>-0.046171136 .. 9.670687</td><td>-0.032774374 .. 7.0183578</td><td>-0.012071089 .. 11.460372</td><td>-0.032942876 .. 3.879783</td><td>-0.046171136 .. 9.670687</td><td>-0.032774374 .. 7.0183578</td><td>-0.012071089 .. 11.460372</td><td>2076.3816 .. 6.543746</td><td>3999.7795 .. 29.48291</td><td>1733.6534 .. 9.708909</td><td>577.8104 .. 2.4030948</td><td>0.0 .. 0.09631865</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>2.2776866 .. 42.42142</td><td>1.4591917 .. 27.440006</td><td>-4.0022893 .. 4.625561</td><td>-4.2769136 .. 41.47543</td><td>2.2776866 .. 42.42142</td><td>1.4591917 .. 27.440006</td><td>-4.0022893 .. 4.625561</td><td>-4.2769136 .. 41.47543</td><td>64.83757 .. 4.7248554</td><td>18.852259 .. 1.3727484</td><td>0.32796517 .. 0.024412338</td><td>0.012417219 .. 0.0009265517</td><td>0.80376655</td><td>0.8631655</td><td>0.8974448</td><td>0.9209881</td><td>0.9875719</td><td>0.99234915</td><td>0.9983633</td><td>0.99938166</td><td>4</td><td>3</td><td>3</td><td>6</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0.8198578</td><td>1.6131167</td><td>1.0032206</td><td>0.7844196</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.007130165</td><td>0.007151729</td><td>0.03338568</td><td>0.023207674</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.20330389</td><td>0.00012891984</td><td>0.00094950583</td><td>0.19042052</td><td>0.99988294</td><td>0.97003776</td><td>0.8094458</td><td>0.99981916</td><td>4</td><td>3</td><td>3</td><td>5</td><td>0</td><td>0</td><td>0</td><td>2048</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.423446</td><td>1.262223</td><td>1.5549465</td><td>1.4677155</td><td>2335.5513</td><td>1391.1311</td><td>266.39575</td><td>97.81459</td><td>1479.8228</td><td>810.94653</td><td>173.5426</td><td>59.83889</td><td>4.575948</td><td>3.5502062</td><td>5.2382827</td><td>4.8365474</td><td>4.5760922</td><td>3.5801198</td><td>5.4093647</td><td>4.079353</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td></td><td>0.0</td><td>0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 0</td><td>0 .. 0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 16</td><td>0 .. 16</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
<tr><td>4</td><td>10000</td><td>21606</td><td>0928m692</td><td>3647</td><td>True</td><td>8192</td><td>129</td><td>PSF</td><td>92.78952269793871</td><td>-69.1387958994378</td><td>14409476000000.0</td><td>28886644000000.0</td><td>1858.3817</td><td>3327.4915</td><td>59808.633 .. 0.0</td><td>0.07317518</td><td>57283.31326590667</td><td>59268.07856435075</td><td>GE</td><td>5279742686416267392</td><td>-0.8915288</td><td>0.40552515</td><td>0.1306394</td><td>0.5406098</td><td>0.85731494</td><td>1.7357312</td><td>2016.0</td><td>20.747555</td><td>114.866806</td><td>162</td><td>21.65588</td><td>7.766733</td><td>0</td><td>20.397083</td><td>5.1676884</td><td>0</td><td>False</td><td>0.0</td><td>1.6806109e-15</td><td>0</td><td>0</td><td>0.0</td><td>False</td><td>0.0</td><td>0.0</td><td>0.8954515</td><td>1.9916974</td><td>95</td><td>3.468565</td><td>5.590245</td><td>6.6708765</td><td>7.419922</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>1355.5065</td><td>872.0004</td><td>274.76895</td><td>73.05946</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>2.693272</td><td>4.340715</td><td>5.179804</td><td>5.761423</td><td>2.6937149</td><td>4.3414283</td><td>5.1806555</td><td>5.76237</td><td>1.0480822 .. 73.521286</td><td>2.0099716 .. 127.48353</td><td>1.782606 .. 145.57591</td><td>2.078548 .. 163.38074</td><td>-0.041219242 .. 9.795995</td><td>-0.07765031 .. 16.660069</td><td>-0.039027747 .. 11.232489</td><td>-0.013793198 .. 13.646062</td><td>-0.041219242 .. 9.795995</td><td>-0.07765031 .. 16.660069</td><td>-0.039027747 .. 11.232489</td><td>-0.013793198 .. 13.646062</td><td>7059.858 .. 53.469273</td><td>3730.3472 .. 26.958393</td><td>1835.2968 .. 10.0860815</td><td>482.82944 .. 2.678223</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>6.2135167 .. 59.95758</td><td>3.531377 .. 35.15216</td><td>-0.92712647 .. -27.9808</td><td>-7.43345 .. -41.60498</td><td>6.2135167 .. 59.95758</td><td>3.531377 .. 35.15216</td><td>-0.92712647 .. -27.9808</td><td>-7.43345 .. -41.60498</td><td>40.100945 .. 4.040845</td><td>15.733147 .. 1.3151103</td><td>0.33136323 .. 0.024576368</td><td>0.01244733 .. 0.0009234766</td><td>0.8052412</td><td>0.8642319</td><td>0.89826</td><td>0.92162436</td><td>0.98767555</td><td>0.9924131</td><td>0.998377</td><td>0.9993869</td><td>4</td><td>3</td><td>4</td><td>6</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.5222948</td><td>1.752035</td><td>1.1288128</td><td>0.6500207</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.023820776</td><td>0.019542458</td><td>0.06313007</td><td>0.045995627</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>4.8863744e-09</td><td>0.0</td><td>6.8382506e-05</td><td>0.33307713</td><td>1.0</td><td>0.9999999</td><td>0.99999994</td><td>0.99999994</td><td>4</td><td>3</td><td>4</td><td>4</td><td>0</td><td>0</td><td>0</td><td>2048</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1.423446</td><td>1.262223</td><td>1.523291</td><td>1.4677155</td><td>2335.5513</td><td>1391.1311</td><td>308.9544</td><td>77.65208</td><td>1479.8228</td><td>810.94653</td><td>198.52147</td><td>49.08919</td><td>4.5763483</td><td>3.5592587</td><td>5.2900586</td><td>4.8293376</td><td>4.5764275</td><td>3.55932</td><td>5.290142</td><td>3.2327316</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td></td><td>0.0</td><td>0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 0</td><td>0 .. 0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0.0 .. 0.0</td><td>0 .. 16</td><td>0 .. 16</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr>
</table><style>table.dataTable {clear: both; width: auto !important; margin: 0 !important;}
.dataTables_info, .dataTables_length, .dataTables_filter, .dataTables_paginate{
display: inline-block; margin-right: 1em; }
.paginate_button { margin-right: 5px; }
</style>
<script>

var astropy_sort_num = function(a, b) {
    var a_num = parseFloat(a);
    var b_num = parseFloat(b);

    if (isNaN(a_num) && isNaN(b_num))
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    else if (!isNaN(a_num) && !isNaN(b_num))
        return ((a_num < b_num) ? -1 : ((a_num > b_num) ? 1 : 0));
    else
        return isNaN(a_num) ? -1 : 1;
}

require.config({paths: {
    datatables: 'https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min'
}});
require(["datatables"], function(){
    console.log("$('#table10890412688-736767').dataTable()");
    
jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "optionalnum-asc": astropy_sort_num,
    "optionalnum-desc": function (a,b) { return -astropy_sort_num(a, b); }
});

    $('#table10890412688-736767').dataTable({
        order: [],
        pageLength: 50,
        lengthMenu: [[10, 25, 50, 100, 500, 1000, -1], [10, 25, 50, 100, 500, 1000, 'All']],
        pagingType: "full_numbers",
        columnDefs: [{targets: [0, 1, 2, 4, 6, 7, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 38, 39, 40, 41, 42, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207], type: "optionalnum"}]
    });
});
</script>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gcat</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;flux_g&#39;</span><span class="p">])</span> <span class="c1"># nanomaggy to magnitude</span>
<span class="n">rcat</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;flux_r&#39;</span><span class="p">])</span>

<span class="n">xcat</span><span class="p">,</span> <span class="n">ycat</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">celestial</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">cat</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcat</span>
<span class="n">cat</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ycat</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgbimg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xcat</span><span class="p">,</span> <span class="n">ycat</span><span class="p">,</span> <span class="s1">&#39;xr&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;x_fit_g&#39;</span><span class="p">],</span> <span class="n">grtbl</span><span class="p">[</span><span class="s1">&#39;y_fit_g&#39;</span><span class="p">],</span> <span class="s1">&#39;+b&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (pixel)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (pixel)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgbimg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gmag</span><span class="o">-</span><span class="n">rmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">gcat</span><span class="o">-</span><span class="n">rcat</span><span class="p">,</span> <span class="n">rcat</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$g-r$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$r$&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/3953004836.py:4: RuntimeWarning: invalid value encountered in log10
  return -2.5*np.log10(flux) + zp
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(23.0, 15.0)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/9b91286c64e523f05e38e7fc8f36b84c07b001b1b443bae0130131d83bc3bdef.png"><img alt="../_images/9b91286c64e523f05e38e7fc8f36b84c07b001b1b443bae0130131d83bc3bdef.png" class="align-center" src="../_images/9b91286c64e523f05e38e7fc8f36b84c07b001b1b443bae0130131d83bc3bdef.png" style="width: 886px; height: 468px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s match the stars in the catalog with the stars of our photometry</span>
<span class="n">cmtbl_r</span> <span class="o">=</span> <span class="n">match_stars</span><span class="p">(</span><span class="n">rtbl</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;our&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">],</span> <span class="n">refcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">],</span>
                    <span class="n">objcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_r&#39;</span><span class="p">],</span> <span class="n">rlim</span><span class="o">=</span><span class="n">rlim</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and compare the magnitude</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">crmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_r</span><span class="p">[</span><span class="s1">&#39;flux_r&#39;</span><span class="p">])</span> <span class="c1"># catalog r-band magnitude</span>
<span class="n">ormag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_r</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span> <span class="c1"># our r-band magnitude</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">crmag</span><span class="p">,</span> <span class="n">ormag</span><span class="p">,</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">14.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">14.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;catalog r-band magnitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;our r-band magnitude&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">ormag</span> <span class="o">-</span> <span class="n">crmag</span>
<span class="n">offset</span><span class="p">,</span> <span class="n">scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;offset = </span><span class="si">{</span><span class="n">offset</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1"> scatter = </span><span class="si">{</span><span class="n">scatter</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/3953004836.py:4: RuntimeWarning: invalid value encountered in log10
  return -2.5*np.log10(flux) + zp
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.95, 0.05, &#39;offset = 0.16\n scatter = 0.56&#39;)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ecdfccb9d00c22f9c234a0f29efb619f30d37eb821e6936e6bd832f761db62fd.png"><img alt="../_images/ecdfccb9d00c22f9c234a0f29efb619f30d37eb821e6936e6bd832f761db62fd.png" class="align-center" src="../_images/ecdfccb9d00c22f9c234a0f29efb619f30d37eb821e6936e6bd832f761db62fd.png" style="width: 469px; height: 460px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># doing the same thing in gz-band</span>
<span class="n">cmtbl_g</span> <span class="o">=</span> <span class="n">match_stars</span><span class="p">(</span><span class="n">gtbl</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;our&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">],</span> <span class="n">refcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">],</span>
                      <span class="n">objcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_g&#39;</span><span class="p">],</span> <span class="n">rlim</span><span class="o">=</span><span class="n">rlim</span><span class="p">)</span>
<span class="n">cmtbl_z</span> <span class="o">=</span> <span class="n">match_stars</span><span class="p">(</span><span class="n">ztbl</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;our&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">],</span> <span class="n">refcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;y_fit&#39;</span><span class="p">],</span>
                      <span class="n">objcard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_z&#39;</span><span class="p">],</span> <span class="n">rlim</span><span class="o">=</span><span class="n">rlim</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cgmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_g</span><span class="p">[</span><span class="s1">&#39;flux_g&#39;</span><span class="p">])</span> <span class="c1"># catalog g-band magnitude</span>
<span class="n">ogmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_g</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span> <span class="c1"># our g-band magnitude</span>
<span class="n">czmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_z</span><span class="p">[</span><span class="s1">&#39;flux_z&#39;</span><span class="p">])</span> <span class="c1"># catalog z-band magnitude</span>
<span class="n">ozmag</span> <span class="o">=</span> <span class="n">flux2mag</span><span class="p">(</span><span class="n">cmtbl_z</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span> <span class="c1"># our z-band magnitude</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmag</span><span class="p">,</span> <span class="n">omag</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="n">cgmag</span><span class="p">,</span> <span class="n">crmag</span><span class="p">,</span> <span class="n">czmag</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">ogmag</span><span class="p">,</span> <span class="n">ormag</span><span class="p">,</span> <span class="n">ozmag</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmag</span><span class="p">,</span> <span class="n">omag</span><span class="p">,</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">14.5</span><span class="p">,</span> <span class="mi">22</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">14.5</span><span class="p">,</span> <span class="mi">22</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;catalog </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">-band magnitude&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;our </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">-band magnitude&#39;</span><span class="p">)</span>
    
    <span class="n">diff</span> <span class="o">=</span> <span class="n">omag</span> <span class="o">-</span> <span class="n">cmag</span>
    <span class="n">offset</span><span class="p">,</span> <span class="n">scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;offset = </span><span class="si">{</span><span class="n">offset</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1"> scatter = </span><span class="si">{</span><span class="n">scatter</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/c3/0f663kw90xldstvklyr5nq9c0000gn/T/ipykernel_6485/3953004836.py:4: RuntimeWarning: invalid value encountered in log10
  return -2.5*np.log10(flux) + zp
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/88a3295a8268b82450e47f27330604cde0103f40122302cebe3d50180c001dd4.png"><img alt="../_images/88a3295a8268b82450e47f27330604cde0103f40122302cebe3d50180c001dd4.png" class="align-center" src="../_images/88a3295a8268b82450e47f27330604cde0103f40122302cebe3d50180c001dd4.png" style="width: 1257px; height: 468px;" />
</a>
</div>
</div>
<p>There are systematic offsets between cataloged magnitude and our PSF magnitude,
for each band. What made these offsets? Who derived more correct result? There
are many possible reasons of the offsets one can think of:</p>
<ul class="simple">
<li><p>Difference in aperture correction process between our method and <code class="docutils literal notranslate"><span class="pre">Tractor</span></code>,
which is the tool for extracting PSF magnitude in DESI Legacy Survey catalog.</p></li>
<li><p>Difference in PSF model - only a percent level error in PSF model can 10~100%
errors of the faint star near the bright stars. The systematic offset in PSF
model can derive the systematic offsets in the magnitude.</p></li>
<li><p>Difference in the background subtraction</p></li>
<li><p>And many more -</p></li>
</ul>
<p>One possible way to resolve the cause of the offset is compare the PSF
photometry at the un-crowded field, to find out how the crowding affects the
resulting magnitudes. Another way is simulate a star inside the image and
repeat the photometry over, and compare the input with the magnitudes from the
PSF photometry, which is called <em>the artificial star test</em>.</p>
<p>I will leave this task to the reader.</p>
<hr class="docutils" />
<p>To compare with another reference with the <span class="math notranslate nohighlight">\(BV\)</span> magnitude, we need a
transformation relation of our <span class="math notranslate nohighlight">\(gr\)</span> magnitude into <span class="math notranslate nohighlight">\(BV\)</span> magnitude.</p>
<p>Transformation from DECam <span class="math notranslate nohighlight">\(griz\)</span> to Johnson-Cousins (<span class="math notranslate nohighlight">\(UBV R_C I_C\)</span>) system</p>
<ul class="simple">
<li><p><a class="reference external" href="https://des.ncsa.illinois.edu/releases/dr2/dr2-docs/dr2-transformations">DES Photometric Transformations</a></p></li>
</ul>
<div class="math notranslate nohighlight">
\[B = g_{\rm DES} + 0.371 (g-r)_{\rm DES} + 0.197 \ \ [-0.5 &lt; (g-r)_{\rm DES} ≤ 0.2] \ \ ({\rm RMS}: 0.022 {\rm mag})\]</div>
<div class="math notranslate nohighlight">
\[B = g_{\rm DES} + 0.542 (g-r)_{\rm DES} + 0.141 \ \ [ 0.2 &lt; (g-r)_{\rm DES} ≤ 0.7] \ \ ({\rm RMS}: 0.017 {\rm mag})\]</div>
<div class="math notranslate nohighlight">
\[B = g_{\rm DES} + 0.454 (g-r)_{\rm DES} + 0.200 \ \ [ 0.7 &lt; (g-r)_{\rm DES} ≤ 1.8] \ \ ({\rm RMS}: 0.059 {\rm mag})\]</div>
<div class="math notranslate nohighlight">
\[V = g_{\rm DES} - 0.465 (g-r)_{\rm DES} - 0.020 \ \ [-0.5 &lt; (g-r)_{\rm DES} ≤ 0.2] \ \ ({\rm RMS}: 0.012 {\rm mag})\]</div>
<div class="math notranslate nohighlight">
\[V = g_{\rm DES} - 0.496 (g-r)_{\rm DES} - 0.015 \ \ [ 0.2 &lt; (g-r)_{\rm DES} ≤ 0.7] \ \ ({\rm RMS}: 0.011 {\rm mag})\]</div>
<div class="math notranslate nohighlight">
\[V = g_{\rm DES} - 0.445 (g-r)_{\rm DES} - 0.062 \ \ [ 0.7 &lt; (g-r)_{\rm DES} ≤ 1.8] \ \ ({\rm RMS}: 0.024 {\rm mag})\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Bmag</span><span class="p">(</span><span class="n">gmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gmag</span><span class="p">)</span>
    <span class="n">gmr</span> <span class="o">=</span> <span class="n">gmag</span> <span class="o">-</span> <span class="n">rmag</span>
    <span class="n">blu</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">grn</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">1.8</span><span class="p">)</span>
    <span class="n">B</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.371</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.197</span>
    <span class="n">B</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.542</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.141</span>
    <span class="n">B</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.454</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.200</span>
    <span class="k">return</span> <span class="n">B</span>

<span class="k">def</span> <span class="nf">Vmag</span><span class="p">(</span><span class="n">gmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">):</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gmag</span><span class="p">)</span>
    <span class="n">gmr</span> <span class="o">=</span> <span class="n">gmag</span> <span class="o">-</span> <span class="n">rmag</span>
    <span class="n">blu</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">grn</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gmr</span> <span class="o">&lt;=</span> <span class="mf">1.8</span><span class="p">)</span>
    <span class="n">V</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.465</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">blu</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.020</span>
    <span class="n">V</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.496</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">grn</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span>
    <span class="n">V</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmag</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.445</span><span class="o">*</span><span class="n">gmr</span><span class="p">[</span><span class="n">red</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.062</span>
    <span class="k">return</span> <span class="n">V</span>

<span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">Bmag</span><span class="p">(</span><span class="n">gmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">),</span> <span class="n">Vmag</span><span class="p">(</span><span class="n">gmag</span><span class="p">,</span> <span class="n">rmag</span><span class="p">)</span>

<span class="c1"># let&#39;s compare the color-magnitude diagram of ours to the reference</span>
<span class="c1"># reference: Peter Stetson&#39;s stellar standards and software - Homogeneous photometry</span>
<span class="c1"># one can download the data from https://www.cadc.hia.nrc.gc.ca/en/community/STETSON/homogeneous/</span>

<span class="c1"># read the reference data</span>
<span class="n">reftbl</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">DATADIR</span><span class="o">/</span><span class="s1">&#39;stetson&#39;</span><span class="o">/</span><span class="s1">&#39;NGC2210.dat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.fixed_width_two_line&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the color-magnitude diagram</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">reftbl</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">reftbl</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">],</span> <span class="n">reftbl</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stetson&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">B</span><span class="o">-</span><span class="n">V</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Our result&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">14.5</span><span class="p">,</span> <span class="mi">22</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$B-V$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$V$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x176307f20&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/da743e0322fa1da5eda59d0cbf67e86ecd1232db59798f374a5b1ccf2c647f19.png"><img alt="../_images/da743e0322fa1da5eda59d0cbf67e86ecd1232db59798f374a5b1ccf2c647f19.png" class="align-center" src="../_images/da743e0322fa1da5eda59d0cbf67e86ecd1232db59798f374a5b1ccf2c647f19.png" style="width: 640px; height: 614px;" />
</a>
</div>
</div>
<p>From the color-magnitude diagram we obtained, which properties of this system
will you be able to find out?</p>
<ul class="simple">
<li><p>Properties of stars inside this field</p></li>
<li><p>Properties of the globular cluster NGC 2210</p></li>
<li><p>Is our photometry reliable?</p></li>
<li><p>etc</p></li>
</ul>
</section>
<section id="further-readings">
<h2>Further Readings<a class="headerlink" href="#further-readings" title="Link to this heading">#</a></h2>
<ul>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1987PASP...99..191S/abstract">Stetson (1987PASP…99…191S)</a>, DAOPHOT: A Computer Program for Crowded-Field Stellar Photometry</p>
<p>Seminal paper about how to find stars and do photometry from a CCD image over crowded field</p>
</li>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2000PASP..112.1360A/abstract">Anderson &amp; King (2000PASP…112.1360A)</a>, Toward High-Precision Astrometry with WFPC2. I. Deriving an Accurate Point-Spread Function</p>
<p>This work describes how the effective point-spread function is estimated.</p>
</li>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2019MNRAS.485.3042S/abstract">Stetson et al. (2019MNRAS.485.3042S)</a>, Homogeneous photometry - VII. Globular clusters in the Gaia era</p>
<p>Modern homogeneous photometry given by Peter Stetson, especially for the globular clusters, by conducting the PSF photometry.</p>
</li>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023MNRAS.tmp..617B/abstract">Baumgardt et al. (2023MNRAS.521.3991B)</a>, Evidence for a bottom-light initial mass function in massive star clusters</p>
<p>This reference may gave you some idea about how member stars in a cluster can be identified.</p>
</li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Preparation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Preparation</p>
      </div>
    </a>
    <a class="right-next"
       href="data/proj3/run_SExtractor.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SExtractor Photometry of MACS 0717</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-lists">Reading lists</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-photometry-an-overview">PSF photometry - an overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#caveat">Caveat</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reading-and-background-subtraction">1. Data Reading and Background Subtraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-of-stars-for-the-psf-estimation">2. Selection of Stars for the PSF Estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-effective-psf">3. Derive Effective PSF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#substar-subtract-adjacent-stars-and-reconstruct-epsf">SUBSTAR - subtract adjacent stars and reconstruct EPSF</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-photometry-with-the-epsf">4. PSF Photometry with the EPSF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterations-over-all-bands">5. Iterations Over All Bands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#match-the-results-of-each-band">6. Match the Results of Each Band</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#color-magnitude-diagram">7. Color-Magnitude Diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-with-the-references">8. Comparison with the References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-readings">Further Readings</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Hyeonguk Bahk
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Hyeonguk Bahk.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>