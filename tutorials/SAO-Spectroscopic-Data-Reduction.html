
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Concept of spectroscopy &#8212; TAO Tutorials  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3c32ad28" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/SAO-Spectroscopic-Data-Reduction';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Specutils: An Astropy package for spectroscopy" href="Optical%20Spectroscopy.html" />
    <link rel="prev" title="Preprocessing the CCD images" href="Preprocessing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TAO Tutorials</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">SNU TAO Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Preparation.html">Preparation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="PSF_photometry.html">PSF photometry of NGC 2210</a></li>
<li class="toctree-l1"><a class="reference internal" href="data/proj3/run_SExtractor.html">SExtractor Photometry of MACS 0717</a></li>
<li class="toctree-l1"><a class="reference internal" href="GALFIT-Surface_Photometry.html">Surface Photometry Using GALFIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spectroscopic_data_reduction.html">Spectroscopic Data Reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Preprocessing.html">Preprocessing the CCD images</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Concept of spectroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Optical%20Spectroscopy.html">Specutils: An Astropy package for spectroscopy</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/hbahk/TAOTutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/SAO-Spectroscopic-Data-Reduction.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Concept of spectroscopy</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing-i-e-bias-subtraction-dark-subtraction-flat-fielding">1. Preprocessing  (i.e., Bias subtraction, Dark subtraction, Flat fielding)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-bias">1.1 Making master bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-readout-noise-rn">1.2 Derive Readout Noise (RN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-dark">1.3 Making Master Dark</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-flat">1.4 Making Master Flat</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-whether-flat-image-is-shifted-or-not">1.4-1 Checking whether Flat image is shifted or not</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-with-the-standard-star-profile">Comparing with the Standard Star Profile</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#median-combine-flat-image-to-make-master-flat">1.4-2 Median combine flat image to make Master Flat</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#master-calibration-image">1.5 Master Calibration image</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-wavelength-calibration-image-shift">Check wavelength Calibration image shift</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#median-combine-comparison-lamp-image">Median combine Comparison Lamp image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bias-subtraction-dark-subtraction-pre-processing">1.6 Bias subtraction &amp; Dark subtraction (Pre-Processing)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spectroscopic-data-reduction">2. Spectroscopic data reduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-the-spectrum">2-1. Extract the Spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#identification-of-objects-peak-set-the-area-of-background">Identification of Object’s peak &amp; Set the area of background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-tracing-aperture-sum-for-standard-star">Aperture tracing &amp; aperture sum for standard star</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wavelength-calibration">2-2. Wavelength calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-calibration">3. Flux calibration</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="concept-of-spectroscopy">
<h1>Concept of spectroscopy<a class="headerlink" href="#concept-of-spectroscopy" title="Link to this heading">#</a></h1>
<p>Author: Jooyeon Geem, Hyeonguk Bahk</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
<span class="c1"># %matplotlib widget</span>
<span class="c1"># %matplotlib notebook</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span><span class="n">Column</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">peak_local_max</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">gaussian_fwhm_to_sigma</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial.chebyshev</span> <span class="kn">import</span> <span class="n">chebfit</span><span class="p">,</span> <span class="n">chebval</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">Gaussian1D</span><span class="p">,</span> <span class="n">Chebyshev2D</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span><span class="p">,</span> <span class="n">rcParams</span><span class="p">,</span> <span class="n">rc</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define your working directory</span>
<span class="n">HOME</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
<span class="n">WD</span> <span class="o">=</span> <span class="n">HOME</span><span class="o">/</span><span class="s1">&#39;class&#39;</span><span class="o">/</span><span class="s1">&#39;ao22&#39;</span><span class="o">/</span><span class="s1">&#39;SNU_AO22-2&#39;</span><span class="o">/</span><span class="s1">&#39;_test&#39;</span>
<span class="n">SUBPATH</span> <span class="o">=</span> <span class="n">WD</span><span class="o">/</span><span class="s1">&#39;data&#39;</span>

<span class="n">Biaslist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;calibration*bias.fit&#39;</span><span class="p">)))</span>

<span class="n">Darklist</span><span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;calibration*dk*.fit&#39;</span><span class="p">)))</span>

<span class="n">Flatlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;Flat*.fit&#39;</span><span class="p">)))</span>

<span class="n">Complist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;Neon*L.fit&#39;</span><span class="p">)))</span>

<span class="n">Objectlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;61Cygni*.fit&#39;</span><span class="p">)))</span>

<span class="n">Standlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span> <span class="s1">&#39;HR153*.fit&#39;</span><span class="p">)))</span>

<span class="c1"># Checking the paths</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Biaslist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bias&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Darklist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Darklist&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Flatlist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Flatlist&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Complist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Complist&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Objectlist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Objectlist&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Table</span><span class="p">([</span><span class="n">Standlist</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Standlist&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 Bias                                 
----------------------------------------------------------------------
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008bias.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009bias.fit 


                               Darklist                               
----------------------------------------------------------------------
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008dk60.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009dk1.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009dk10.fit
 /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009dk2.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009dk60.fit 


                          Flatlist                         
-----------------------------------------------------------
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0001.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0002.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0003.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0004.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0005.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0006.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0007.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0008.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Flat-0009.fit 


                          Complist                          
------------------------------------------------------------
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Neon-0001L.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Neon-0002L.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Neon-0003L.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Neon-0004L.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Neon-0005L.fit 


                          Objectlist                          
--------------------------------------------------------------
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/61Cygni-0001.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/61Cygni-0002.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/61Cygni-0003.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/61Cygni-0004.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/61Cygni-0005.fit 


                         Standlist                          
------------------------------------------------------------
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/HR153-0001.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/HR153-0002.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/HR153-0003.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/HR153-0004.fit
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/HR153-0005.fit 
</pre></div>
</div>
</div>
</div>
<section id="preprocessing-i-e-bias-subtraction-dark-subtraction-flat-fielding">
<h2>1. Preprocessing  (i.e., Bias subtraction, Dark subtraction, Flat fielding)<a class="headerlink" href="#preprocessing-i-e-bias-subtraction-dark-subtraction-flat-fielding" title="Link to this heading">#</a></h2>
<section id="making-master-bias">
<h3>1.1 Making master bias<a class="headerlink" href="#making-master-bias" title="Link to this heading">#</a></h3>
<p>Before making master bias, we have to check whethere there is a peculiar bias image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checking the bias image</span>
<span class="n">Name</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Min</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Max</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Std</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>  <span class="c1"># Change datatype from uint16 to float64</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">minimum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mean</span><span class="p">,</span><span class="n">minimum</span><span class="p">,</span><span class="n">maximum</span><span class="p">)</span>
    
    <span class="n">Name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">Mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mean</span> <span class="p">)</span>
    <span class="n">Min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">minimum</span><span class="p">)</span>
    <span class="n">Max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maximum</span><span class="p">))</span>
    <span class="n">Std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">Name</span><span class="p">,</span> <span class="n">Mean</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Std</span><span class="p">],</span>
              <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Filename&#39;</span><span class="p">,</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span><span class="s1">&#39;Min&#39;</span><span class="p">,</span><span class="s1">&#39;Max&#39;</span><span class="p">,</span><span class="s1">&#39;Std&#39;</span><span class="p">])</span>    
<span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>    
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0001bias.fit 152.78639256198346 111.0 190.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0002bias.fit 152.8369297520661 121.0 198.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0003bias.fit 152.9803347107438 118.0 188.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0004bias.fit 152.98019008264464 116.0 193.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0005bias.fit 152.91122727272727 112.0 191.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006bias.fit 152.86499586776858 114.0 191.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0007bias.fit 152.9045123966942 118.0 196.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0008bias.fit 152.873347107438 118.0 189.0
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0009bias.fit 152.9414173553719 121.0 193.0
        Filename          Mean   Min    Max   Std 
------------------------ ------ ------ ------ ----
calibration-0001bias.fit 152.79 111.00 190.00 4.80
calibration-0002bias.fit 152.84 121.00 198.00 4.80
calibration-0003bias.fit 152.98 118.00 188.00 4.78
calibration-0004bias.fit 152.98 116.00 193.00 4.80
calibration-0005bias.fit 152.91 112.00 191.00 4.83
calibration-0006bias.fit 152.86 114.00 191.00 4.80
calibration-0007bias.fit 152.90 118.00 196.00 4.81
calibration-0008bias.fit 152.87 118.00 189.00 4.82
calibration-0009bias.fit 152.94 121.00 193.00 4.79
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the Sample image of bias image</span>
<span class="n">File</span> <span class="o">=</span> <span class="n">Biaslist</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># pick one of the bias image</span>
<span class="n">sample_hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">sample_hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">40</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">40</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_data</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/calibration-0006bias.fit&#39;)
</pre></div>
</div>
<img alt="../_images/f06759808b0435a5aa008ba6267c852836562fa0dc2ef6e0b1af9e33c0c0eeec.png" class="align-center" src="../_images/f06759808b0435a5aa008ba6267c852836562fa0dc2ef6e0b1af9e33c0c0eeec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Median combine Bias image    </span>
    
<span class="n">Master_bias</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">bias_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">bias_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bias_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">Master_bias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_data</span><span class="p">)</span>
<span class="n">MASTER_Bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">Master_bias</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="c1"># Let&#39;s make Master bias image fits file</span>

<span class="c1"># Making header part</span>
<span class="n">bias_header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># fetch header from one of bias images</span>
<span class="n">bias_header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bias&#39;</span>
<span class="c1"># - add information about the combine process to header comment</span>
<span class="n">bias_header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Biaslist</span><span class="si">}</span><span class="s1"> bias images are median combined on &#39;</span> \
                          <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>


<span class="n">SAVE_bias</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Bias.fits&#39;</span>  <span class="c1"># path to save master bias</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SAVE_bias</span><span class="p">,</span> <span class="n">MASTER_Bias</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">bias_header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Plot Master bias </span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                  <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample Bias image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">MASTER_Bias</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Master Bias image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7f9578140520&gt;
</pre></div>
</div>
<img alt="../_images/ba56a1e38b3c8b703265691ea579b69076ad38f9824bcab3cd6771a494829542.png" class="align-center" src="../_images/ba56a1e38b3c8b703265691ea579b69076ad38f9824bcab3cd6771a494829542.png" />
</div>
</div>
</section>
<section id="derive-readout-noise-rn">
<h3>1.2 Derive Readout Noise (RN)<a class="headerlink" href="#derive-readout-noise-rn" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s derive RN</span>

<span class="c1"># The following is just to give you an idea about the calculation</span>
<span class="c1"># - Bring Bias1 data</span>
<span class="n">hdul1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
<span class="n">bias1</span> <span class="o">=</span> <span class="n">hdul1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>            
<span class="n">bias1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bias1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># - Bring Bias2 data</span>
<span class="n">hdul2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">bias2</span> <span class="o">=</span> <span class="n">hdul2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">bias2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bias2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># - Derive the differential image</span>
<span class="n">dbias</span> <span class="o">=</span> <span class="n">bias2</span> <span class="o">-</span> <span class="n">bias1</span>

<span class="c1"># - Bring Gain </span>
<span class="n">gain</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1">#e/ADU</span>

<span class="c1"># - Calculate RN</span>
<span class="n">RN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dbias</span><span class="p">)</span><span class="o">*</span><span class="n">gain</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Readout Noise is </span><span class="si">{</span><span class="n">RN</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>



<span class="c1"># Let&#39;s do it for all bias data</span>
<span class="n">Name</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">RN</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">hdul1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">bias1</span> <span class="o">=</span> <span class="n">hdul1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">bias1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bias1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">hdul2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Biaslist</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bias2</span> <span class="o">=</span> <span class="n">hdul2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">bias2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bias2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">dbias</span> <span class="o">=</span> <span class="n">bias2</span> <span class="o">-</span> <span class="n">bias1</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dbias</span><span class="p">)</span><span class="o">*</span><span class="n">gain</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">RN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dbias</span><span class="p">)</span><span class="o">*</span><span class="n">gain</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">mean RN:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RN</span><span class="p">))</span>    
<span class="n">RN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Readout Noise is 6.33
0 st 6.327328539930154
1 st 6.340204240265304
2 st 6.339680597614822
3 st 6.341643681666518
4 st 6.360511037222893
5 st 6.351511335524966
6 st 6.344696431761455
7 st 6.364776809710108

mean RN: 6.346294084212028
</pre></div>
</div>
</div>
</div>
</section>
<section id="making-master-dark">
<h3>1.3 Making Master Dark<a class="headerlink" href="#making-master-dark" title="Link to this heading">#</a></h3>
<p>Master dark = median combine([Dark image1 - master bias, Dark image2 - master bias, Dark image3 - master bias,…])</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checking what exposure time is taken</span>
<span class="n">exptime</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Darklist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Darklist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>  <span class="c1"># get exposure time from its header </span>
    <span class="n">exptime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="n">exptime</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exptime</span><span class="p">)</span>  <span class="c1"># only unique elements will be remained</span>
<span class="n">exptime</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exptime</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">exptime</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.0, 2.0, 10.0, 60.0]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring master bias</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">SAVE_bias</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mbias</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># Making master dark image for each exposure time</span>
<span class="k">for</span> <span class="n">exp_i</span> <span class="ow">in</span> <span class="n">exptime</span><span class="p">:</span>
    <span class="n">Master_dark</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Darklist</span><span class="p">)):</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Darklist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">exp</span> <span class="o">==</span> <span class="n">exp_i</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">bdata</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">Mbias</span>  <span class="c1"># bias subtracting</span>
            <span class="n">Master_dark</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span>
            
    <span class="n">MASTER_dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">Master_dark</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># median combine bias-subtracted dark frames</span>
    
    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bias_subtraction is done&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Master_dark</span><span class="p">)</span><span class="si">}</span><span class="s1"> dark images are median combined on &#39;</span>\
                         <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>
    
    <span class="n">SAVE_dark</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;Master_Dark_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exp_i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;s.fits&#39;</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SAVE_dark</span><span class="p">,</span> <span class="n">MASTER_dark</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">exp_i</span> <span class="p">,</span><span class="s1">&#39;s is done!&#39;</span><span class="p">,</span> <span class="n">SAVE_dark</span><span class="p">,</span><span class="s1">&#39; is made.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0 s is done! /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Master_Dark_1.0s.fits  is made.
2.0 s is done! /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Master_Dark_2.0s.fits  is made.
10.0 s is done! /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Master_Dark_10.0s.fits  is made.
60.0 s is done! /Users/hbahk/class/ao22/SNU_AO22-2/_test/data/Master_Dark_60.0s.fits  is made.
</pre></div>
</div>
</div>
</div>
</section>
<section id="making-master-flat">
<h3>1.4 Making Master Flat<a class="headerlink" href="#making-master-flat" title="Link to this heading">#</a></h3>
<section id="checking-whether-flat-image-is-shifted-or-not">
<h4>1.4-1 Checking whether Flat image is shifted or not<a class="headerlink" href="#checking-whether-flat-image-is-shifted-or-not" title="Link to this heading">#</a></h4>
<p>The flat image could shift little by little depending on where the telescope is pointing. Because different images may have different flats to use, it can be dangerous to median combine all the flats image taken overnight. Let’s do <strong>quick</strong> and <strong>rough</strong> check whethere there is flat shift.</p>
<p>By using local peak location, I will check whether there was the flat shift or not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the flat image</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">[</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flat image&#39;</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="c1"># Standard star image</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Standlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standard star image&#39;</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7f95aafac460&gt;
</pre></div>
</div>
<img alt="../_images/5be2a300598894de15ba7b402184431ec50bfb33b9ce4dfafa53b3fcab8372a9.png" class="align-center" src="../_images/5be2a300598894de15ba7b402184431ec50bfb33b9ce4dfafa53b3fcab8372a9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checking intensity profile through the dispersion axis</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument intensity&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis [pixel]&#39;</span><span class="p">)</span>

<span class="n">hdul_std</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Standlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data_std</span> <span class="o">=</span> <span class="n">hdul_std</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_std</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Standlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument intensity&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis [pixel]&#39;</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;Dispersion axis [pixel]&#39;)
</pre></div>
</div>
<img alt="../_images/57ce122c84288724d873e27f424b17f4df2e65ddba50f414d0f5ac4cee5d2eb9.png" class="align-center" src="../_images/57ce122c84288724d873e27f424b17f4df2e65ddba50f414d0f5ac4cee5d2eb9.png" />
</div>
</div>
</section>
<section id="comparing-with-the-standard-star-profile">
<h4>Comparing with the Standard Star Profile<a class="headerlink" href="#comparing-with-the-standard-star-profile" title="Link to this heading">#</a></h4>
<p>The above flat spectra shows many wiggles and bumps. Yet, we don’t know if these features are originated from the grating, which in turn will affect our science frame equally. If they are not due to the grating, such as filters in front of the flat-field lamp, the extreme difference in color temperature between the lamps and the object of interest, or wavelength-dependent variations in the reflectivity of the paint used for the flat-field screen (<a class="reference external" href="https://arxiv.org/abs/1010.5270">Massey &amp; Hansen, 2010</a>), they are not going to present on the science frame.</p>
<p>Let’s see if a supposedly smooth source (in this case, a standard star) has same “wiggles” and “bumps” on its spectrum. If this is the case, we should model the flat lamp with “high order” and normalize the flat image with this model. If not, we should adopt “low-order” model or constant to normalize our flat field.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>    <span class="c1"># Moving box averaging</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="n">width</span>
    <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_smooth</span>   

<span class="n">smoothing_size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">smoother</span> <span class="o">=</span> <span class="n">median_filter</span>

<span class="n">Coor_shift</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="n">sflat</span> <span class="o">=</span> <span class="n">smoother</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">smoothing_size</span><span class="p">)</span>
    <span class="n">nor_flat</span> <span class="o">=</span> <span class="n">flat</span><span class="o">/</span><span class="n">sflat</span>  <span class="c1"># flat field normalized by smoothed curve</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sflat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">flat</span><span class="o">-</span><span class="n">sflat</span><span class="p">)</span><span class="o">/</span><span class="n">sflat</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># ax[2].legend(fontsize=8)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Let&#39;s see if a supposedly smooth source (in this case, a standard star)</span>
<span class="c1"># has same &quot;wiggles&quot; and &quot;bumps&quot; on its spectrum. If this is the case, we should</span>
<span class="c1"># model the flat lamp with &quot;high order&quot; and normalize the flat image with the model.</span>
<span class="c1"># If not, we </span>
<span class="n">sstd</span> <span class="o">=</span> <span class="n">smoother</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">smoothing_size</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Standard star&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sstd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">std</span><span class="o">-</span><span class="n">sstd</span><span class="p">)</span><span class="o">/</span><span class="n">sstd</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Fringe pattern due to the grating&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> 
               <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
               <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-[, widthB=10.0, lengthB=1.5&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Bump not originated </span><span class="se">\n</span><span class="s1"> from the grating&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">530</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
               <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
               <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.05</span><span class="p">),</span>
               <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flat profile&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Std profile&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized flat profile&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized std profile&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Normalized std profile&#39;)
</pre></div>
</div>
<img alt="../_images/3dae8a7fa45605d402ec5f6f098d4a9a2ba0393031bfa7c7d50ec1fb6d0b381f.png" class="align-center" src="../_images/3dae8a7fa45605d402ec5f6f098d4a9a2ba0393031bfa7c7d50ec1fb6d0b381f.png" />
</div>
</div>
</section>
</section>
<section id="median-combine-flat-image-to-make-master-flat">
<h3>1.4-2 Median combine flat image to make Master Flat<a class="headerlink" href="#median-combine-flat-image-to-make-master-flat" title="Link to this heading">#</a></h3>
<p>Note that in our flat frame, both grating-originated wiggles and the lamp-originated bump can be found. Thus we need to account for these effect simultaneously in order to appropriately flat-field our science frame. However, this will be very cumbersome because we need to model our flat spectrum in different regions.</p>
<p>So here we just adopt smoothed flat spectrum with large smoothing scale to normalize the flat (this will effectively play a role of “low-order” fitting), ignoring the bump of the lamp. This will make reduced science spectrum have the bump feature at same location on the dispersion axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring Master bias &amp; Dark</span>

<span class="n">biasfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Bias.fits&#39;</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">biasfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mbias</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="n">darkfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Dark_10.0s.fits&#39;</span> <span class="c1"># check the exposure time for your flat frames</span>
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">darkfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mdark</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>


<span class="c1"># Make master Flat image</span>
<span class="n">Master_flat</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Flatlist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    
    <span class="n">bdata</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">Mbias</span>    <span class="c1"># bias subtraction</span>
    <span class="n">dbdata</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">-</span> <span class="n">Mdark</span>  <span class="c1"># dark subtraction</span>
    <span class="n">Master_flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbdata</span><span class="p">)</span>
    
<span class="n">MASTER_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">Master_flat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bias_subtraction is done&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>
<span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Master_dark</span><span class="p">)</span><span class="si">}</span><span class="s1"> dark images are median combined on &#39;</span>\
                    <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;with &#39;</span><span class="o">+</span><span class="s1">&#39; Master_Dark_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;s.fits&#39;</span>

<span class="c1"># normalizing master flat image</span>
<span class="n">flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">MASTER_flat</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Master flat&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1"># ax[0].set_xlim(200,1500)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">HIGH_WINDOW_LIM</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">620</span><span class="p">]</span> <span class="c1"># range limit for low- and high-order median filtering</span>
<span class="n">flat_low1</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[:</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">flat_low2</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>
<span class="n">flat_high</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

<span class="n">sflat_low1</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_low1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># low-order filtering (left)</span>
<span class="n">sflat_low2</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_low2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># low-order filtering (right)</span>
<span class="n">sflat_high</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_high</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># high-order filtering (middle)</span>
<span class="n">sflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">sflat_low1</span><span class="p">,</span> <span class="n">sflat_high</span><span class="p">,</span> <span class="n">sflat_low2</span><span class="p">])</span>

<span class="n">nor_flat</span> <span class="o">=</span> <span class="n">flat</span><span class="o">/</span><span class="n">sflat</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sflat</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nor_flat</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">high_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">high_window</span><span class="p">[</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">high_window</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>
    <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;low-order-filtered range&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;high-order-</span><span class="se">\n</span><span class="s1">filtered</span><span class="se">\n</span><span class="s1">range&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
           <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#0296f0&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;low-order-filtered range&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

<span class="n">nor_flat2d</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MASTER_flat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">MASTER_flat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    
    <span class="n">flat_low1</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[:</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">flat_low2</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>
    <span class="n">flat_high</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">HIGH_WINDOW_LIM</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">sflat_low1</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_low1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># low-order filtering (left)</span>
    <span class="n">sflat_low2</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_low2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># low-order filtering (right)</span>
    <span class="n">sflat_high</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">flat_high</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1"># high-order filtering (middle)</span>
    
    <span class="n">sflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">sflat_low1</span><span class="p">,</span> <span class="n">sflat_high</span><span class="p">,</span> <span class="n">sflat_low2</span><span class="p">])</span>
    <span class="n">nor_flat2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flat</span> <span class="o">/</span> <span class="n">sflat</span><span class="p">)</span>
    
<span class="n">nor_flat2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nor_flat2d</span><span class="p">)</span>  
<span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Normalized&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>

<span class="n">SAVE_flat</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Flat.fits&#39;</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SAVE_flat</span><span class="p">,</span> <span class="n">nor_flat2d</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">im</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nor_flat2d</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normalized master flat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Normalized master flat&#39;)
</pre></div>
</div>
<img alt="../_images/34b523ff37f1e2075e3713e66cb35054290b3a6f67780b57e17156225ba9ec0c.png" class="align-center" src="../_images/34b523ff37f1e2075e3713e66cb35054290b3a6f67780b57e17156225ba9ec0c.png" />
<img alt="../_images/27cc8b5b0a3b76caea7138b868444f45c4e2c6dbb1b15c26b4fb31712d731402.png" class="align-center" src="../_images/27cc8b5b0a3b76caea7138b868444f45c4e2c6dbb1b15c26b4fb31712d731402.png" />
</div>
</div>
</section>
<section id="master-calibration-image">
<h3>1.5 Master Calibration image<a class="headerlink" href="#master-calibration-image" title="Link to this heading">#</a></h3>
<section id="check-wavelength-calibration-image-shift">
<h4>Check wavelength Calibration image shift<a class="headerlink" href="#check-wavelength-calibration-image-shift" title="Link to this heading">#</a></h4>
<p>I will check the wavelength calibration image shift with the same manner done for flat image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring Master bias &amp; Dark</span>

<span class="n">biasfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span><span class="s1">&#39;Master_Bias.fits&#39;</span><span class="p">)</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">biasfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mbias</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="n">darkfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span><span class="s1">&#39;Master_Dark_60.0s.fits&#39;</span><span class="p">)</span>
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">darkfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mdark</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>


<span class="c1"># Plot the Comparison image</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Complist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">Mbias</span> <span class="o">-</span> <span class="n">Mdark</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">Complist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">)</span>



<span class="c1"># Cut the spectrum along the dispersion direction</span>
<span class="n">ComSpec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ComSpec</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument</span><span class="se">\n</span><span class="s1">Intensity [Counts]&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12b4e3cd69c80d51034e6f355e01766c3c992d95f6a2fb81068e56ca8a69ea7c.png" class="align-center" src="../_images/12b4e3cd69c80d51034e6f355e01766c3c992d95f6a2fb81068e56ca8a69ea7c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the local peak for each image</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">Coor_shift</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Complist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Complist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">neon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">115</span><span class="p">:</span><span class="mi">135</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">neon</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">Complist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">1500</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">neon</span><span class="p">))</span>
    <span class="c1"># peak finding</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">neon</span><span class="p">,</span> <span class="n">min_distance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                 <span class="n">threshold_abs</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">neon</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
    
    <span class="n">Coor_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="c1"># to compare peak locations frame by frame</span>
    
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total </span><span class="si">{0}</span><span class="s1"> peakes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">))))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">i</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">neon</span><span class="p">)</span><span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">neon</span><span class="p">)</span><span class="o">*</span><span class="mf">0.03</span><span class="p">),</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">],</span>
            <span class="p">[</span><span class="n">neon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">neon</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">neon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">neon</span><span class="p">)</span><span class="o">*</span><span class="mf">0.03</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">reference_coor</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Coor_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    
     
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Coor_shift</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">coor_i</span> <span class="o">=</span> <span class="n">Coor_shift</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_shift</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_shift</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reference_coor</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coor_i</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">reference_coor</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">coor_i</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">&lt;</span><span class="mi">5</span> <span class="p">:</span>
                <span class="n">y_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_coor</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">coor_i</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">x_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_coor</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_shift</span><span class="p">,</span><span class="n">y_shift</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span>
               <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Complist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>    
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)</span>    
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Degree of the shifted pixel </span><span class="se">\n</span><span class="s1"> of the each peak&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/213b03236083f7b8260c2ab32d1741a3c4696aac023cdcf3547732811b46933f.png" class="align-center" src="../_images/213b03236083f7b8260c2ab32d1741a3c4696aac023cdcf3547732811b46933f.png" />
</div>
</div>
</section>
</section>
<section id="median-combine-comparison-lamp-image">
<h3>Median combine Comparison Lamp image<a class="headerlink" href="#median-combine-comparison-lamp-image" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Master_Comp</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Complist</span><span class="p">)):</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Complist</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>    
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">Mbias</span> <span class="o">-</span> <span class="n">Mdark</span>

    <span class="n">Master_Comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
<span class="n">MASTER_Comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">Master_Comp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">SAVE_comp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUBPATH</span><span class="p">,</span><span class="s1">&#39;Master_Neon.fits&#39;</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SAVE_comp</span><span class="p">,</span><span class="n">MASTER_Comp</span><span class="p">,</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="bias-subtraction-dark-subtraction-pre-processing">
<h3>1.6 Bias subtraction &amp; Dark subtraction (Pre-Processing)<a class="headerlink" href="#bias-subtraction-dark-subtraction-pre-processing" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring the sample image </span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;61Cygni-0001.fit&#39;</span>
<span class="n">objhdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">objhdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Bring Master Bias</span>
<span class="n">biasfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Bias.fits&#39;</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">biasfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">Mbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mbias</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># Bring Master Dark</span>
<span class="n">darkfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Dark_2.0s.fits&#39;</span>
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">darkfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
<span class="n">Mdark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mdark</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

<span class="c1"># Bring Master Flat</span>
<span class="n">flatfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Flat.fits&#39;</span>
<span class="n">Mflat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">flatfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
<span class="n">Mflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mflat</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>


<span class="c1"># Bias subtracting</span>
<span class="n">bobjdata</span> <span class="o">=</span> <span class="n">raw_data</span> <span class="o">-</span> <span class="n">Mbias</span> 

<span class="c1"># Dark_subtracting</span>
<span class="n">dbobjdata</span> <span class="o">=</span> <span class="n">bobjdata</span> <span class="o">-</span> <span class="n">Mdark</span>

<span class="c1"># Flat fielding</span>
<span class="n">fdbobjdata</span> <span class="o">=</span> <span class="n">dbobjdata</span> <span class="o">/</span> <span class="n">Mflat</span>


<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Raw data&#39;</span><span class="p">)</span>



<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bobjdata</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After Bias&#39;</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dbobjdata</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After Dark&#39;</span><span class="p">)</span>

<span class="n">ax4</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fdbobjdata</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After Flat&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ab165f936f3aae19d3f6f8cdb93f02eaf02eab6159b7c8507b8fa1787777e0cf.png" class="align-center" src="../_images/ab165f936f3aae19d3f6f8cdb93f02eaf02eab6159b7c8507b8fa1787777e0cf.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do it for all object image</span>

<span class="n">OBJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Objectlist</span><span class="p">,</span><span class="n">Standlist</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OBJ</span><span class="p">)):</span>
    <span class="c1"># Bring the sample image </span>
    <span class="n">objhdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">OBJ</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">objhdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">objhdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="c1"># Bring Master Bias</span>
    <span class="n">biasfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Bias.fits&#39;</span>
    <span class="n">Mbias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">biasfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">Mbias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mbias</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># Bring Master Dark</span>
    <span class="n">EXPTIME</span> <span class="o">=</span> <span class="n">objhdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
    <span class="n">darkfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;Master_Dark_</span><span class="si">{</span><span class="n">EXPTIME</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s.fits&#39;</span>
    <span class="n">Mdark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">darkfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
    <span class="n">Mdark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mdark</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    
    <span class="c1"># Bring Master Dark</span>
    <span class="n">flatfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;Master_Flat.fits&#39;</span>
    <span class="n">Mflat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">flatfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
    <span class="n">Mflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Mflat</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># Bias subtracting</span>
    <span class="n">bobjdata</span> <span class="o">=</span> <span class="n">raw_data</span> <span class="o">-</span> <span class="n">Mbias</span> 

    <span class="c1"># Dark subtracting</span>
    <span class="n">dbobjdata</span> <span class="o">=</span> <span class="n">bobjdata</span> <span class="o">-</span> <span class="n">Mdark</span>
    
    <span class="c1"># Flat fielding</span>
    <span class="n">fdbobjdata</span> <span class="o">=</span> <span class="n">dbobjdata</span> <span class="o">/</span> <span class="n">Mflat</span>
    
    <span class="c1"># Add header comment</span>
    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bias_subtraction is done&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> dark images are median combined on &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Master_dark</span><span class="p">))</span>\
    <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S (KST)&#39;</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;with &#39;</span><span class="o">+</span><span class="s1">&#39; Master_Dark_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;s.fits&#39;</span>
    
    <span class="c1"># Save the image</span>
    <span class="n">SAVE_name</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span> <span class="n">OBJ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SAVE_name</span><span class="p">,</span> <span class="n">fdbobjdata</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">SAVE_name</span><span class="p">,</span><span class="s1">&#39; is made!&#39;</span><span class="p">)</span>

<span class="c1"># comparison lamp frame</span>
<span class="n">Master_comparison</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;Master_Neon.fits&#39;</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Master_comparison</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>

<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;pMaster_Neon.fits&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">hdul</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/p61Cygni-0001.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/p61Cygni-0002.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/p61Cygni-0003.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/p61Cygni-0004.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/p61Cygni-0005.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/pHR153-0001.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/pHR153-0002.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/pHR153-0003.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/pHR153-0004.fits  is made!
/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/pHR153-0005.fits  is made!
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="spectroscopic-data-reduction">
<h2>2. Spectroscopic data reduction<a class="headerlink" href="#spectroscopic-data-reduction" title="Link to this heading">#</a></h2>
<section id="extract-the-spectrum">
<h3>2-1. Extract the Spectrum<a class="headerlink" href="#extract-the-spectrum" title="Link to this heading">#</a></h3>
<section id="identification-of-objects-peak-set-the-area-of-background">
<h4>Identification of Object’s peak &amp; Set the area of background<a class="headerlink" href="#identification-of-objects-peak-set-the-area-of-background" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring the sample image</span>

<span class="n">OBJECTNAME</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;p61Cygni-0001.fits&#39;</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">OBJECTNAME</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>
<span class="n">EXPTIME</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EXPTIME = </span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis [pixel]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis </span><span class="se">\n</span><span class="s1"> [pixel]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Spatial axis \n [pixel]&#39;)
</pre></div>
</div>
<img alt="../_images/c67f461746f3c00a30e979d4b4abbc5090f846a87fd872b6510ad370464086cb.png" class="align-center" src="../_images/c67f461746f3c00a30e979d4b4abbc5090f846a87fd872b6510ad370464086cb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s find the peak along the spatial axis</span>

<span class="c1"># Plot the spectrum along the spatial direction</span>
<span class="n">lower_cut</span> <span class="o">=</span> <span class="mi">700</span>
<span class="n">upper_cut</span> <span class="o">=</span> <span class="mi">750</span>
<span class="n">apall_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obj</span><span class="p">[:,</span><span class="n">lower_cut</span><span class="p">:</span><span class="n">upper_cut</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

<span class="c1"># Find the peak</span>

<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">,</span> <span class="n">num_peaks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">min_distance</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                          <span class="n">threshold_abs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">)</span>

<span class="n">peak_value</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">),</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)),</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">peak_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pixel coordinatate in spatial direction = </span><span class="si">{</span><span class="n">peak_pix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[145  93]
145
93
</pre></div>
</div>
<img alt="../_images/031aeca1869d2ae335d76b085af3eada6674329b619e774381fd3a3ae7b4656a.png" class="align-center" src="../_images/031aeca1869d2ae335d76b085af3eada6674329b619e774381fd3a3ae7b4656a.png" />
<img alt="../_images/ee41006839d69944fa6ae5977593449c3e7b50ede68c852a7b5226bf12d5ea5f.png" class="align-center" src="../_images/ee41006839d69944fa6ae5977593449c3e7b50ede68c852a7b5226bf12d5ea5f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pixel coordinatate in spatial direction = [ 93 145]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the sky area</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">peak_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># center</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Peak pixel is </span><span class="si">{0}</span><span class="s1"> pix&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">SKYLIMIT</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># pixel limit around the peak</span>
<span class="n">RLIMIT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># pixel limit from the rightmost area</span>
<span class="n">LLIMIT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># pixel limit from the leftmost area</span>

<span class="n">mask_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">mask_sky</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>    
<span class="n">mask_sky</span><span class="p">[:</span><span class="n">LLIMIT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mask_sky</span><span class="p">[</span><span class="o">-</span><span class="n">RLIMIT</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="n">x_sky</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>
<span class="n">sky_val</span> <span class="o">=</span> <span class="n">apall_1</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>

<span class="c1"># Plot the sky area</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask_sky</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Peak pixel is 93 pix
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Pixel value sum&#39;)
</pre></div>
</div>
<img alt="../_images/989d4f4c53ed002c721cefc645ad1d8a30162c6307ef6d8570405095945a1ec2.png" class="align-center" src="../_images/989d4f4c53ed002c721cefc645ad1d8a30162c6307ef6d8570405095945a1ec2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sigma clipping</span>
<span class="n">Sigma</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span>
                       <span class="n">sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">,</span>
                       <span class="n">maxiters</span><span class="o">=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

<span class="c1"># Fit the sky</span>
<span class="n">ORDER_APSKY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">coeff_apsky</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span> 
                               <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                               <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">,</span>
                               <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sky_fit</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coeff_apsky</span><span class="p">)</span> 

<span class="c1"># Calculate the RMS of Fit</span>
<span class="n">residual</span> <span class="o">=</span> <span class="n">fitfull</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">fitRMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">residual</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">]))</span>


<span class="n">n_sky</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_sky</span><span class="p">)</span>
<span class="n">n_rej</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">clip_mask</span><span class="p">)</span>

<span class="c1"># Plot the sky area &amp; fitted sky</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sky_fit</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sky Fit (</span><span class="si">{:d}</span><span class="s1">/</span><span class="si">{:d}</span><span class="s1"> used)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_sky</span> <span class="o">-</span> <span class="n">n_rej</span><span class="p">,</span> <span class="n">n_sky</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="n">clip_mask</span><span class="p">],</span> <span class="n">sky_val</span><span class="p">[</span><span class="n">clip_mask</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask_sky</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>


<span class="n">title_str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Skyfit: </span><span class="si">{:s}</span><span class="s1"> order </span><span class="si">{:d}</span><span class="s1"> (</span><span class="si">{:.1f}</span><span class="s1">-sigma </span><span class="si">{:d}</span><span class="s1">-iters)&#39;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Chebyshev&#39;</span><span class="p">,</span> <span class="n">ORDER_APSKY</span><span class="p">,</span>
                              <span class="n">Sigma</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Skyfit: Chebyshev order 3 (3.0-sigma 5-iters)&#39;)
</pre></div>
</div>
<img alt="../_images/aa003979b66feacad52f5c679c2927c3a25c1843ddb9b9c09aa3772cbaa72c66.png" class="align-center" src="../_images/aa003979b66feacad52f5c679c2927c3a25c1843ddb9b9c09aa3772cbaa72c66.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finding the peak center by fitting the gaussian 1D function again</span>

<span class="n">sub_apall_1</span> <span class="o">=</span> <span class="n">apall_1</span> <span class="o">-</span> <span class="n">sky_fit</span> <span class="c1"># profile - sky</span>

<span class="c1"># OUTPIX = 50 # number of pixels to rule out outermost area in spacial direction</span>
<span class="c1"># xx = x[OUTPIX:-OUTPIX]</span>
<span class="c1"># yy = sub_apall_1[OUTPIX:-OUTPIX]</span>

<span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">peak</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">:</span><span class="n">peak</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">]</span>
<span class="n">yy</span> <span class="o">=</span> <span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">:</span><span class="n">peak</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">]</span>

<span class="c1"># gaussian modeling</span>
<span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="p">],</span> 
                    <span class="n">mean</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span>
                    <span class="n">stddev</span><span class="o">=</span><span class="mi">15</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">)</span>

<span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">fitted</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fitted</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub_apall_1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spatial profile&#39;</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted 1D Gaussian profile&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">center_pix</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;center pixel:&#39;</span><span class="p">,</span> <span class="n">center_pix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0dcfd0bb9d560cf2306d3c280a4db86e48e096329c0bdfe388ef5250befc4703.png" class="align-center" src="../_images/0dcfd0bb9d560cf2306d3c280a4db86e48e096329c0bdfe388ef5250befc4703.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>center pixel: 92.4245791504611
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trace the aperture (peak) along the wavelength.</span>
<span class="c1"># Repeat the above process for all wavelength bands.</span>
<span class="c1"># This process is called &quot;aperture tracing&quot;.</span>
<span class="n">aptrace</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aptrace_fwhm</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">STEP_AP</span> <span class="o">=</span> <span class="mi">10</span>  
<span class="n">N_AP</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="n">STEP_AP</span>
<span class="n">FWHM_AP</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">center_pix</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_AP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">lower_cut</span><span class="p">,</span> <span class="n">upper_cut</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">STEP_AP</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">STEP_AP</span>
    <span class="n">apall_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obj</span><span class="p">[:,</span> <span class="n">lower_cut</span><span class="p">:</span><span class="n">upper_cut</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sky_val</span> <span class="o">=</span> <span class="n">apall_i</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>
    <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span>
                           <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">coeff</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span> 
                             <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                             <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">,</span>
                             <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">apall_i</span> <span class="o">-=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">coeff</span><span class="p">)</span>  <span class="c1"># Object profile - the fitted sky</span>
    
    <span class="n">search_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">)</span>
    <span class="n">search_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">)</span>
    <span class="n">cropped</span> <span class="o">=</span> <span class="n">apall_i</span><span class="p">[</span><span class="n">search_min</span><span class="p">:</span><span class="n">search_max</span><span class="p">]</span>
    <span class="n">x_cropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cropped</span><span class="p">))</span>
    
    <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span>
                              <span class="n">min_distance</span><span class="o">=</span><span class="n">FWHM_AP</span><span class="p">,</span>
                              <span class="n">num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
 
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># return NaN (Not a Number) if there is no peak found. </span>
        <span class="n">aptrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">aptrace_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">)</span>
        <span class="n">peak_trace</span> <span class="o">=</span> <span class="n">peak_pix_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
        <span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">cropped</span><span class="p">[</span><span class="n">peak_trace</span><span class="p">],</span> <span class="c1"># Gaussian fitting to find centers</span>
                            <span class="n">mean</span><span class="o">=</span><span class="n">peak_trace</span><span class="p">,</span>
                            <span class="n">stddev</span><span class="o">=</span><span class="n">FWHM_AP</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">,</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amplitude&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cropped</span><span class="p">[</span><span class="n">peak_trace</span><span class="p">])</span> <span class="p">,</span>
                                    <span class="s1">&#39;mean&#39;</span><span class="p">:(</span><span class="n">peak_trace</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">,</span> <span class="n">peak_trace</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">),</span>
                                    <span class="s1">&#39;stddev&#39;</span><span class="p">:(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">FWHM_AP</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">)})</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span> <span class="n">x_cropped</span><span class="p">,</span> <span class="n">cropped</span><span class="p">)</span>
        <span class="n">center_pix_new</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">search_min</span>
        <span class="n">aptrace_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="n">aptrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_pix_new</span><span class="p">)</span>  
        
<span class="n">aptrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aptrace</span><span class="p">)</span>
<span class="n">aptrace_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aptrace_fwhm</span><span class="p">)</span>          
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the center of profile peak</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aptrace</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightskyblue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># you can see the jiggly-wiggly shape when you zoom in</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Spatial axis&#39;)
</pre></div>
</div>
<img alt="../_images/90867c5d99e9193ae0e5b5a390bac2cba7f6b1a5124e0fb9891db74814a9ced5.png" class="align-center" src="../_images/90867c5d99e9193ae0e5b5a390bac2cba7f6b1a5124e0fb9891db74814a9ced5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fitting the peak with Chebyshev function</span>

<span class="n">ORDER_APTRACE</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">SIGMA_APTRACE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ITERS_APTRACE</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># when sigma clipping</span>

<span class="c1"># Fitting the line</span>
<span class="n">x_aptrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_AP</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">STEP_AP</span>
<span class="n">coeff_aptrace</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APTRACE</span><span class="p">)</span>

<span class="c1"># Sigma clipping</span>
<span class="n">resid_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">aptrace</span> <span class="o">-</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">coeff_aptrace</span><span class="p">),</span> 
                        <span class="n">sigma</span><span class="o">=</span><span class="n">SIGMA_APTRACE</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">ITERS_APTRACE</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

<span class="c1"># Fitting the peak again after sigma clipping</span>
<span class="n">x_aptrace_fin</span> <span class="o">=</span> <span class="n">x_aptrace</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">]</span>
<span class="n">aptrace_fin</span> <span class="o">=</span> <span class="n">aptrace</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">]</span>
<span class="n">coeff_aptrace_fin</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">aptrace_fin</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APTRACE</span><span class="p">)</span>   

<span class="n">fit_aptrace_fin</span>   <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">coeff_aptrace_fin</span><span class="p">)</span>
<span class="n">resid_aptrace_fin</span> <span class="o">=</span> <span class="n">aptrace_fin</span> <span class="o">-</span> <span class="n">fit_aptrace_fin</span>
<span class="n">del_aptrace</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">x_aptrace_fin</span><span class="p">)</span> <span class="c1"># deleted points #x_aptrace에서 x_aptrace_fin이 없으면 True</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">test = np.array([0, 1, 2, 5, 0])</span>
<span class="sd">states = [0, 2]</span>
<span class="sd">mask = np.in1d(test, states)</span>
<span class="sd">mask</span>
<span class="sd">array([ True, False,  True, False,  True])</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="c1"># Plot the Fitted line &amp; residual</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightskyblue&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">fit_aptrace_fin</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Aperture Trace (</span><span class="si">{:d}</span><span class="s2">/</span><span class="si">{:d}</span><span class="s2"> used)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aptrace_fin</span><span class="p">),</span> <span class="n">N_AP</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">[</span><span class="n">del_aptrace</span><span class="p">],</span> <span class="n">aptrace</span><span class="p">[</span><span class="n">del_aptrace</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Found object position&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;residual std&#39;</span><span class="p">)</span>


<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (pixel)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis (pixel)&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1">#Set plot title</span>
<span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Aperture Trace Fit (</span><span class="si">{:s}</span><span class="s1"> order </span><span class="si">{:d}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="o">+</span> <span class="s1">&#39;Residuials </span><span class="si">{:.1f}</span><span class="s1">-sigma, </span><span class="si">{:d}</span><span class="s1">-iters clipped&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Chebshev&#39;</span><span class="p">,</span> <span class="n">ORDER_APTRACE</span><span class="p">,</span>
                              <span class="n">SIGMA_APTRACE</span><span class="p">,</span> <span class="n">ITERS_APTRACE</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d9caa1c695351cc7ae4dbaf3a582b0727b3f437b0cde70d8c55337822b9b7dad.png" class="align-center" src="../_images/d9caa1c695351cc7ae4dbaf3a582b0727b3f437b0cde70d8c55337822b9b7dad.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aperture sum</span>

<span class="n">apsum_sigma_lower</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># [Sigma]</span>
<span class="n">apsum_sigma_upper</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ap_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aptrace_fwhm</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">])</span> <span class="c1"># [pix]</span>
<span class="n">ap_sigma</span> <span class="o">=</span> <span class="n">ap_fwhm</span> <span class="o">*</span> <span class="n">gaussian_fwhm_to_sigma</span> <span class="c1"># [pixel/sigma]</span>
<span class="n">x_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># pixel along the dispersion axis</span>
<span class="n">y_ap</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_ap</span><span class="p">,</span> <span class="n">coeff_aptrace_fin</span><span class="p">)</span> <span class="c1"># center of peak for each line</span>

<span class="c1"># Extract the spectrum along the dispersion axis</span>
<span class="n">ap_summed</span>  <span class="o">=</span> <span class="p">[]</span>
<span class="n">ap_sig</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">cut_i</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Cut spatial direction</span>
    <span class="n">peak_i</span> <span class="o">=</span> <span class="n">y_ap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">offset_i</span> <span class="o">=</span> <span class="n">peak_i</span> <span class="o">-</span> <span class="n">peak</span>
    
    <span class="n">mask_sky_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
        <span class="n">mask_sky_i</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">+</span><span class="n">offset_i</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="n">offset_i</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>    
    <span class="n">mask_sky_i</span><span class="p">[:</span><span class="n">LLIMIT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mask_sky_i</span><span class="p">[</span><span class="o">-</span><span class="n">RLIMIT</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
 
    <span class="c1"># aperture size = apsum_sigma_lower * ap_sigma</span>
    <span class="n">x_obj_lower</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_i</span> <span class="o">-</span> <span class="n">apsum_sigma_lower</span> <span class="o">*</span> <span class="n">ap_sigma</span><span class="p">))</span> 
    <span class="n">x_obj_upper</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_i</span> <span class="o">+</span> <span class="n">apsum_sigma_upper</span> <span class="o">*</span> <span class="n">ap_sigma</span><span class="p">))</span>         
    <span class="n">x_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_obj_lower</span><span class="p">,</span> <span class="n">x_obj_upper</span><span class="p">)</span>
    <span class="n">obj_i</span> <span class="o">=</span> <span class="n">cut_i</span><span class="p">[</span><span class="n">x_obj_lower</span><span class="p">:</span><span class="n">x_obj_upper</span><span class="p">]</span>

    <span class="c1"># Fitting Sky value</span>
    <span class="n">x_sky</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask_sky_i</span><span class="p">]</span>
    <span class="n">sky_val</span> <span class="o">=</span> <span class="n">cut_i</span><span class="p">[</span><span class="n">mask_sky_i</span><span class="p">]</span>
    <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">,</span>
                           <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                    <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                    <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">)</span>

    <span class="c1"># Subtract the sky</span>
    <span class="n">sub_obj_i</span> <span class="o">=</span> <span class="n">obj_i</span> <span class="o">-</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_obj</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span> <span class="c1"># obj - lsky  subtraction</span>

    
    <span class="c1"># Calculate error</span>
    <span class="n">sig_i</span> <span class="o">=</span> <span class="n">RN</span> <span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sub_obj_i</span> <span class="o">+</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_obj</span><span class="p">,</span><span class="n">coeff</span><span class="p">)</span>
    <span class="c1"># RN**2 + flux_i + sky value </span>
    
    <span class="n">ap_summed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_obj_i</span><span class="p">))</span> 
    <span class="n">ap_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_i</span><span class="p">)))</span>
    
<span class="n">ap_summed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ap_summed</span><span class="p">)</span> <span class="o">/</span> <span class="n">EXPTIME</span>    
<span class="n">ap_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ap_sig</span><span class="p">)</span> <span class="o">/</span> <span class="n">EXPTIME</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the spectrum </span>

<span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span><span class="n">ap_summed</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">FILENAME</span> <span class="o">=</span> <span class="n">OBJECTNAME</span><span class="o">.</span><span class="n">name</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument Intensity</span><span class="se">\n</span><span class="s1">(apsum/EXPTIME)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis [Pixel]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">spec_before_wfcali</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">ap_summed</span><span class="p">,</span> <span class="n">ap_std</span><span class="p">],</span>
                          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_pix&#39;</span><span class="p">,</span> <span class="s1">&#39;ap_summed&#39;</span><span class="p">,</span> <span class="s1">&#39;ap_std&#39;</span><span class="p">])</span>


<span class="n">spec_before_wfcali</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="n">OBJECTNAME</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_inst_spec.csv&#39;</span><span class="p">),</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3451a028616c3143f3ff13d3cca4042a11b000fa299099250b6308a4fa832dc9.png" class="align-center" src="../_images/3451a028616c3143f3ff13d3cca4042a11b000fa299099250b6308a4fa832dc9.png" />
</div>
</div>
</section>
<section id="aperture-tracing-aperture-sum-for-standard-star">
<h4>Aperture tracing &amp; aperture sum for standard star<a class="headerlink" href="#aperture-tracing-aperture-sum-for-standard-star" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring the sample image</span>

<span class="n">OBJECTNAME</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;pHR153-0001.fits&#39;</span>
<span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">OBJECTNAME</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">data</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">header</span>
<span class="n">EXPTIME</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EXPTIME = </span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis [pixel]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis </span><span class="se">\n</span><span class="s1"> [pixel]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Spatial axis \n [pixel]&#39;)
</pre></div>
</div>
<img alt="../_images/8634096b7eb4f2a615ca2e6c0316993bb149ffdc08b6063d40cd7a1733821285.png" class="align-center" src="../_images/8634096b7eb4f2a615ca2e6c0316993bb149ffdc08b6063d40cd7a1733821285.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s find the peak along the spatial axis</span>

<span class="c1"># Plot the spectrum along the spatial direction</span>
<span class="n">lower_cut</span> <span class="o">=</span> <span class="mi">700</span>
<span class="n">upper_cut</span> <span class="o">=</span> <span class="mi">750</span>
<span class="n">apall_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obj</span><span class="p">[:,</span><span class="n">lower_cut</span><span class="p">:</span><span class="n">upper_cut</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

<span class="c1"># Find the peak</span>

<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">,</span> <span class="n">num_peaks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">min_distance</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                          <span class="n">threshold_abs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">)</span>

<span class="n">peak_value</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">),</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)),</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">apall_1</span><span class="p">)),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">peak_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apall_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pixel coordinatate in spatial direction = </span><span class="si">{</span><span class="n">peak_pix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[126]
126
</pre></div>
</div>
<img alt="../_images/467630da084b6dc91398036390c4c6c0f8a7bc328df927d292eca3ba696b74a6.png" class="align-center" src="../_images/467630da084b6dc91398036390c4c6c0f8a7bc328df927d292eca3ba696b74a6.png" />
<img alt="../_images/313628db6de3b2e35b35f7f7e0420172e5d49677e31c90bf3e01056502da2efb.png" class="align-center" src="../_images/313628db6de3b2e35b35f7f7e0420172e5d49677e31c90bf3e01056502da2efb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pixel coordinatate in spatial direction = [126]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the sky area</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">peak_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># center</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Peak pixel is </span><span class="si">{0}</span><span class="s1"> pix&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">SKYLIMIT</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># pixel limit around the peak</span>
<span class="n">RLIMIT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># pixel limit from the rightmost area</span>
<span class="n">LLIMIT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># pixel limit from the leftmost area</span>

<span class="n">mask_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">mask_sky</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>    
<span class="n">mask_sky</span><span class="p">[:</span><span class="n">LLIMIT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mask_sky</span><span class="p">[</span><span class="o">-</span><span class="n">RLIMIT</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="n">x_sky</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>
<span class="n">sky_val</span> <span class="o">=</span> <span class="n">apall_1</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>

<span class="c1"># Plot the sky area</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask_sky</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Peak pixel is 126 pix
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Pixel value sum&#39;)
</pre></div>
</div>
<img alt="../_images/a3aa713eb11096868b453df6aa633d0de644b7e2589bedcb56af3d32a2740516.png" class="align-center" src="../_images/a3aa713eb11096868b453df6aa633d0de644b7e2589bedcb56af3d32a2740516.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sigma clipping</span>
<span class="n">Sigma</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span>
                       <span class="n">sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">,</span>
                       <span class="n">maxiters</span><span class="o">=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

<span class="c1"># Fit the sky</span>
<span class="n">ORDER_APSKY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">coeff_apsky</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span> 
                               <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                               <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">,</span>
                               <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sky_fit</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coeff_apsky</span><span class="p">)</span> 

<span class="c1"># Calculate the RMS of Fit</span>
<span class="n">residual</span> <span class="o">=</span> <span class="n">fitfull</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">fitRMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">residual</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">]))</span>


<span class="n">n_sky</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_sky</span><span class="p">)</span>
<span class="n">n_rej</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">clip_mask</span><span class="p">)</span>

<span class="c1"># Plot the sky area &amp; fitted sky</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apall_1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sky_fit</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sky Fit (</span><span class="si">{:d}</span><span class="s1">/</span><span class="si">{:d}</span><span class="s1"> used)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_sky</span> <span class="o">-</span> <span class="n">n_rej</span><span class="p">,</span> <span class="n">n_sky</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="n">clip_mask</span><span class="p">],</span> <span class="n">sky_val</span><span class="p">[</span><span class="n">clip_mask</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask_sky</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">())</span>


<span class="n">title_str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Skyfit: </span><span class="si">{:s}</span><span class="s1"> order </span><span class="si">{:d}</span><span class="s1"> (</span><span class="si">{:.1f}</span><span class="s1">-sigma </span><span class="si">{:d}</span><span class="s1">-iters)&#39;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Chebyshev&#39;</span><span class="p">,</span> <span class="n">ORDER_APSKY</span><span class="p">,</span>
                              <span class="n">Sigma</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Skyfit: Chebyshev order 3 (3.0-sigma 5-iters)&#39;)
</pre></div>
</div>
<img alt="../_images/d71cb0cb86bc2703846ee40f883d7512dae3439d29fe613249b814f58538b61a.png" class="align-center" src="../_images/d71cb0cb86bc2703846ee40f883d7512dae3439d29fe613249b814f58538b61a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finding the peak center by fitting the gaussian 1D function again</span>

<span class="n">sub_apall_1</span> <span class="o">=</span> <span class="n">apall_1</span> <span class="o">-</span> <span class="n">sky_fit</span> <span class="c1"># profile - sky</span>

<span class="c1"># OUTPIX = 50 # number of pixels to rule out outermost area in spacial direction</span>
<span class="c1"># xx = x[OUTPIX:-OUTPIX]</span>
<span class="c1"># yy = sub_apall_1[OUTPIX:-OUTPIX]</span>

<span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">peak</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">:</span><span class="n">peak</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">]</span>
<span class="n">yy</span> <span class="o">=</span> <span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">:</span><span class="n">peak</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">]</span>

<span class="c1"># gaussian modeling</span>
<span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="p">],</span> 
                    <span class="n">mean</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span>
                    <span class="n">stddev</span><span class="o">=</span><span class="mi">15</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">)</span>

<span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">fitted</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fitted</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">apall_1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub_apall_1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spatial profile&#39;</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted 1D Gaussian profile&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel number (Spatial axis)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sub_apall_1</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">center_pix</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;center pixel:&#39;</span><span class="p">,</span> <span class="n">center_pix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e87ae380bc1120bd4d109d9ebd32579c7f97e1603037db193b96fd3504323862.png" class="align-center" src="../_images/e87ae380bc1120bd4d109d9ebd32579c7f97e1603037db193b96fd3504323862.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>center pixel: 126.3998688552938
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trace the aperture (peak) along the wavelength.</span>
<span class="c1"># Repeat the above process for all wavelength bands.</span>
<span class="c1"># This process is called &quot;aperture tracing&quot;.</span>
<span class="n">aptrace</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aptrace_fwhm</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">STEP_AP</span> <span class="o">=</span> <span class="mi">10</span>  
<span class="n">N_AP</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="n">STEP_AP</span>
<span class="n">FWHM_AP</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">center_pix</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_AP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">lower_cut</span><span class="p">,</span> <span class="n">upper_cut</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">STEP_AP</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">STEP_AP</span>
    <span class="n">apall_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obj</span><span class="p">[:,</span> <span class="n">lower_cut</span><span class="p">:</span><span class="n">upper_cut</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sky_val</span> <span class="o">=</span> <span class="n">apall_i</span><span class="p">[</span><span class="n">mask_sky</span><span class="p">]</span>
    <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span>
                           <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">coeff</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span> 
                             <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                             <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">,</span>
                             <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">apall_i</span> <span class="o">-=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">coeff</span><span class="p">)</span>  <span class="c1"># Object profile - the fitted sky</span>
    
    <span class="n">search_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">)</span>
    <span class="n">search_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">)</span>
    <span class="n">cropped</span> <span class="o">=</span> <span class="n">apall_i</span><span class="p">[</span><span class="n">search_min</span><span class="p">:</span><span class="n">search_max</span><span class="p">]</span>
    <span class="n">x_cropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cropped</span><span class="p">))</span>
    
    <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span>
                              <span class="n">min_distance</span><span class="o">=</span><span class="n">FWHM_AP</span><span class="p">,</span>
                              <span class="n">num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
 
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># return NaN (Not a Number) if there is no peak found. </span>
        <span class="n">aptrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">aptrace_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak_pix_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peak_pix_trace</span><span class="p">)</span>
        <span class="n">peak_trace</span> <span class="o">=</span> <span class="n">peak_pix_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
        <span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">cropped</span><span class="p">[</span><span class="n">peak_trace</span><span class="p">],</span> <span class="c1"># Gaussian fitting to find centers</span>
                            <span class="n">mean</span><span class="o">=</span><span class="n">peak_trace</span><span class="p">,</span>
                            <span class="n">stddev</span><span class="o">=</span><span class="n">FWHM_AP</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">,</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amplitude&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cropped</span><span class="p">[</span><span class="n">peak_trace</span><span class="p">])</span> <span class="p">,</span>
                                    <span class="s1">&#39;mean&#39;</span><span class="p">:(</span><span class="n">peak_trace</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">,</span> <span class="n">peak_trace</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">FWHM_AP</span><span class="p">),</span>
                                    <span class="s1">&#39;stddev&#39;</span><span class="p">:(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">FWHM_AP</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">)})</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span> <span class="n">x_cropped</span><span class="p">,</span> <span class="n">cropped</span><span class="p">)</span>
        <span class="n">center_pix_new</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">search_min</span>
        <span class="n">aptrace_fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="n">aptrace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_pix_new</span><span class="p">)</span>  
        
<span class="n">aptrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aptrace</span><span class="p">)</span>
<span class="n">aptrace_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aptrace_fwhm</span><span class="p">)</span>          
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the center of profile peak</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aptrace</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightskyblue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># you can see the jiggly-wiggly shape when you zoom in</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial axis&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Spatial axis&#39;)
</pre></div>
</div>
<img alt="../_images/0d3b3f20654de34a2c6fddeb24b52fb9305126ff95b6f2eb52727b930ab96b00.png" class="align-center" src="../_images/0d3b3f20654de34a2c6fddeb24b52fb9305126ff95b6f2eb52727b930ab96b00.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fitting the peak with Chebyshev function</span>

<span class="n">ORDER_APTRACE</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">SIGMA_APTRACE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ITERS_APTRACE</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># when sigma clipping</span>

<span class="c1"># Fitting the line</span>
<span class="n">x_aptrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_AP</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">STEP_AP</span>
<span class="n">coeff_aptrace</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APTRACE</span><span class="p">)</span>

<span class="c1"># Sigma clipping</span>
<span class="n">resid_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">aptrace</span> <span class="o">-</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">coeff_aptrace</span><span class="p">),</span> 
                        <span class="n">sigma</span><span class="o">=</span><span class="n">SIGMA_APTRACE</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">ITERS_APTRACE</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

<span class="c1"># Fitting the peak again after sigma clipping</span>
<span class="n">x_aptrace_fin</span> <span class="o">=</span> <span class="n">x_aptrace</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">]</span>
<span class="n">aptrace_fin</span> <span class="o">=</span> <span class="n">aptrace</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">]</span>
<span class="n">coeff_aptrace_fin</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">aptrace_fin</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APTRACE</span><span class="p">)</span>   

<span class="n">fit_aptrace_fin</span>   <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">coeff_aptrace_fin</span><span class="p">)</span>
<span class="n">resid_aptrace_fin</span> <span class="o">=</span> <span class="n">aptrace_fin</span> <span class="o">-</span> <span class="n">fit_aptrace_fin</span>
<span class="n">del_aptrace</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">x_aptrace_fin</span><span class="p">)</span> <span class="c1"># deleted points #x_aptrace에서 x_aptrace_fin이 없으면 True</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">test = np.array([0, 1, 2, 5, 0])</span>
<span class="sd">states = [0, 2]</span>
<span class="sd">mask = np.in1d(test, states)</span>
<span class="sd">mask</span>
<span class="sd">array([ True, False,  True, False,  True])</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="c1"># Plot the Fitted line &amp; residual</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">,</span> <span class="n">aptrace</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightskyblue&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">fit_aptrace_fin</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Aperture Trace (</span><span class="si">{:d}</span><span class="s2">/</span><span class="si">{:d}</span><span class="s2"> used)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aptrace_fin</span><span class="p">),</span> <span class="n">N_AP</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace</span><span class="p">[</span><span class="n">del_aptrace</span><span class="p">],</span> <span class="n">aptrace</span><span class="p">[</span><span class="n">del_aptrace</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Found object position&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_aptrace_fin</span><span class="p">,</span> <span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid_aptrace_fin</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;residual std&#39;</span><span class="p">)</span>


<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (pixel)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion axis (pixel)&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1">#Set plot title</span>
<span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Aperture Trace Fit (</span><span class="si">{:s}</span><span class="s1"> order </span><span class="si">{:d}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="o">+</span> <span class="s1">&#39;Residuials </span><span class="si">{:.1f}</span><span class="s1">-sigma, </span><span class="si">{:d}</span><span class="s1">-iters clipped&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Chebshev&#39;</span><span class="p">,</span> <span class="n">ORDER_APTRACE</span><span class="p">,</span>
                              <span class="n">SIGMA_APTRACE</span><span class="p">,</span> <span class="n">ITERS_APTRACE</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c226ffc119a64804f0419237e2135dd255a45342051293f5150c380cf8914e41.png" class="align-center" src="../_images/c226ffc119a64804f0419237e2135dd255a45342051293f5150c380cf8914e41.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aperture sum</span>

<span class="n">apsum_sigma_lower</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># [Sigma]</span>
<span class="n">apsum_sigma_upper</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ap_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">aptrace_fwhm</span><span class="p">[</span><span class="o">~</span><span class="n">resid_mask</span><span class="p">])</span> <span class="c1"># [pix]</span>
<span class="n">ap_sigma</span> <span class="o">=</span> <span class="n">ap_fwhm</span> <span class="o">*</span> <span class="n">gaussian_fwhm_to_sigma</span> <span class="c1"># [pixel/sigma]</span>
<span class="n">x_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># pixel along the dispersion axis</span>
<span class="n">y_ap</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_ap</span><span class="p">,</span> <span class="n">coeff_aptrace_fin</span><span class="p">)</span> <span class="c1"># center of peak for each line</span>

<span class="c1"># Extract the spectrum along the dispersion axis</span>
<span class="n">ap_summed</span>  <span class="o">=</span> <span class="p">[]</span>
<span class="n">ap_sig</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">cut_i</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Cut spatial direction</span>
    <span class="n">peak_i</span> <span class="o">=</span> <span class="n">y_ap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">offset_i</span> <span class="o">=</span> <span class="n">peak_i</span> <span class="o">-</span> <span class="n">peak</span>
    
    <span class="n">mask_sky_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
        <span class="n">mask_sky_i</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">+</span><span class="n">offset_i</span><span class="o">-</span><span class="n">SKYLIMIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">+</span><span class="n">offset_i</span><span class="o">+</span><span class="n">SKYLIMIT</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>    
    <span class="n">mask_sky_i</span><span class="p">[:</span><span class="n">LLIMIT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mask_sky_i</span><span class="p">[</span><span class="o">-</span><span class="n">RLIMIT</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
 
    <span class="c1"># aperture size = apsum_sigma_lower * ap_sigma</span>
    <span class="n">x_obj_lower</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_i</span> <span class="o">-</span> <span class="n">apsum_sigma_lower</span> <span class="o">*</span> <span class="n">ap_sigma</span><span class="p">))</span> 
    <span class="n">x_obj_upper</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_i</span> <span class="o">+</span> <span class="n">apsum_sigma_upper</span> <span class="o">*</span> <span class="n">ap_sigma</span><span class="p">))</span>         
    <span class="n">x_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_obj_lower</span><span class="p">,</span> <span class="n">x_obj_upper</span><span class="p">)</span>
    <span class="n">obj_i</span> <span class="o">=</span> <span class="n">cut_i</span><span class="p">[</span><span class="n">x_obj_lower</span><span class="p">:</span><span class="n">x_obj_upper</span><span class="p">]</span>

    <span class="c1"># Fitting Sky value</span>
    <span class="n">x_sky</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask_sky_i</span><span class="p">]</span>
    <span class="n">sky_val</span> <span class="o">=</span> <span class="n">cut_i</span><span class="p">[</span><span class="n">mask_sky_i</span><span class="p">]</span>
    <span class="n">clip_mask</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">sky_val</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">,</span>
                           <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">x_sky</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                    <span class="n">sky_val</span><span class="p">[</span><span class="o">~</span><span class="n">clip_mask</span><span class="p">],</span>
                    <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_APSKY</span><span class="p">)</span>

    <span class="c1"># Subtract the sky</span>
    <span class="n">sub_obj_i</span> <span class="o">=</span> <span class="n">obj_i</span> <span class="o">-</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_obj</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span> <span class="c1"># obj - lsky  subtraction</span>

    
    <span class="c1"># Calculate error</span>
    <span class="n">sig_i</span> <span class="o">=</span> <span class="n">RN</span> <span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sub_obj_i</span> <span class="o">+</span> <span class="n">chebval</span><span class="p">(</span><span class="n">x_obj</span><span class="p">,</span><span class="n">coeff</span><span class="p">)</span>
    <span class="c1"># RN**2 + flux_i + sky value </span>
    
    <span class="n">ap_summed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_obj_i</span><span class="p">))</span> 
    <span class="n">ap_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sig_i</span><span class="p">)))</span>
    
<span class="n">ap_summed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ap_summed</span><span class="p">)</span> <span class="o">/</span> <span class="n">EXPTIME</span>    
<span class="n">ap_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ap_sig</span><span class="p">)</span> <span class="o">/</span> <span class="n">EXPTIME</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the spectrum </span>

<span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span><span class="n">ap_summed</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">FILENAME</span> <span class="o">=</span> <span class="n">OBJECTNAME</span><span class="o">.</span><span class="n">name</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument Intensity</span><span class="se">\n</span><span class="s1">(apsum/EXPTIME)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis [Pixel]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">spec_before_wfcali</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">ap_summed</span><span class="p">,</span> <span class="n">ap_std</span><span class="p">],</span>
                          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_pix&#39;</span><span class="p">,</span> <span class="s1">&#39;ap_summed&#39;</span><span class="p">,</span> <span class="s1">&#39;ap_std&#39;</span><span class="p">])</span>


<span class="n">spec_before_wfcali</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="n">OBJECTNAME</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_inst_spec.csv&#39;</span><span class="p">),</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b05692bf109bf118e86eb26eb58e8e167879c4a2a6ef3ff90514d0fec91d6b6b.png" class="align-center" src="../_images/b05692bf109bf118e86eb26eb58e8e167879c4a2a6ef3ff90514d0fec91d6b6b.png" />
</div>
</div>
</section>
</section>
<section id="wavelength-calibration">
<h3>2-2. Wavelength calibration<a class="headerlink" href="#wavelength-calibration" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bring the Master Comparison image</span>
<span class="n">Master_comparison</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;pMaster_Neon.fits&#39;</span>
<span class="n">compimage</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Master_comparison</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">identify</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">compimage</span><span class="p">[</span><span class="mi">90</span><span class="p">:</span><span class="mi">110</span><span class="p">,:],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">compimage</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">x_identify</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">identify</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_identify</span><span class="p">,</span><span class="n">identify</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Piexl number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">identify</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1951361034c547fda741072d4622be79753221a937112873b42bbd0764742777.png" class="align-center" src="../_images/1951361034c547fda741072d4622be79753221a937112873b42bbd0764742777.png" />
<img alt="../_images/18e3b18a9ce895c11a71ba099b0b199b76a023576ad0a2176ad1b64bc67d2969.png" class="align-center" src="../_images/18e3b18a9ce895c11a71ba099b0b199b76a023576ad0a2176ad1b64bc67d2969.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Comparison Lampe line list</span>

<span class="n">LISTFILE</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;neon1.gif&#39;</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">LISTFILE</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="c1">#http://astrosurf.com/buil/us/spe2/hresol4.htm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">c3</span><span class="o">/</span><span class="mi">0</span><span class="n">f663kw90xldstvklyr5nq9c0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_20589</span><span class="o">/</span><span class="mf">2335254067.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">LISTFILE</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;neon1.gif&#39;</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">LISTFILE</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1">#http://astrosurf.com/buil/us/spe2/hresol4.htm</span>

<span class="nn">/opt/anaconda3/envs/main/lib/python3.9/site-packages/IPython/core/display.py</span> in <span class="ni">__init__</span><span class="nt">(self, data, url, filename, format, embed, width, height, retina, unconfined, metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1229</span>         <span class="bp">self</span><span class="o">.</span><span class="n">retina</span> <span class="o">=</span> <span class="n">retina</span>
<span class="g g-Whitespace">   </span><span class="mi">1230</span>         <span class="bp">self</span><span class="o">.</span><span class="n">unconfined</span> <span class="o">=</span> <span class="n">unconfined</span>
<span class="ne">-&gt; </span><span class="mi">1231</span>         <span class="nb">super</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
<span class="g g-Whitespace">   </span><span class="mi">1232</span>                 <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1233</span> 

<span class="nn">/opt/anaconda3/envs/main/lib/python3.9/site-packages/IPython/core/display.py</span> in <span class="ni">__init__</span><span class="nt">(self, data, url, filename, metadata)</span>
<span class="g g-Whitespace">    </span><span class="mi">635</span>             <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
<span class="g g-Whitespace">    </span><span class="mi">636</span> 
<span class="ne">--&gt; </span><span class="mi">637</span>         <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">638</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_check_data</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">639</span><span class="w"> </span>

<span class="nn">/opt/anaconda3/envs/main/lib/python3.9/site-packages/IPython/core/display.py</span> in <span class="ni">reload</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1261</span><span class="w">         </span><span class="sd">&quot;&quot;&quot;Reload the raw data from file or URL.&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1262</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1263</span>             <span class="nb">super</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1264</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1265</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_retina_shape</span><span class="p">()</span>

<span class="nn">/opt/anaconda3/envs/main/lib/python3.9/site-packages/IPython/core/display.py</span> in <span class="ni">reload</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">660</span><span class="w">         </span><span class="sd">&quot;&quot;&quot;Reload the raw data from file or URL.&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">661</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">662</span>             <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_flags</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">663</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">664</span>         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/Users/hbahk/class/ao22/SNU_AO22-2/_test/data/neon1.gif&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the local peak</span>

<span class="n">peak_pix</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">identify</span><span class="p">,</span>
                          <span class="n">num_peaks</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">),</span>
                          <span class="n">min_distance</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                          <span class="n">threshold_abs</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">x_identify</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">identify</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_identify</span><span class="p">,</span> <span class="n">identify</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
            <span class="p">[</span><span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">),</span> <span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.06</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)],</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.06</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Piexl number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel value sum&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2000</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">axins</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
<span class="n">axins</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_identify</span><span class="p">,</span> <span class="n">identify</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peak_pix</span><span class="p">:</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
            <span class="p">[</span><span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.003</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">),</span> <span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)],</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">i</span><span class="p">,</span><span class="n">identify</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">identify</span><span class="p">)),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">rotation</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/170efaa4d817315767537da99cb2374ac7be2cb2c60735b67c1377b098ba69cf.png" class="align-center" src="../_images/170efaa4d817315767537da99cb2374ac7be2cb2c60735b67c1377b098ba69cf.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the matching pair of wavelength and pixel</span>
<span class="n">pixel_init</span><span class="p">,</span> <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                                    <span class="p">[</span><span class="mi">171</span><span class="p">,</span>  <span class="mf">4200.674</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">276</span><span class="p">,</span>  <span class="mf">4657.901</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">301</span><span class="p">,</span>  <span class="mf">4764.865</span><span class="p">],</span>
                                    <span class="c1"># [739,  6677.282],</span>
                                    <span class="p">[</span><span class="mi">550</span><span class="p">,</span>  <span class="mf">5852.488</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">571</span><span class="p">,</span>  <span class="mf">5944.834</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">592</span><span class="p">,</span>  <span class="mf">6029.997</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">617</span><span class="p">,</span>  <span class="mf">6143.063</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">645</span><span class="p">,</span>  <span class="mf">6266.495</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">676</span><span class="p">,</span>  <span class="mf">6402.246</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">700</span><span class="p">,</span>  <span class="mf">6506.528</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">739</span><span class="p">,</span>  <span class="mf">6678.276</span><span class="p">],</span> <span class="c1"># Ne</span>
                                    <span class="p">[</span><span class="mi">756</span><span class="p">,</span>  <span class="mf">6752.834</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">804</span><span class="p">,</span>  <span class="mf">6965.431</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">827</span><span class="p">,</span>  <span class="mf">7067.218</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">874</span><span class="p">,</span>  <span class="mf">7272.936</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">898</span><span class="p">,</span>  <span class="mf">7383.980</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">926</span><span class="p">,</span>  <span class="mf">7503.869</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">955</span><span class="p">,</span>  <span class="mf">7635.106</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">975</span><span class="p">,</span>  <span class="mf">7724.207</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1025</span><span class="p">,</span> <span class="mf">7948.176</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1039</span><span class="p">,</span> <span class="mf">8006.157</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1062</span><span class="p">,</span> <span class="mf">8103.693</span><span class="p">],</span>
                                   <span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="n">ID_init</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pixel_init</span><span class="o">=</span><span class="n">pixel_init</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span> <span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength</span><span class="p">)</span>

<span class="n">ID_init</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">ID_init</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">],</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
<span class="n">popt</span><span class="p">,</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">],</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">],</span><span class="n">linear</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">],</span><span class="o">*</span><span class="n">popt</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">linear</span><span class="p">(</span><span class="mi">550</span><span class="p">,</span><span class="o">*</span><span class="n">popt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5853.743449933852
</pre></div>
</div>
<img alt="../_images/410bbfbe6c4c440430d02116f7366061d876d93e54b2cfc006693cff00f273b6.png" class="align-center" src="../_images/410bbfbe6c4c440430d02116f7366061d876d93e54b2cfc006693cff00f273b6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the each peak with Gaussian 1D function</span>

<span class="n">peak_gauss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">LINE_FITTER</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">FWHM_ID</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">x_identify</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">identify</span><span class="p">))</span>

<span class="c1"># Gaussian fitting for each peak (pixel)</span>
<span class="k">for</span> <span class="n">peak_pix</span> <span class="ow">in</span> <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">]:</span>
    <span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">identify</span><span class="p">[</span><span class="n">peak_pix</span><span class="p">],</span>
                        <span class="n">mean</span> <span class="o">=</span> <span class="n">peak_pix</span><span class="p">,</span>
                        <span class="n">stddev</span> <span class="o">=</span> <span class="n">FWHM_ID</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span><span class="p">,</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amplitude&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">identify</span><span class="p">[</span><span class="n">peak_pix</span><span class="p">]),</span>
                                <span class="s1">&#39;mean&#39;</span><span class="p">:(</span><span class="n">peak_pix</span> <span class="o">-</span> <span class="n">FWHM_ID</span><span class="p">,</span><span class="n">peak_pix</span> <span class="o">+</span> <span class="n">FWHM_ID</span><span class="p">),</span>
                                <span class="s1">&#39;stddev&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="n">FWHM_ID</span><span class="p">)})</span>
    <span class="n">fitted</span> <span class="o">=</span> <span class="n">LINE_FITTER</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span><span class="n">x_identify</span><span class="p">,</span><span class="n">identify</span><span class="p">)</span> <span class="c1">#Model, x, y</span>
    <span class="n">peak_gauss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">peak_pix</span><span class="p">,</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span><span class="n">fitted</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    
<span class="n">peak_gauss</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">peak_gauss</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    
<span class="n">peak_shift</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">peak_gauss</span> <span class="o">-</span> <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;piexl_shift&#39;</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> 
<span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_gauss</span>
<span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_gauss</span> <span class="o">-</span> <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">]</span>
<span class="n">ID_init</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
<span class="n">ID_init</span><span class="o">.</span><span class="n">pprint</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>171 -&gt; 170.56957283749878
276 -&gt; 275.92035369063353
301 -&gt; 300.8979507517763
550 -&gt; 550.2983570133845
571 -&gt; 570.9150212096177
592 -&gt; 593.4469235222318
617 -&gt; 617.20066724794
645 -&gt; 644.9814730829559
645 -&gt; 644.9814730829559
676 -&gt; 675.1637490708239
700 -&gt; 700.2697277340493
739 -&gt; 738.6514955795404
756 -&gt; 755.1372254909968
804 -&gt; 803.8969923950391
827 -&gt; 826.969298371428
874 -&gt; 873.5005033342331
898 -&gt; 898.4810339834836
926 -&gt; 925.9588245798751
955 -&gt; 955.0558910850668
975 -&gt; 975.0952675012696
1025 -&gt; 1025.2927007263313
1039 -&gt; 1039.5376383005416
1062 -&gt; 1061.992030535472
pixel_init wavelength    pixel_gauss          pixel_shift     
---------- ---------- ------------------ ---------------------
       171   4200.674 170.56957283749878   -0.4304271625012177
       276   4657.901 275.92035369063353    -0.079646309366467
       301   4764.865  300.8979507517763  -0.10204924822369321
       550   5852.488  550.2983570133845   0.29835701338447507
       571   5944.834  570.9150212096177  -0.08497879038225165
       592   6029.997  593.4469235222318    1.4469235222318275
       617   6143.063    617.20066724794    0.2006672479400322
       645   6266.495  644.9814730829559 -0.018526917044141555
       645   6266.495  644.9814730829559 -0.018526917044141555
       676   6402.246  675.1637490708239   -0.8362509291761171
       700   6506.528  700.2697277340493    0.2697277340492974
       739   6678.276  738.6514955795404   -0.3485044204595624
       756   6752.834  755.1372254909968   -0.8627745090032022
       804   6965.431  803.8969923950391  -0.10300760496090788
       827   7067.218   826.969298371428 -0.030701628572046502
       874   7272.936  873.5005033342331   -0.4994966657668556
       898    7383.98  898.4810339834836    0.4810339834835986
       926   7503.869  925.9588245798751  -0.04117542012488684
       955   7635.106  955.0558910850668    0.0558910850668326
       975   7724.207  975.0952675012696    0.0952675012696318
      1025   7948.176 1025.2927007263313    0.2927007263313044
      1039   8006.157 1039.5376383005416    0.5376383005416301
      1062   8103.693  1061.992030535472 -0.007969464528059689
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Derive dispersion solution</span>

<span class="n">ORDER_ID</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#Order of fitting function #보통 3 이하로 함. 기기의 사용파장대가 넓으면 4를 사용할때도 있음. </span>
<span class="n">coeff_ID</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">],</span>
                           <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span>
                           <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_ID</span><span class="p">,</span>
                           <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#Derive the dispersion solution</span>

<span class="n">fitRMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitfull</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ID_init</span><span class="p">))</span>
<span class="n">rough_error</span> <span class="o">=</span> <span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]))</span>
               <span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">])))</span><span class="o">/</span><span class="mi">2</span>
<span class="n">residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="c1">#wavelength from reference</span>
            <span class="o">-</span><span class="n">chebval</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">],</span><span class="n">coeff_ID</span><span class="p">))</span> <span class="c1">#wavelength derived from fitting</span>
<span class="n">res_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residual</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">],</span>
         <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span>
         <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">],</span>
          <span class="n">residual</span><span class="p">,</span>
          <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">max_ID_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">])</span>
<span class="n">min_ID_init</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">])</span>
<span class="n">fig_xspan</span> <span class="o">=</span> <span class="n">max_ID_init</span> <span class="o">-</span> <span class="n">min_ID_init</span>
<span class="n">fig_xlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">min_ID_init</span><span class="p">,</span> <span class="n">max_ID_init</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">fig_xspan</span><span class="o">*</span><span class="mf">0.1</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">fig_xlim</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">fig_xlim</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\AA$)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Residual ($\AA$)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel along dispersion axis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;First Identify (Chebyshev order </span><span class="si">{:d}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ORDER_ID</span><span class="p">)</span> 
              <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;RMSE = </span><span class="si">{:.2f}</span><span class="s1"> $\AA$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fitRMS</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/29a8a59cd6ccc56351d850ee6c6f0f5b9ec6d1bc7e12c8531b1c367816a4ccd0.png" class="align-center" src="../_images/29a8a59cd6ccc56351d850ee6c6f0f5b9ec6d1bc7e12c8531b1c367816a4ccd0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">compimage</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f956da2f670&gt;
</pre></div>
</div>
<img alt="../_images/1951361034c547fda741072d4622be79753221a937112873b42bbd0764742777.png" class="align-center" src="../_images/1951361034c547fda741072d4622be79753221a937112873b42bbd0764742777.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># REIDENTIFY </span>

<span class="n">STEP_AP</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#Step size in pixel (dispersion direction)</span>
<span class="n">STEP_REID</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#Step size in pixel (spatial direction)</span>
<span class="n">N_SPATIAL</span><span class="p">,</span><span class="n">N_WAVELEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">compimage</span><span class="p">)</span> <span class="c1">#(220, 2048)</span>
<span class="n">N_REID</span> <span class="o">=</span> <span class="n">N_SPATIAL</span><span class="o">//</span><span class="n">STEP_REID</span> <span class="c1">#Spatial direction </span>
<span class="n">N_AP</span> <span class="o">=</span> <span class="n">N_WAVELEN</span><span class="o">//</span><span class="n">STEP_AP</span> <span class="c1">#Dispersion direction</span>
<span class="n">TOL_REID</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># tolerence to lose a line in pixels</span>

<span class="n">ORDER_WAVELEN_REID</span> <span class="o">=</span> <span class="mi">3</span> 
<span class="n">ORDER_SPATIAL_REID</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">line_REID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_REID</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ID_init</span><span class="p">)))</span> <span class="c1">#Make the empty array (height, width)</span>
<span class="n">spatialcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">N_REID</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">STEP_REID</span><span class="p">,</span><span class="n">STEP_REID</span><span class="p">)</span> <span class="o">+</span> <span class="n">STEP_REID</span><span class="o">/</span><span class="mi">2</span>
<span class="c1"># spatialcoord = array([  5.,  15.,  25.,  35.,  45.,  55.,  65.,  75.,  85.,  95., 105.,</span>
<span class="c1">#       115., 125., 135., 145., 155., 165., 175., 185., 195., 205.])</span>




<span class="c1">#Repeat we did above along the spatial direction</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N_REID</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
    <span class="n">lower_cut</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">STEP_REID</span>
    <span class="n">upper_cut</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">STEP_REID</span>
    <span class="n">reidentify_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">compimage</span><span class="p">[</span><span class="n">lower_cut</span><span class="p">:</span><span class="n">upper_cut</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">peak_gauss_REID</span> <span class="o">=</span> <span class="p">[]</span> 
    
    <span class="k">for</span> <span class="n">peak_pix_init</span> <span class="ow">in</span> <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_gauss&#39;</span><span class="p">]:</span>
        <span class="n">search_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_pix_init</span> <span class="o">-</span> <span class="n">TOL_REID</span><span class="p">))</span>
        <span class="n">search_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">peak_pix_init</span> <span class="o">+</span> <span class="n">TOL_REID</span><span class="p">))</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="n">reidentify_i</span><span class="p">[</span><span class="n">search_min</span><span class="p">:</span><span class="n">search_max</span><span class="p">]</span>
        <span class="n">x_cropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cropped</span><span class="p">))</span> <span class="o">+</span> <span class="n">search_min</span>

        <span class="c1">#Fitting the initial gauss peak by usijng Gausian1D</span>
        <span class="n">Amplitude_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped</span><span class="p">)</span>
        <span class="n">mean_init</span> <span class="o">=</span> <span class="n">peak_pix_init</span>
        <span class="n">stddev_init</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">gaussian_fwhm_to_sigma</span>
        <span class="n">g_init</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span> <span class="o">=</span> <span class="n">Amplitude_init</span><span class="p">,</span>
                           <span class="n">mean</span> <span class="o">=</span> <span class="n">mean_init</span><span class="p">,</span>
                           <span class="n">stddev</span> <span class="o">=</span> <span class="n">stddev_init</span><span class="p">,</span>
                           <span class="n">bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amplitude&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped</span><span class="p">))</span> <span class="p">,</span>
                                 <span class="s1">&#39;stddev&#39;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TOL_REID</span><span class="p">)})</span>
        <span class="n">g_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">g_init</span><span class="p">,</span><span class="n">x_cropped</span><span class="p">,</span><span class="n">cropped</span><span class="p">)</span>
        <span class="n">fit_center</span> <span class="o">=</span> <span class="n">g_fit</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span>    
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fit_center</span> <span class="o">-</span> <span class="n">peak_pix_init</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TOL_REID</span><span class="p">:</span> <span class="c1">#스펙트럼 끝에서는 잘 안 잡힐수있으니까</span>
            <span class="n">peak_gauss_REID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peak_gauss_REID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_center</span><span class="p">)</span>
            
    <span class="n">peak_gauss_REID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_gauss_REID</span><span class="p">)</span>  
    <span class="n">nonan_REID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">peak_gauss_REID</span><span class="p">)</span>
    <span class="n">line_REID</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">peak_gauss_REID</span>  
    <span class="n">peak_gauss_REID_nonan</span> <span class="o">=</span> <span class="n">peak_gauss_REID</span><span class="p">[</span><span class="n">nonan_REID</span><span class="p">]</span> 
    <span class="n">n_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_gauss_REID</span><span class="p">)</span>
    <span class="n">n_found</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">nonan_REID</span><span class="p">)</span>
    <span class="n">coeff_REID1D</span><span class="p">,</span> <span class="n">fitfull</span> <span class="o">=</span> <span class="n">chebfit</span><span class="p">(</span><span class="n">peak_gauss_REID_nonan</span><span class="p">,</span>
                                    <span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">][</span><span class="n">nonan_REID</span><span class="p">],</span> 
                                    <span class="n">deg</span><span class="o">=</span><span class="n">ORDER_WAVELEN_REID</span><span class="p">,</span>
                                    <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fitRMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitfull</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_found</span><span class="p">)</span>
    
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">line_REID</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">spatialcoord</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;pixel_init&#39;</span><span class="p">]))))</span>
<span class="c1">#np.tile(A,reps):Construct an array by repeating A the number of times given by reps.</span>
<span class="c1"># a = np.array([1, 2, 3])</span>
<span class="c1"># b = np.array([2, 3, 4])</span>
<span class="c1"># np.vstack((a,b)) = array([[1, 2, 3],[2, 3, 4]])</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span> <span class="c1"># list of ()  </span>
                   

<span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">N_REID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#Wavelength corresponding to each point</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>  <span class="c1">#</span>
<span class="c1"># errors = np.ones_like(values)</span>


<span class="c1"># #Fitting the wavelength along spatial direction and dispertion direction </span>
<span class="n">coeff_init</span> <span class="o">=</span> <span class="n">Chebyshev2D</span><span class="p">(</span><span class="n">x_degree</span><span class="o">=</span><span class="n">ORDER_WAVELEN_REID</span><span class="p">,</span> <span class="n">y_degree</span><span class="o">=</span><span class="n">ORDER_SPATIAL_REID</span><span class="p">)</span>
<span class="n">fit2D_REID</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">coeff_init</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span> 
<span class="c1">#Dispersion solution (both spatial &amp; dispersion) #fitter(order,x,y,f(x,y))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Plot 2D wavelength callibration map and #Points to used re-identify</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ww</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">N_WAVELEN</span><span class="p">,</span> <span class="p">:</span><span class="n">N_SPATIAL</span><span class="p">]</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fit2D_REID</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">4264.4</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">8108.99</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial </span><span class="se">\n</span><span class="s1"> direction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion direction&#39;</span><span class="p">)</span>
<span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Reidentify and Wavelength Map</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="o">+</span> <span class="s1">&#39;func=Chebyshev, order (wavelength, dispersion) = (</span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1">)&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ORDER_WAVELEN_REID</span><span class="p">,</span> <span class="n">ORDER_SPATIAL_REID</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0.98, &#39;Reidentify and Wavelength Map\nfunc=Chebyshev, order (wavelength, dispersion) = (3, 3)&#39;)
</pre></div>
</div>
<img alt="../_images/7149b5cf40bbc9e91e51666c178dc33663f919ce7bc401f451282873038db19b.png" class="align-center" src="../_images/7149b5cf40bbc9e91e51666c178dc33663f919ce7bc401f451282873038db19b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check how the dispersion solution change along the spatial axis</span>
<span class="c1"># Divide spectrum into 4 equal parts in the spatial direction</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fit2D_REID</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># ax[0].set_xlim(0,2000)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial </span><span class="se">\n</span><span class="s1"> direction&#39;</span><span class="p">)</span>

<span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Reidentify and Wavelength Map</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="o">+</span> <span class="s1">&#39;func=Chebyshev, order (wavelength, dispersion) = (</span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1">) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ORDER_WAVELEN_REID</span><span class="p">,</span> <span class="n">ORDER_SPATIAL_REID</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">vcut</span> <span class="o">=</span> <span class="n">N_WAVELEN</span> <span class="o">*</span> <span class="n">i</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">hcut</span> <span class="o">=</span> <span class="n">N_SPATIAL</span> <span class="o">*</span> <span class="n">i</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">vcutax</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_SPATIAL</span><span class="p">,</span> <span class="n">STEP_REID</span><span class="p">)</span> <span class="o">+</span> <span class="n">STEP_REID</span><span class="o">/</span><span class="mi">2</span> <span class="c1">#Spatial dir coordinate</span>
    <span class="n">hcutax</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_WAVELEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># pixel along dispersion axis</span>
    
    <span class="n">vcutrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">vcut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcutax</span><span class="p">))</span> <span class="c1">#i/4에 해당하는 dispersion pixel * len(spatial)</span>
    <span class="n">hcutrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">hcut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hcutax</span><span class="p">))</span> <span class="c1">#i/4에 해당하는 spatial pixel * len(dispersion)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vcut</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>   
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">hcut</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hcutax</span><span class="p">,</span> <span class="n">fit2D_REID</span><span class="p">(</span><span class="n">hcutax</span><span class="p">,</span> <span class="n">hcutrep</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;horizon cut </span><span class="si">{:d}</span><span class="s2"> pix&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hcut</span><span class="p">)))</span>
<span class="c1"># ax[1].set_xlim(0,2000)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion direction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength </span><span class="se">\n</span><span class="s1">(horizontal cut)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">ID_init</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08cb5b170b4f537295d2d44222b211e5136e739626b9515e9da18c578af2ee73.png" class="align-center" src="../_images/08cb5b170b4f537295d2d44222b211e5136e739626b9515e9da18c578af2ee73.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># title</span>
<span class="n">title_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Reidentify and Wavelength Map</span><span class="se">\n</span><span class="s1">&#39;</span>
             <span class="o">+</span> <span class="s1">&#39;func=Chebyshev, order (wavelength, dispersion) = (</span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ORDER_WAVELEN_REID</span><span class="p">,</span> <span class="n">ORDER_SPATIAL_REID</span><span class="p">))</span>



<span class="n">interp_min</span> <span class="o">=</span> <span class="n">line_REID</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">line_REID</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">interp_max</span> <span class="o">=</span> <span class="n">line_REID</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">line_REID</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fit2D_REID</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">interp_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">interp_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial </span><span class="se">\n</span><span class="s1"> direction&#39;</span><span class="p">)</span>



<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">vcut</span> <span class="o">=</span> <span class="n">N_WAVELEN</span> <span class="o">*</span> <span class="n">i</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">hcut</span> <span class="o">=</span> <span class="n">N_SPATIAL</span> <span class="o">*</span> <span class="n">i</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">vcutax</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_SPATIAL</span><span class="p">,</span> <span class="n">STEP_REID</span><span class="p">)</span> <span class="o">+</span> <span class="n">STEP_REID</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">hcutax</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_WAVELEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vcutrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">vcut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcutax</span><span class="p">))</span>
    <span class="n">hcutrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">hcut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hcutax</span><span class="p">))</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vcut</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>   
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">hcut</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hcutax</span><span class="p">,</span> <span class="n">fit2D_REID</span><span class="p">(</span><span class="n">hcutax</span><span class="p">,</span> <span class="n">hcutrep</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;hcut </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hcut</span><span class="p">)))</span>

    
    <span class="n">vcut_profile</span> <span class="o">=</span> <span class="n">fit2D_REID</span><span class="p">(</span><span class="n">vcutrep</span><span class="p">,</span> <span class="n">vcutax</span><span class="p">)</span>
    <span class="n">vcut_normalize</span> <span class="o">=</span> <span class="n">vcut_profile</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vcut_profile</span><span class="p">)</span>
    
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vcut_normalize</span><span class="p">,</span> <span class="n">vcutax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;vcut </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vcut</span><span class="p">)))</span>



<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">interp_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">interp_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>    
    
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial direction&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion direction [pix]&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength change</span><span class="se">\n</span><span class="s1">(horizontal cut)&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fractional change </span><span class="se">\n</span><span class="s1"> (vertical cut)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_SPATIAL</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_WAVELEN</span><span class="p">)</span>
<span class="c1"># ax2.set_xlim(300, 1700)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_WAVELEN</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="mi">9000</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_SPATIAL</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/aece18a5b6fffe23b602b45868eacfe8482453cc48f62204d13f635a163b7c6c.png" class="align-center" src="../_images/aece18a5b6fffe23b602b45868eacfe8482453cc48f62204d13f635a163b7c6c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Plot the spectrum respect to wavelength</span>

<span class="n">Wavelength</span> <span class="o">=</span> <span class="n">chebval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">compimage</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">coeff_ID</span><span class="p">)</span>

<span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


<span class="n">ObjStdList</span> <span class="o">=</span> <span class="n">Objectlist</span> <span class="o">+</span> <span class="n">Standlist</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ObjStdList</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">OBJECTNAME</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span>
    <span class="n">FILENAME</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="n">FILENAME</span><span class="o">+</span><span class="s1">&#39;_inst_spec.csv&#39;</span><span class="p">))</span>
    <span class="n">ap_summed</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;ap_summed&#39;</span><span class="p">]</span>
    <span class="n">ap_std</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;ap_std&#39;</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Wavelength</span><span class="p">,</span> <span class="n">ap_summed</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Instrument Intensity</span><span class="se">\n</span><span class="s1">(apsum/EXPTIME)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>

    <span class="n">SAVE_FILENAME</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="n">FILENAME</span><span class="o">+</span><span class="s1">&#39;_w_spec.csv&#39;</span><span class="p">)</span>

    <span class="n">Data</span> <span class="o">=</span> <span class="p">[</span><span class="n">Wavelength</span><span class="p">,</span> <span class="n">ap_summed</span><span class="p">,</span> <span class="n">ap_std</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">,</span><span class="s1">&#39;inten&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> 
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> 
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> 

    <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SAVE_FILENAME</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d24375b333d647667e329a32b9c2d70515f47fa033fd59d9514353bbe2fd1554.png" class="align-center" src="../_images/d24375b333d647667e329a32b9c2d70515f47fa033fd59d9514353bbe2fd1554.png" />
<img alt="../_images/9d5c3b6cf7fb6622c076d213d1f765d02219119cad9f7332361c81a269848570.png" class="align-center" src="../_images/9d5c3b6cf7fb6622c076d213d1f765d02219119cad9f7332361c81a269848570.png" />
<img alt="../_images/269dfbb6333fa59bbeb30fc1342af091ccad84ab22d0870b1028e618a3af3da6.png" class="align-center" src="../_images/269dfbb6333fa59bbeb30fc1342af091ccad84ab22d0870b1028e618a3af3da6.png" />
<img alt="../_images/cc70aeab828c894552abb0dc7012b4e8099e557d9371a9dbdfdabe5183217f50.png" class="align-center" src="../_images/cc70aeab828c894552abb0dc7012b4e8099e557d9371a9dbdfdabe5183217f50.png" />
<img alt="../_images/4abffd4e1855ab5473551b89dd5a003bcead62f890e5da088708bd1adf163f77.png" class="align-center" src="../_images/4abffd4e1855ab5473551b89dd5a003bcead62f890e5da088708bd1adf163f77.png" />
<img alt="../_images/fbf547a7d265df9babb20b9dc9ffd7728462f161dcf04679f43cf774e63ac1f2.png" class="align-center" src="../_images/fbf547a7d265df9babb20b9dc9ffd7728462f161dcf04679f43cf774e63ac1f2.png" />
<img alt="../_images/1eaec86422a3e07a372321eba3b260991f2a03fea3b7a0a66fad319f40ea63a0.png" class="align-center" src="../_images/1eaec86422a3e07a372321eba3b260991f2a03fea3b7a0a66fad319f40ea63a0.png" />
<img alt="../_images/35f83c229185eb71966088fc05991a27aaadc28df8cb4095aa73564ca4c57b48.png" class="align-center" src="../_images/35f83c229185eb71966088fc05991a27aaadc28df8cb4095aa73564ca4c57b48.png" />
<img alt="../_images/3f6f20933cdb6a41b4826d1b304bbb0766dbee15bf69fb62d81d3d74365d204e.png" class="align-center" src="../_images/3f6f20933cdb6a41b4826d1b304bbb0766dbee15bf69fb62d81d3d74365d204e.png" />
<img alt="../_images/63bbc872e31643798da23af920c57bf43e7a8ab10f85cfc419901a10f02afa89.png" class="align-center" src="../_images/63bbc872e31643798da23af920c57bf43e7a8ab10f85cfc419901a10f02afa89.png" />
</div>
</div>
</section>
</section>
<section id="flux-calibration">
<h2>3. Flux calibration<a class="headerlink" href="#flux-calibration" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stdfile</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;fhr153.dat&#39;</span>
<span class="n">stddata</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stdfile</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux2&#39;</span><span class="p">])</span>
<span class="n">std_wave</span><span class="p">,</span> <span class="n">std_flux</span>  <span class="o">=</span> <span class="n">stddata</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">],</span> <span class="n">stddata</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e16</span>
<span class="n">std_wth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">std_wave</span><span class="p">)</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="s1">&#39;pHR153-0001_w_spec.csv&#39;</span><span class="p">)</span>
<span class="n">obj_wave</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span>
<span class="n">obj_flux</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;inten&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_wave</span><span class="p">,</span><span class="n">obj_flux</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Extracted spectrum&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_wave</span><span class="p">,</span><span class="n">std_flux</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.4e23</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;erg $s^{-1}cm^{-2}\AA^{-1}$ &#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 

<span class="n">balmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">6563</span><span class="p">,</span> <span class="mi">4861</span><span class="p">,</span> <span class="mi">4341</span><span class="p">,</span> <span class="mi">4100</span><span class="p">,</span> <span class="mi">6867</span><span class="p">,</span> <span class="mf">7593.7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">balmer</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d4e818ade3b1b19afdd2324490a714e2fb952408c9aa36bd3aee47cf6e69c53d.png" class="align-center" src="../_images/d4e818ade3b1b19afdd2324490a714e2fb952408c9aa36bd3aee47cf6e69c53d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj_flux_ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obj_wave_ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">std_flux_ds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">std_wave</span><span class="p">)):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">obj_wave</span> <span class="o">&gt;=</span> <span class="n">std_wave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">std_wth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">obj_wave</span> <span class="o">&lt;</span> <span class="n">std_wave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">std_wth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span> <span class="c1">#STD-wave 범위 안에 들어가는 obj_wave</span>

    <span class="n">IsH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">balmer</span> <span class="o">&gt;=</span> <span class="n">std_wave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">15</span><span class="o">*</span><span class="n">std_wth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">balmer</span> <span class="o">&lt;</span> <span class="n">std_wave</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="n">std_wth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IsH</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="c1"># does this bin contain observed spectra, and no Balmer line?</span>
        <span class="c1"># obj_flux_ds.append(np.sum(obj_flux[rng]) / std_wth[i])</span>
        <span class="n">obj_flux_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obj_flux</span><span class="p">[</span><span class="n">rng</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">obj_wave_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_wave</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">std_flux_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_flux</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
<span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_flux_ds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="o">/</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_flux_ds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
<span class="n">LogSensfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_wave_ds</span><span class="p">,</span><span class="n">LogSensfunc</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4500</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="c1"># ax.set_ylim(-16,-13)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1"> \left( \frac</span><span class="si">{reference}{Observed}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$\\log_{10} \\left( \\frac{reference}{Observed} \\right)$&#39;)
</pre></div>
</div>
<img alt="../_images/2e9f6f655591b001796e27a0a050a36e1583032a912714a9e19845b8893a2673.png" class="align-center" src="../_images/2e9f6f655591b001796e27a0a050a36e1583032a912714a9e19845b8893a2673.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># interpolate back on to observed wavelength grid</span>
<span class="n">spl</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">obj_wave_ds</span><span class="p">,</span> <span class="n">LogSensfunc</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span> <span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">0.0025</span><span class="p">)</span>
<span class="n">sensfunc2</span> <span class="o">=</span> <span class="n">spl</span><span class="p">(</span><span class="n">obj_wave</span><span class="p">)</span>
<span class="c1"># SF_CHEB_DEG = 5</span>
<span class="c1"># sf_coeff = chebfit(obj_wave_ds, LogSensfunc, deg=SF_CHEB_DEG)</span>
<span class="c1"># sensfunc2 = chebval(obj_wave, sf_coeff)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_wave_ds</span><span class="p">,</span><span class="n">LogSensfunc</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_wave</span><span class="p">,</span><span class="n">sensfunc2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4500</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1"> \left( \frac</span><span class="si">{reference}{Observed}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$\\log_{10} \\left( \\frac{reference}{Observed} \\right)$&#39;)
</pre></div>
</div>
<img alt="../_images/9b0122a47049656efc8d4f7c95be5b9f4437e7ae7e5b9acdfde137d8ee0267e7.png" class="align-center" src="../_images/9b0122a47049656efc8d4f7c95be5b9f4437e7ae7e5b9acdfde137d8ee0267e7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sensfunc</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">sensfunc2</span>
<span class="n">obj_cal</span> <span class="o">=</span> <span class="n">obj_flux</span><span class="o">*</span><span class="n">sensfunc</span> <span class="c1">#flux after flux calibration</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obj_wave</span><span class="p">,</span><span class="n">obj_flux</span><span class="o">*</span><span class="n">sensfunc</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After flux calibration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">4e22</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_wave</span><span class="p">,</span><span class="n">std_flux</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;erg $s^{-1}cm^{-2}\AA^{-1}$ &#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">4e22</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.0, 4e+22)
</pre></div>
</div>
<img alt="../_images/2b0efe49e602b4faca86b184a6aa35995ea6f133077e7b110f888a5dd7a1135c.png" class="align-center" src="../_images/2b0efe49e602b4faca86b184a6aa35995ea6f133077e7b110f888a5dd7a1135c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Objectlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tar</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_w_spec.csv&#39;</span><span class="p">))</span>
<span class="n">tar_wave</span> <span class="o">=</span> <span class="n">tar</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span>
<span class="n">tar_flux</span> <span class="o">=</span> <span class="n">tar</span><span class="p">[</span><span class="s1">&#39;inten&#39;</span><span class="p">]</span>
<span class="n">tar_cal</span> <span class="o">=</span> <span class="n">tar_flux</span><span class="o">*</span><span class="n">sensfunc</span> <span class="c1">#flux after flux calibration</span>
<span class="n">tar_std</span> <span class="o">=</span> <span class="n">tar</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sensfunc</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tar_wave</span><span class="p">,</span><span class="n">tar_cal</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="c1"># ax.set_xlim(4000,8000)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After flux calibration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;erg $s^{-1}cm^{-2}\AA^{-1}$ &#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Dispersion axis $[\AA]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1e22</span><span class="p">)</span>

<span class="n">spectrum</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">tar_wave</span><span class="p">,</span> <span class="n">tar_cal</span><span class="p">,</span> <span class="n">tar_std</span><span class="p">],</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">])</span>
<span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> 
<span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3e</span><span class="s2">&quot;</span> 
<span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3e</span><span class="s2">&quot;</span>

<span class="n">SPEC_SAVEPATH</span> <span class="o">=</span> <span class="n">SUBPATH</span><span class="o">/</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s1">&#39;_wf_spec.csv&#39;</span><span class="p">)</span> 
<span class="n">spectrum</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SPEC_SAVEPATH</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4d087d2b13f77adfd64579a2b8a5464edcb767430f7f7d74878fe00bbd0c4b63.png" class="align-center" src="../_images/4d087d2b13f77adfd64579a2b8a5464edcb767430f7f7d74878fe00bbd0c4b63.png" />
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Preprocessing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Preprocessing the CCD images</p>
      </div>
    </a>
    <a class="right-next"
       href="Optical%20Spectroscopy.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Specutils: An Astropy package for spectroscopy</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing-i-e-bias-subtraction-dark-subtraction-flat-fielding">1. Preprocessing  (i.e., Bias subtraction, Dark subtraction, Flat fielding)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-bias">1.1 Making master bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-readout-noise-rn">1.2 Derive Readout Noise (RN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-dark">1.3 Making Master Dark</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#making-master-flat">1.4 Making Master Flat</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-whether-flat-image-is-shifted-or-not">1.4-1 Checking whether Flat image is shifted or not</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-with-the-standard-star-profile">Comparing with the Standard Star Profile</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#median-combine-flat-image-to-make-master-flat">1.4-2 Median combine flat image to make Master Flat</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#master-calibration-image">1.5 Master Calibration image</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-wavelength-calibration-image-shift">Check wavelength Calibration image shift</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#median-combine-comparison-lamp-image">Median combine Comparison Lamp image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bias-subtraction-dark-subtraction-pre-processing">1.6 Bias subtraction &amp; Dark subtraction (Pre-Processing)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spectroscopic-data-reduction">2. Spectroscopic data reduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-the-spectrum">2-1. Extract the Spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#identification-of-objects-peak-set-the-area-of-background">Identification of Object’s peak &amp; Set the area of background</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-tracing-aperture-sum-for-standard-star">Aperture tracing &amp; aperture sum for standard star</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wavelength-calibration">2-2. Wavelength calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-calibration">3. Flux calibration</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Hyeonguk Bahk
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Hyeonguk Bahk.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>